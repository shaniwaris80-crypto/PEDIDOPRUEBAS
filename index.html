<!-- ===========================
PARTE 1/3 â€” ARSLAN LISTAS v3.4 (A+B+C FULL) â€” INDEX ÃšNICO
âœ… Rendimiento + QuickAdd + Auto-asignaciÃ³n + SinÃ³nimos + Control no-vÃ¡lidos
INSTRUCCIÃ“N: pega PARTE 1 + PARTE 2 + PARTE 3 en un SOLO archivo index.html (en ese orden)
=========================== -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS (A+B+C)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff; --shadow:0 2px 8px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6; --border:#1f2937; --panel:#111827; --shadow:0 2px 10px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;color:var(--ink);background:var(--bg);margin:0;
    transition: background .2s ease, color .2s ease;
  }
  h1{font-size:18px;margin:0;color:var(--ink)}
  .topbar{
    position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
    backdrop-filter: saturate(1.2) blur(6px);
  }
  .topbar .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .theme-toggle{border:1px solid var(--border); background:var(--panel); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--bg);box-shadow:var(--shadow);margin-bottom:12px; transition: transform .12s ease}
  .card:active{transform:scale(.998)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border); position:relative; gap:8px; flex-wrap:wrap}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap; align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px; transition: opacity .2s ease, transform .1s ease}
  .btn:active{transform: translateY(1px)}
  .btn.ghost{background:var(--bg);color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:var(--bg);border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px;background:var(--bg);color:var(--ink)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em; position:sticky; top:0; background:var(--bg); z-index:1}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  .pill.sug{border-color:#c7d2fe;background:#eef2ff;color:#3730a3}
  [data-theme="dark"] .pill.ok{border-color:#14532d;background:#052e1a;color:#86efac}
  [data-theme="dark"] .pill.warn{border-color:#7f1d1d;background:#2b0d0d;color:#fecaca}
  [data-theme="dark"] .pill.sug{border-color:#312e81;background:#0b102a;color:#c7d2fe}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  [data-theme="dark"] .ac-item:hover{background:#111827}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:var(--bg);color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  [data-theme="dark"] .ok-assign{background:#052e1a;color:#86efac}
  .dup{background:#fff5f5}
  [data-theme="dark"] .dup{background:#2b0d0d}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}
  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;
  }
  .tabbar button{
    background:var(--bg);border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;
    padding:6px 8px; border-radius:10px; transition: background .15s ease, color .15s ease
  }
  .tabbar button.active{color:var(--kiwi); background:rgba(22,163,74,.08)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}

  .fab{
    position:fixed; right:14px; bottom:72px; z-index:1001;
    width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%); color:#fff; font-size:22px; box-shadow:var(--shadow)
  }
  .fab-menu{
    position:fixed; right:14px; bottom:134px; z-index:1000; display:none; flex-direction:column; gap:8px
  }
  .fab-menu .fab-item{
    border:1px solid var(--border); background:var(--bg); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow)
  }
  .fab-menu.show{display:flex}

  select{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:var(--bg);
    color:var(--ink);
    font-size:14px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}

  .price-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;border:1px solid var(--border);
    background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;border:1px solid var(--border);border-bottom-width:2px;border-radius:8px;
    padding:2px 6px;background:var(--bg);color:var(--ink)
  }
  .qty-tools{display:flex;gap:6px;align-items:center;justify-content:flex-end}
  .qty-btn{
    width:28px;height:28px;border-radius:10px;border:1px solid var(--border);
    background:var(--bg);color:var(--ink);cursor:pointer;font-weight:700
  }
  .qty-btn:active{transform:translateY(1px)}
  .pdf-grid{width:100%; border-collapse:collapse; font-family:'Poppins',sans-serif; font-size:12px;}
  .pdf-grid th,.pdf-grid td{border:1px solid #11182722; padding:6px; vertical-align:top;}
  .pdf-grid th{background:#11182710; text-transform:uppercase; letter-spacing:.04em}

  /* âœ… QuickAdd / Search */
  .input{
    width:100%; border:1px solid var(--border); border-radius:12px; padding:10px;
    background:var(--bg); color:var(--ink); font-size:14px;
  }
  .split{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .split > *{flex:1}
</style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <h1>ğŸˆ ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS (A+B+C)</h1>
      <span class="pill">MÃ³vil optimizado</span>
      <span class="pill">ğŸšš Reparto link: /reparto/</span>
      <span class="price-chip" title="Atajos de cantidades">
        <span class="kbd">+</span><span class="kbd">-</span>
        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
        <span class="kbd">Shift</span>=10
        <span class="kbd">Alt</span>=0,1
        <span class="kbd">Enter</span>=siguiente
      </span>
    </div>
    <div class="toolbar">
      <button class="btn ghost small" onclick="generarLinkRepartidor()">ğŸšš Link Repartidor</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ— Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario (vocab + sinÃ³nimos) â†’ Tiendas/Clientes (Estandarizar) â†’ Global (QuickAdd + Asignar) â†’ Proveedores â†’ Precios â†’ Reparto â†’ PDF/WhatsApp
    </div>

    <!-- TAB: Diccionario -->
    <section class="tab" id="tab-dic">
      <div class="grid-3">
        <div class="card">
          <div class="hd">
            <strong>ğŸ“š Vocabulario estandarizado (editable)</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
              <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
              <button class="btn muted" onclick="limpiarDia()">ğŸ§¹ Limpiar dÃ­a</button>
              <button class="btn muted" onclick="resetAll()">ğŸ’¥ Reset total</button>
            </div>
          </div>
          <div class="bd">
            <div class="hint" style="margin-bottom:6px">
              Un producto por lÃ­nea. Se normaliza a <b>MAYÃšSCULAS</b> sin tildes. Sin duplicados.
            </div>
            <textarea id="vocabTxt"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <strong>ğŸ” SinÃ³nimos / Reglas (A+B+C)</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="saveSynonyms()">Guardar sinÃ³nimos</button>
              <button class="btn muted" onclick="resetSynonyms()">Reset sinÃ³nimos</button>
            </div>
          </div>
          <div class="bd">
            <div class="hint" style="margin-bottom:6px">
              Formato: <b>ORIGEN = DESTINO</b> (uno por lÃ­nea). Se aplica antes de estandarizar y al editar nombres.
              <br>Ej: <b>AVOCADO = AGUACATE</b> Â· <b>CAKI = KAKI</b> Â· <b>GUNDEYA = GUINDILLA</b>
            </div>
            <textarea id="synTxt" style="min-height:180px"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>âš¡ Controles PRO</strong></div>
          <div class="bd">
            <div class="hint" style="margin-bottom:8px">
              âœ… Bloqueo: no permite asignar a proveedor si el producto NO estÃ¡ en vocabulario (para evitar errores).
              <br>âœ… Auto-asignaciÃ³n: recuerda el proveedor usado por producto (historial).
            </div>
            <div class="toolbar">
              <button class="btn muted" onclick="rebuildAllCaches()">â™»ï¸ Rebuild caches</button>
              <span class="pill" id="pillVocabCount">Vocab: 0</span>
              <span class="pill" id="pillSynCount">Syn: 0</span>
              <span class="pill" id="pillHistCount">Hist: 0</span>
            </div>
            <div class="hint" style="margin-top:10px">
              Tip: si algo â€œno autocompletaâ€, guarda vocabulario y pulsa â€œRebuild cachesâ€.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Tiendas -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <div class="card">
          <div class="hd"><strong>ğŸª San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sp')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>ğŸª San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sl')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>ğŸª Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('st')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ¨ Clientes / Hoteles (con TAG)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addClient()">+ Nuevo cliente</button>
            <button class="btn muted" onclick="saveClients()">Guardar clientes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            AÃ±ade pedidos de hoteles/clientes (Braseros, Riviera, etc.). Se suman a Global/Proveedores/Reparto.
          </div>
          <div id="clients_wrap"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Global -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ§® UnificaciÃ³n global (A+B+C)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal(true)">ğŸ”„ Unificar</button>
            <button class="btn muted" onclick="autoAssignCompatible()">ğŸ¤– Auto-asignar compatibles</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">ğŸ“„ TXT Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            âœ… Asignar desaparece al instante.  
            âœ… Bloqueo: si el nombre NO existe en vocabulario, NO se puede asignar (evita errores).  
            âœ… Sugerencia (historial): pill morada con proveedor recomendado.
          </div>

          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
                <span class="pill" id="undoPill">Undo: 0</span>
              </div>
            </div>
          </div>

          <!-- âœ… QuickAdd + Search -->
          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div class="split">
                <div>
                  <div class="hint">âš¡ QuickAdd (ej: <b>tomate rama 3</b> / <b>x150 naranja zumo</b>)</div>
                  <input id="quickAdd" class="input" placeholder="Escribe y Enterâ€¦ (se aÃ±ade al Global)" />
                </div>
                <div>
                  <div class="hint">ğŸ” Buscar en Global</div>
                  <input id="globalSearch" class="input" placeholder="Filtrar productosâ€¦" />
                </div>
              </div>
              <div class="toolbar" style="margin-top:8px">
                <button class="btn small" onclick="quickAddPush()">â• AÃ±adir</button>
                <button class="btn small ghost" onclick="quickAddModeToggle()">ğŸ¯ Modo: <span id="quickModeLabel">GLOBAL</span></button>
                <button class="btn small muted" onclick="undoLast()">â†©ï¸ Deshacer</button>
              </div>
              <div class="hint" style="margin-top:8px">
                Modo GLOBAL: aÃ±ade a Global. Modo PROVEEDOR: aÃ±ade directo al proveedor activo (si existe en vocabulario).
              </div>
            </div>
          </div>

          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Proveedores -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ“¦ DistribuciÃ³n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ’¶ Precios (solo productos comprados/asignados hoy)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="rebuildPricesToday()">ğŸ”„ Refrescar</button>
            <button class="btn small muted" onclick="exportPricesTXT()">ğŸ“„ Export precios TXT</button>
            <button class="btn small muted" onclick="resetPricesConfirm()">ğŸ§½ Reset precios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            âœ… Solo aparecen productos â€œcomprados/asignados hoyâ€.  
            Si NO cambias un precio, NO se toca. Si estÃ¡ vacÃ­o, se ignora.
          </div>
          <div id="prices_wrap" class="scroll-x"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>ğŸšš Reparto (tiendas + clientes)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="marcarTodoReparto(true)">âœ… Todo</button>
            <button class="btn small muted" onclick="marcarTodoReparto(false)">â¬œ Nada</button>
            <button class="btn small" onclick="enviarRepartoWhatsApp()">ğŸ“² WhatsApp</button>
            <button class="btn small muted" onclick="exportarRepartoTXT()">ğŸ“„ TXT</button>
            <button class="btn small muted" onclick="exportarRepartoPDF()">ğŸ§¾ PDF (cuadrÃ­cula)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Selecciona destino. Marca lo repartido y exporta.  
            Los precios se autocompletan si existen en â€œPreciosâ€.
          </div>
          <div style="margin-bottom:8px;">
            <select id="selRepartoTienda" onchange="renderRepartoTienda()"></select>
          </div>
          <div id="reparto_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>
  </div>

  <button class="fab" id="fab" title="Acciones rÃ¡pidas" style="display:none" onclick="toggleFabMenu()">âš™ï¸</button>
  <div class="fab-menu" id="fabMenu">
    <button class="fab-item" onclick="unificarGlobal(true); toggleFabMenu(true)">ğŸ”„ Unificar</button>
    <button class="fab-item" onclick="autoAssignCompatible(); toggleFabMenu(true)">ğŸ¤– Auto-asignar</button>
    <button class="fab-item" onclick="exportarGlobalTXT(); toggleFabMenu(true)">ğŸ“„ TXT visible</button>
    <button class="fab-item" onclick="exportarGlobalXLSX(); toggleFabMenu(true)">ğŸ“Š Excel</button>
    <button class="fab-item" onclick="copiarGlobal(); toggleFabMenu(true)">ğŸ“‹ Copiar</button>
    <button class="fab-item" onclick="exportResumenGlobalTXT(); toggleFabMenu(true)">ğŸ§¾ TXT Global</button>
  </div>

  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">ğŸ“š<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">ğŸª<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">ğŸ§®<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">ğŸ“¦<span>Proveedores</span></button>
  </nav>

<script>
/* ==========================
   Tema (claro/oscuro) con persistencia
========================== */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  localStorage.setItem('arslan_theme', t);
}
function toggleTheme(){
  const cur = localStorage.getItem('arslan_theme') || 'light';
  applyTheme(cur==='light'?'dark':'light');
}

/* ==========================
   Debounce + idle helper
========================== */
function debounce(fn, wait=250){
  let t=null;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), wait);
  };
}
const idle = (cb)=> (window.requestIdleCallback? requestIdleCallback(cb,{timeout:400}): setTimeout(cb, 0));

/* ==========================
   Tabs
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores'];
  ids.forEach(k=>{
    const sec = document.getElementById('tab-'+k);
    const btn = document.getElementById('btn-'+k);
    if(sec) sec.style.display = (k===key)?'block':'none';
    if(btn) btn.classList.toggle('active', k===key);
  });

  const fab = document.getElementById('fab');
  if(fab){
    if(key==='global'){ fab.style.display='block'; } else { fab.style.display='none'; toggleFabMenu(true); }
  }
  closeAC();

  if(key==='tiendas'){ idle(()=>{ renderClientsUI(); buildRepartoSelector(); }); }
  if(key==='global'){ idle(()=>{ buildProvBar(); unificarGlobal(true); }); }
  if(key==='proveedores'){ idle(()=>{ renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); rebuildPricesToday(); }); }
}

/* ==========================
   Config + LS
========================== */
const LS = {
  VOCAB:'arslan_v34_vocab',
  STORES:'arslan_v34_stores',
  ASSIGN:'arslan_v34_assign',
  ORDERS:'arslan_v34_orders',
  CLIENTS:'arslan_v34_clients',
  UNDO:'arslan_v34_undo',
  PRICES:'arslan_v34_prices',
  SYN:'arslan_v34_syn',
  HIST:'arslan_v34_hist'   // historial proveedor por producto
};

const PROVEEDORES = ["ESMO","MONTENEGRO","ÃNGEL VACA","JOSÃ‰ ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kgs','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos','bolsa','bolsas'];
const IGNORE_WORDS_UP = IGNORE_WORDS.map(x=>String(x).toUpperCase());

const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/Ã±/g,'N').replace(/Ã‘/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>t && !IGNORE_WORDS_UP.includes(t));
  return tokens.join(' ').trim();
}
function num(x){
  const n = Number(String(x).replace(',','.'));
  return isNaN(n)? 0 : n;
}
function stepFromEvent(e){
  if(e && e.altKey) return 0.1;
  if(e && e.shiftKey) return 10;
  return 1;
}
function clampQty(v){
  if(!isFinite(v)) return 0;
  if(Math.abs(v) < 1e-9) return 0;
  const s = String(v);
  if(s.includes('.') || s.includes(',')) return Math.round(v*1000)/1000;
  return v;
}

/* ==========================
   âœ… SINÃ“NIMOS (C)
========================== */
let SYN_MAP = {}; // normKey(from) -> TO (raw upper)
const DEFAULT_SYN = `GUNDEYA = GUINDILLA
AVOCADO = AGUACATE
CAKI = KAKI
KAKI = KAKI
MANZANA GRNNY SMITH = MANZANA GRANNY SMITH`;

function parseSynonymsText(txt){
  const map = {};
  toLines(txt).forEach(line=>{
    const s = line.split('#')[0].trim();
    if(!s) return;
    const m = s.split('=');
    if(m.length<2) return;
    const from = removeDiacriticsUpper(m[0]).trim();
    const to = removeDiacriticsUpper(m.slice(1).join('=')) .trim();
    if(!from || !to) return;
    map[normKey(from)] = to;
  });
  // regla fija: GUNDEYA = GUINDILLA
  map[normKey('GUNDEYA')] = 'GUINDILLA';
  return map;
}
function applySynonymsName(name){
  let n = stripGenericWords(name);
  if(!n) return n;
  const k = normKey(n);
  if(SYN_MAP[k]) return SYN_MAP[k];
  return n;
}
function loadSynonyms(){
  const saved = localStorage.getItem(LS.SYN);
  const base = (saved && saved.trim()) ? saved : DEFAULT_SYN;
  const el = byId('synTxt');
  if(el) el.value = base;
  SYN_MAP = parseSynonymsText(base);
  updatePills();
}
function saveSynonyms(){
  const txt = (byId('synTxt')?.value||'').trim();
  localStorage.setItem(LS.SYN, txt);
  SYN_MAP = parseSynonymsText(txt);
  updatePills();
  alert('SinÃ³nimos guardados.');
  // Reprocesa sugerencias y unificaciÃ³n
  idle(()=>{ rebuildAllCaches(); unificarGlobal(true); renderProvidersPanels(); buildRepartoSelector(); });
}
function resetSynonyms(){
  if(!confirm('Â¿Reset sinÃ³nimos a valores por defecto?')) return;
  localStorage.removeItem(LS.SYN);
  loadSynonyms();
  alert('SinÃ³nimos reseteados.');
  idle(()=>{ rebuildAllCaches(); unificarGlobal(true); });
}

/* ==========================
   âœ… VOCAB + CACHES (A)
========================== */
let VOCAB = [];
let VOCAB_KEYS = [];
let PREFIX_INDEX = new Map(); // prefix(2-4) -> array of indices
let VOCAB_SET = new Set();   // normKey -> true

function buildVocabCache(list){
  VOCAB = list.slice();
  VOCAB_KEYS = VOCAB.map(v => normKey(v));
  VOCAB_SET = new Set(VOCAB_KEYS);
  buildPrefixIndex();
  updatePills();
}
function buildPrefixIndex(){
  PREFIX_INDEX = new Map();
  for(let i=0;i<VOCAB_KEYS.length;i++){
    const k = VOCAB_KEYS[i];
    const base = k.replace(/\s+/g,' ').trim();
    if(!base) continue;
    const compact = base.replace(/\s/g,''); // para prefijos rÃ¡pidos
    for(const L of [2,3,4]){
      const p = compact.slice(0,L);
      if(p.length<L) continue;
      if(!PREFIX_INDEX.has(p)) PREFIX_INDEX.set(p, []);
      const arr = PREFIX_INDEX.get(p);
      if(arr.length<60) arr.push(i);
    }
  }
}
function isValidVocab(name){
  const k = normKey(name);
  return VOCAB_SET.has(k);
}
function getVocab(){
  return (VOCAB && VOCAB.length) ? VOCAB : loadVocab();
}

/* ==========================
   VOCAB RAW
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
MANDARINA PLASENCIA
MANDARINA USOPRADES
MANZANA GRNNY SMITH
NARANJA MESA USOPRADES
NARANJA ZUMO USOPRADES
MANZANA STORY
GUAYABA
ROMANESCU
PATATA AGRIA
PATATA MONALISA
PATATA SPUNTA
CEBOLLINO
ENELDO
REMOLACHA
LECHUGA ROBLE
ESCAROLA
GUISANTES
KIWI MARIPOSA
AGUACATE LISO
KIWI ZESPRI GOLD
PARAGUAYO
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
PERA CONFERENCIA PRIMERA BIS
REINETA PARDA
POMELO CHINO
MANDARINA TABALET
BERZA
COL DE BRUSELAS
NUECES SEGUNDA
ESCAROLA
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved = localStorage.getItem(LS.VOCAB);
  const base = (saved && saved.trim()) ? saved : OFFICIAL_VOCAB_RAW;
  const list = uniqueVocab(toLines(base));
  const el = byId('vocabTxt');
  if(el) el.value = list.join('\n');
  buildVocabCache(list);
  return list;
}
function saveVocab(){
  const txt = (byId('vocabTxt')?.value||'');
  localStorage.setItem(LS.VOCAB, txt);
  const list = uniqueVocab(toLines(txt));
  if(byId('vocabTxt')) byId('vocabTxt').value = list.join('\n');
  buildVocabCache(list);
  alert('Vocabulario guardado.');
  idle(()=>{ renderClientsUI(); unificarGlobal(true); renderProvidersPanels(); buildRepartoSelector(); rebuildPricesToday(); });
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por lÃ­nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt')?.value||'');
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt').value = merged.join('\n');
  saveVocab();
}
function rebuildAllCaches(){
  // reparse synonyms + vocab caches
  loadSynonyms();
  const list = uniqueVocab(toLines(byId('vocabTxt')?.value||OFFICIAL_VOCAB_RAW));
  buildVocabCache(list);
  // rebuild client/store rows with synonyms applied (no cambia cantidades)
  reapplySynonymsToAllRows();
  updatePills();
  alert('Caches reconstruidas.');
}
function updatePills(){
  const pv = byId('pillVocabCount'); if(pv) pv.textContent = 'Vocab: ' + (VOCAB?.length||0);
  const ps = byId('pillSynCount'); if(ps) ps.textContent = 'Syn: ' + (Object.keys(SYN_MAP||{}).length||0);
  const ph = byId('pillHistCount'); if(ph) ph.textContent = 'Hist: ' + (Object.keys(histDB||{}).length||0);
}

/* ==========================
   Estado
========================== */
const tiendaState = { sp:[], sl:[], st:[] };
let globalRows = [];
let assignments = {};
let orders = {};
let ACTIVE_PROV = PROVEEDORES[0];
let clients = []; 
let pricesDB = {};
let histDB = {}; // k -> { provLast, hits:{prov:count}, ts }

/* ==========================
   Persistencia
========================== */
const persistState = debounce(function(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.CLIENTS, JSON.stringify(clients));
  localStorage.setItem(LS.PRICES, JSON.stringify(pricesDB));
  localStorage.setItem(LS.HIST, JSON.stringify(histDB));
  updatePills();
}, 250);

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{ assignments = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}') || {}; }catch{ assignments={}; }
  try{ orders = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}') || {}; }catch{ orders={}; }
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });

  try{ clients = JSON.parse(localStorage.getItem(LS.CLIENTS)||'[]'); if(!Array.isArray(clients)) clients=[]; }catch{ clients=[]; }
  try{ pricesDB = JSON.parse(localStorage.getItem(LS.PRICES)||'{}'); if(!pricesDB || typeof pricesDB!=='object') pricesDB={}; }catch{ pricesDB={}; }
  try{ histDB = JSON.parse(localStorage.getItem(LS.HIST)||'{}'); if(!histDB || typeof histDB!=='object') histDB={}; }catch{ histDB={}; }
  updatePills();
}

/* ==========================
   Reset / Limpiar dÃ­a
========================== */
function resetAll(){
  if(!confirm('Â¿Seguro que quieres limpiar TODO (incluye vocabulario)?')) return;
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('arslan_theme');
  location.reload();
}
function limpiarDia(){
  if(!confirm('Â¿Limpiar el dÃ­a? (pone en 0 tiendas, clientes, asignaciones y pedidos. NO borra vocabulario ni precios/historial)')) return;

  tiendaState.sp = []; tiendaState.sl = []; tiendaState.st = [];
  if(byId('in_sp')) byId('in_sp').value = '';
  if(byId('in_sl')) byId('in_sl').value = '';
  if(byId('in_st')) byId('in_st').value = '';
  if(byId('tbl_sp_wrap')) byId('tbl_sp_wrap').innerHTML = '';
  if(byId('tbl_sl_wrap')) byId('tbl_sl_wrap').innerHTML = '';
  if(byId('tbl_st_wrap')) byId('tbl_st_wrap').innerHTML = '';

  clients = clients.map(c=>({ ...c, input:'', rows:[] }));
  assignments = {};
  orders = {};
  PROVEEDORES.forEach(p=>orders[p]=[]);

  for(const k in repartoState){ delete repartoState[k]; }

  persistState();
  alert('DÃ­a limpiado. (Vocabulario, precios e historial intactos)');
  idle(()=>{ unificarGlobal(true); renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); updateUndoPill(); rebuildPricesToday(); });
}

/* ==========================
   Coincidencia aproximada
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser + normalizaciÃ³n con sinÃ³nimos (C)
========================== */
function parseMaybeFraction(s){
  const m = String(s||'').match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
  if(!m) return null;
  const a = Number(m[1]), b = Number(m[2]);
  if(!b) return null;
  return a/b;
}
function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s = s.replace(/^[-â€¢*]\s*/,'');
  let qty=null, name=s;

  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  if(qty===null){
    const mf = s.match(/\b(\d+\s*\/\s*\d+)\b/);
    if(mf){
      const fr = parseMaybeFraction(mf[1]);
      if(fr!==null){ qty=fr; name=s.replace(mf[0],'').trim(); }
    }
  }
  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas|manojo|manojos|saco|sacos|bolsa|bolsas)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }
  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }
  if(qty===null){ qty=1; }

  name = stripGenericWords(name);
  name = applySynonymsName(name);

  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Autocomplete ultra-rÃ¡pido (A)
========================== */
let AC_ACTIVE = null;
let AC_OWNER = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; AC_OWNER=null; } }

document.addEventListener('click', (e)=>{
  if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==AC_OWNER) closeAC();
}, {capture:true});

function pickSuggestionsFast(val){
  const q = applySynonymsName(val);
  const qk = normKey(q);
  if(!qk) return [];
  const compact = qk.replace(/\s/g,'');
  const pref = compact.slice(0, Math.min(4, compact.length));
  let poolIdx = [];
  if(pref.length>=2){
    const key = pref.slice(0, Math.min(4,pref.length));
    for(const L of [4,3,2]){
      const p = key.slice(0,L);
      if(p.length===L && PREFIX_INDEX.has(p)){ poolIdx = PREFIX_INDEX.get(p); break; }
    }
  }
  const suggestions = [];
  const vocab = getVocab();
  if(poolIdx && poolIdx.length){
    for(const i of poolIdx){
      const vk = VOCAB_KEYS[i];
      if(vk.startsWith(qk) || vk.includes(qk)){
        suggestions.push(vocab[i]);
        if(suggestions.length>=8) break;
      }
    }
  }else{
    // fallback (poco comÃºn)
    for(let i=0;i<vocab.length;i++){
      const vk = VOCAB_KEYS[i];
      if(vk.startsWith(qk) || vk.includes(qk)){
        suggestions.push(vocab[i]);
        if(suggestions.length>=8) break;
      }
    }
  }
  if(!suggestions.length){
    const m = bestMatch(q, vocab);
    if(m && m.name) suggestions.push(m.name);
  }
  return suggestions;
}

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;

    const suggestions = pickSuggestionsFast(val);
    if(!suggestions.length) return;

    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';
    suggestions.forEach((s)=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ onPick(s); closeAC(); };
      box.appendChild(item);
    });
    document.body.appendChild(box);
    AC_ACTIVE = box;
    AC_OWNER = cell;
  }, {passive:true});
}

/* ==========================
   Atajos cantidades
========================== */
function bindQtyShortcuts(rootEl, getCellValue, setCellValue, onChanged){
  if(!rootEl) return;
  rootEl.addEventListener('keydown', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    if(!t.isContentEditable) return;

    const f = t.dataset && t.dataset.f;
    if(f!=='q' && f!=='qty' && f!=='total' && f!=='price') return;

    const key = e.key;
    const isPlus = (key==='+' || key==='=');
    const isMinus = (key==='-' || key==='_');
    const isUp = (key==='ArrowUp');
    const isDown = (key==='ArrowDown');
    const isEnter = (key==='Enter');

    if(isPlus || isMinus || isUp || isDown){
      if(f==='price') return; // no tocar price con +- (solo nÃºmeros)
      e.preventDefault();
      const step = stepFromEvent(e);
      const cur = num(getCellValue(t));
      const next = clampQty(cur + ((isMinus || isDown)? -step : step));
      setCellValue(t, next);
      if(typeof onChanged==='function') onChanged(t, next);
      placeCaretAtEnd(t);
      return;
    }

    if(isEnter){
      e.preventDefault();
      focusNextEditableCell(t);
      return;
    }
  }, true);
}
function placeCaretAtEnd(el){
  try{
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch{}
}
function focusNextEditableCell(cur){
  try{
    const tr = cur.closest('tr');
    if(!tr) return;
    const table = tr.closest('table');
    if(!table) return;
    const all = Array.from(table.querySelectorAll('td[contenteditable="true"]'));
    const idx = all.indexOf(cur);
    if(idx>-1 && all[idx+1]){ all[idx+1].focus(); return; }
  }catch{}
}

/* ==========================
   âœ… QuickAdd (B)
========================== */
let QUICK_MODE = 'GLOBAL'; // GLOBAL | PROV
function quickAddModeToggle(){
  QUICK_MODE = (QUICK_MODE==='GLOBAL') ? 'PROV' : 'GLOBAL';
  const el = byId('quickModeLabel');
  if(el) el.textContent = (QUICK_MODE==='GLOBAL') ? 'GLOBAL' : ('PROVEEDOR: ' + ACTIVE_PROV);
}
function quickAddPush(){
  const inp = byId('quickAdd');
  if(!inp) return;
  const raw = (inp.value||'').trim();
  if(!raw) return;
  const p = parseLine(raw);
  if(!p) return;
  const name = applySynonymsName(p.name);
  const qty = p.qty;

  // intenta exact o match
  const vocab = getVocab();
  let finalName = null;
  const exact = vocab.find(v=> normKey(v)===normKey(name));
  if(exact) finalName = exact;
  else{
    const m = bestMatch(name, vocab);
    finalName = (m && m.name) ? m.name : removeDiacriticsUpper(name);
  }

  // bloqueo si no es vÃ¡lido (para modo proveedor, siempre)
  const valid = isValidVocab(finalName);
  if(QUICK_MODE==='PROV'){
    if(!valid){
      alert('âŒ QuickAdd PROVEEDOR bloqueado: el producto NO estÃ¡ en vocabulario. Corrige o aÃ±Ã¡delo al vocabulario.');
      return;
    }
    pushUndo({type:'quickadd_prov', prov:ACTIVE_PROV});
    addLineToProvider(ACTIVE_PROV, finalName, qty);
    inp.value='';
    renderProvidersPanels();
    rebuildPricesToday();
    return;
  }

  // GLOBAL: aÃ±adimos como fila temporal â€œvirtualâ€ dentro de tiendasState (rÃ¡pido) usando un bucket hidden
  pushUndo({type:'quickadd_global'});
  addVirtualGlobalLine(finalName, qty, raw);
  inp.value='';
  unificarGlobal(true);
}
function addVirtualGlobalLine(name, qty, raw){
  // usamos tiendaState.sp como "buffer" invisible? NO: creamos un client especial oculto
  // mejor: guardar en clients con id fijo "cli_quick"
  const id = 'cli_quick';
  let c = clients.find(x=>x.id===id);
  if(!c){
    c = { id, name:'QUICKADD', tag:'', input:'', rows:[] , _hidden:true};
    clients.push(c);
  }
  c.rows = c.rows || [];
  c.rows.push({ o: removeDiacriticsUpper(raw), e: removeDiacriticsUpper(name), q: qty, a: !isValidVocab(name) });
  persistState();
}
function wireQuickInputs(){
  const qa = byId('quickAdd');
  const gs = byId('globalSearch');
  if(qa){
    qa.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); quickAddPush(); }
    });
  }
  if(gs){
    gs.addEventListener('input', debounce(()=>unificarGlobal(true), 120), {passive:true});
  }
}

/* ==========================
   âœ… Reaplicar sinÃ³nimos a todo (C)
========================== */
function reapplySynonymsToAllRows(){
  // tiendas
  ['sp','sl','st'].forEach(code=>{
    (tiendaState[code]||[]).forEach(r=>{
      r.e = removeDiacriticsUpper(applySynonymsName(r.e));
      r.a = !isValidVocab(r.e);
    });
  });
  // clientes
  clients.forEach(c=>{
    (c.rows||[]).forEach(r=>{
      r.e = removeDiacriticsUpper(applySynonymsName(r.e));
      r.a = !isValidVocab(r.e);
    });
  });
  // pedidos
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>{
      it.name = removeDiacriticsUpper(applySynonymsName(it.name));
    });
  });
  // asignaciones: no tocamos keys (pueden cambiar), se recalcula en unificar
  persistState();
}

/* ==========================
   CONTINÃšA EN PARTE 2/3
========================== */
</script>
<!-- ===========================
PARTE 2/3 â€” SCRIPT CONTINÃšA (A+B+C)
=========================== -->
<script>
/* ==========================
   Render tabla tienda
========================== */
function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap');
  const rows = tiendaState[code]||[];
  if(!wrap) return;
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    const bad = r.a || !isValidVocab(r.e);
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${bad? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},+1)">+</button>
        </div>
      </td>
      <td>${bad? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    tiendaState[code][i].q = num(val);
    persistState();
    pushUndo({type:'edit_store_qty', code});
    idle(()=>unificarGlobal(false));
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        const fixed = removeDiacriticsUpper(applySynonymsName(picked));
        cell.innerText = fixed;
        tiendaState[code][i].e = fixed;
        tiendaState[code][i].a = !isValidVocab(fixed);
        cell.classList.toggle('red', tiendaState[code][i].a);
        cell.parentElement.querySelector('td:last-child').innerHTML = tiendaState[code][i].a ? '<span class="pill warn">Revisar</span>' : '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_store', code});
        idle(()=>unificarGlobal(false));
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = (cell.innerText||'').trim();
      if(f==='q'){
        tiendaState[code][i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(applySynonymsName(val));
        tiendaState[code][i].e = cleaned;
        tiendaState[code][i].a = !isValidVocab(cleaned);
      }
      persistState();
      pushUndo({type:'edit_store', code});
      idle(()=>unificarGlobal(false));
    }, {passive:true});
  });
}
function bumpStoreQty(code, idx, delta){
  if(!tiendaState[code] || !tiendaState[code][idx]) return;
  tiendaState[code][idx].q = clampQty(num(tiendaState[code][idx].q) + delta);
  persistState();
  pushUndo({type:'bump_store_qty', code});
  renderTable(code);
  idle(()=>unificarGlobal(false));
}
function estandarizar(code){
  const vocab = getVocab();
  const txt = byId('in_'+code)?.value || '';
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const wanted = applySynonymsName(p.name);
    const exact = vocab.find(v=> normKey(v)===normKey(wanted));
    if(exact){
      rows.push({o:p.original, e:exact, q:p.qty, a:false});
      return;
    }
    const m = bestMatch(wanted, vocab);
    const chosen = (m && m.name) ? m.name : removeDiacriticsUpper(wanted);
    const fixed = removeDiacriticsUpper(applySynonymsName(chosen));
    rows.push({o:p.original, e:fixed, q:p.qty, a:!isValidVocab(fixed)});
  });
  tiendaState[code] = rows;
  renderTable(code);
  persistState();
  pushUndo({type:'estandarizar_store', code});
  idle(()=>{ unificarGlobal(true); buildRepartoSelector(); });
}
function guardarTienda(code){
  const out = (tiendaState[code]||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  if(byId('in_'+code)) byId('in_'+code).value = out;
  alert(`Tienda ${code.toUpperCase()} guardada en el textarea.`);
}
function exportarTiendaTXT(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a && isValidVocab(r.e));
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${code}_estandarizado_${today}.txt`;
  a.click();
}
function enviarTiendaWhatsApp(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a && isValidVocab(r.e));
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const msg = encodeURIComponent(`ğŸ›’ *Pedido ${code.toUpperCase()}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   CLIENTES/HOTELES
========================== */
function genId(){ return 'cli_' + Math.random().toString(16).slice(2) + Date.now().toString(16); }
function addClient(){
  const name = prompt('Nombre cliente/hotel (ej: BRASEROS / RIVIERA / HOTEL CORDON):');
  if(!name) return;
  const tag = prompt('TAG / Sede (ej: CENTRO, FORUM, EDIFICIO, TOMILLARES, SEVERO, GENERAL, TARDE):') || '';
  clients.push({ id: genId(), name: removeDiacriticsUpper(name), tag: removeDiacriticsUpper(tag), input:'', rows:[] });
  persistState();
  renderClientsUI();
}
function saveClients(){
  persistState();
  alert('Clientes guardados.');
  idle(()=>{ unificarGlobal(true); buildRepartoSelector(); });
}
function deleteClient(id){
  if(!confirm('Â¿Eliminar este cliente?')) return;
  clients = clients.filter(c=>c.id!==id);
  persistState();
  renderClientsUI();
  idle(()=>{ unificarGlobal(true); buildRepartoSelector(); });
}
function renderClientsUI(){
  const wrap = byId('clients_wrap');
  if(!wrap) return;

  const visibleClients = clients.filter(c=>c.id!=='cli_quick'); // ocultar quickadd
  if(!visibleClients.length){
    wrap.innerHTML = `<div class="hint">No hay clientes aÃºn. Pulsa â€œ+ Nuevo clienteâ€.</div>`;
    return;
  }

  let html = '';
  visibleClients.forEach((c)=>{
    const label = c.tag ? `${c.name} â€” ${c.tag}` : c.name;
    html += `
      <div class="card" style="margin-bottom:10px">
        <div class="hd">
          <strong>ğŸ¨ ${label}</strong>
          <div class="toolbar">
            <button class="btn small ghost" onclick="estandarizarCliente('${c.id}')">Estandarizar</button>
            <button class="btn small" onclick="guardarCliente('${c.id}')">Guardar</button>
            <button class="btn small muted" onclick="exportarClienteTXT('${c.id}')">TXT</button>
            <button class="btn small muted" onclick="enviarClienteWhatsApp('${c.id}')">WhatsApp</button>
            <button class="btn small muted" onclick="deleteClient('${c.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <div>
              <div class="hint">Nombre</div>
              <input class="input" value="${c.name||''}" onblur="updateClientField('${c.id}','name',this.value)">
            </div>
            <div>
              <div class="hint">TAG</div>
              <input class="input" value="${c.tag||''}" onblur="updateClientField('${c.id}','tag',this.value)">
            </div>
          </div>
          <textarea id="in_${c.id}" placeholder="Pega pedido cliente/hotel...">${c.input||''}</textarea>
          <div class="hint">Edita en tabla igual que tiendas. Cantidades con teclado (+/-/â†‘/â†“).</div>
          <div id="tbl_${c.id}_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    `;
  });

  wrap.innerHTML = html;

  visibleClients.forEach(c=>{
    if(Array.isArray(c.rows) && c.rows.length) renderClientTable(c.id);
  });
}
function updateClientField(id, field, value){
  const idx = clients.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(field==='name') clients[idx].name = removeDiacriticsUpper(value);
  if(field==='tag') clients[idx].tag = removeDiacriticsUpper(value);
  persistState();
  idle(()=>{ buildRepartoSelector(); unificarGlobal(true); });
}
function renderClientTable(id){
  const wrap = byId('tbl_'+id+'_wrap');
  const c = clients.find(x=>x.id===id);
  if(!wrap || !c) return;
  const rows = c.rows||[];
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    const bad = r.a || !isValidVocab(r.e);
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${bad? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpClientQty('${id}',${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpClientQty('${id}',${i},+1)">+</button>
        </div>
      </td>
      <td>${bad? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    c.rows[i].q = num(val);
    persistState();
    pushUndo({type:'edit_client_qty', id});
    idle(()=>unificarGlobal(false));
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        const fixed = removeDiacriticsUpper(applySynonymsName(picked));
        cell.innerText = fixed;
        c.rows[i].e = fixed;
        c.rows[i].a = !isValidVocab(fixed);
        cell.classList.toggle('red', c.rows[i].a);
        cell.parentElement.querySelector('td:last-child').innerHTML = c.rows[i].a ? '<span class="pill warn">Revisar</span>' : '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_client', id});
        idle(()=>unificarGlobal(false));
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = (cell.innerText||'').trim();
      if(f==='q'){
        c.rows[i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(applySynonymsName(val));
        c.rows[i].e = cleaned;
        c.rows[i].a = !isValidVocab(cleaned);
      }
      persistState();
      pushUndo({type:'edit_client', id});
      idle(()=>unificarGlobal(false));
    }, {passive:true});
  });
}
function bumpClientQty(id, idx, delta){
  const c = clients.find(x=>x.id===id);
  if(!c || !c.rows || !c.rows[idx]) return;
  c.rows[idx].q = clampQty(num(c.rows[idx].q) + delta);
  persistState();
  pushUndo({type:'bump_client_qty', id});
  renderClientTable(id);
  idle(()=>unificarGlobal(false));
}
function estandarizarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const txt = byId('in_'+id)?.value || '';
  c.input = txt;
  const vocab = getVocab();
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const wanted = applySynonymsName(p.name);
    const exact = vocab.find(v=> normKey(v)===normKey(wanted));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(wanted, vocab);
    const chosen = (m && m.name) ? m.name : removeDiacriticsUpper(wanted);
    const fixed = removeDiacriticsUpper(applySynonymsName(chosen));
    rows.push({o:p.original, e:fixed, q:p.qty, a:!isValidVocab(fixed)});
  });
  c.rows = rows;
  renderClientTable(id);
  persistState();
  pushUndo({type:'estandarizar_client', id});
  idle(()=>{ unificarGlobal(true); buildRepartoSelector(); });
}
function guardarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const out = (c.rows||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  if(byId('in_'+id)) byId('in_'+id).value = out;
  c.input = out;
  persistState();
  alert('Cliente guardado.');
}
function exportarClienteTXT(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a && isValidVocab(r.e));
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const label = (c.tag? `${c.name}_${c.tag}`:c.name).replace(/\s+/g,'_');
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cliente_${label}_${today}.txt`;
  a.click();
}
function enviarClienteWhatsApp(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a && isValidVocab(r.e));
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const label = c.tag? `${c.name} â€” ${c.tag}`:c.name;
  const msg = encodeURIComponent(`ğŸ¨ *Pedido ${label}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   CONTINÃšA EN PARTE 3/3
========================== */
</script>
<!-- ===========================
PARTE 3/3 â€” RESTO DEL SCRIPT + GLOBAL + PROVEEDORES + PRECIOS + REPARTO + INIT
âœ… FIX: vocab SIEMPRE carga (init robusto)
âœ… FIX: al asignar DESAPARECE instantÃ¡neo (patch DOM + rerender seguro)
=========================== -->
<script>
/* ==========================
   UNDO
========================== */
let undoStack = [];
function loadUndo(){
  try{ undoStack = JSON.parse(localStorage.getItem(LS.UNDO)||'[]') || []; }catch{ undoStack=[]; }
  updateUndoPill();
}
function pushUndo(meta){
  const snap = {
    meta: meta||{},
    ts: Date.now(),
    tiendaState: JSON.parse(JSON.stringify(tiendaState)),
    clients: JSON.parse(JSON.stringify(clients)),
    assignments: JSON.parse(JSON.stringify(assignments)),
    orders: JSON.parse(JSON.stringify(orders)),
    pricesDB: JSON.parse(JSON.stringify(pricesDB)),
    histDB: JSON.parse(JSON.stringify(histDB))
  };
  undoStack.push(snap);
  if(undoStack.length>30) undoStack.shift();
  localStorage.setItem(LS.UNDO, JSON.stringify(undoStack));
  updateUndoPill();
}
function updateUndoPill(){
  const el = byId('undoPill');
  if(el) el.textContent = 'Undo: ' + (undoStack.length||0);
}
function undoLast(){
  if(!undoStack.length){ alert('No hay nada para deshacer.'); return; }
  const snap = undoStack.pop();
  tiendaState.sp = snap.tiendaState.sp||[];
  tiendaState.sl = snap.tiendaState.sl||[];
  tiendaState.st = snap.tiendaState.st||[];
  clients = snap.clients||[];
  assignments = snap.assignments||{};
  orders = snap.orders||{};
  pricesDB = snap.pricesDB || {};
  histDB = snap.histDB || {};
  localStorage.setItem(LS.UNDO, JSON.stringify(undoStack));
  persistState();
  updateUndoPill();
  renderTable('sp'); renderTable('sl'); renderTable('st');
  renderClientsUI();
  unificarGlobal(true);
  renderProvidersPanels();
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}

/* ==========================
   Global unificaciÃ³n
========================== */
function getAllRowsUnified(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const clientRows = [];
  clients.forEach(c=>{
    (c.rows||[]).forEach(r=>clientRows.push(r));
  });
  return all.concat(clientRows);
}

function getHistorySuggestion(name){
  const k = normKey(name);
  const h = histDB[k];
  if(!h) return null;
  if(h.provLast && PROVEEDORES.includes(h.provLast)) return h.provLast;
  return null;
}

function unificarGlobal(full){
  const all = getAllRowsUnified();
  const map = new Map();
  all.forEach(r=>{
    const e = removeDiacriticsUpper(applySynonymsName(r.e));
    const key = normKey(e);
    if(!key) return;
    if(!map.has(key)) map.set(key,{name:e,total:0});
    map.get(key).total += (Number(r.q)||0);
  });

  let arr = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  // search filter
  const q = (byId('globalSearch')?.value||'').trim();
  if(q){
    const qk = normKey(q);
    arr = arr.filter(x=> normKey(x.name).includes(qk));
  }

  // duplicados mejorado (C): vecinos cercanos
  const names = arr.map(x=>x.name);
  const similarSet = new Set();
  for(let i=0;i<names.length;i++){
    for(let j=i+1;j<Math.min(i+18, names.length);j++){
      const s1 = names[i], s2 = names[j];
      const sc = similarityScore(s1, s2);
      if(sc>=0.86 && normKey(s1)!==normKey(s2)){
        similarSet.add(s1); similarSet.add(s2);
      }
    }
  }
  renderGlobalTable(arr, similarSet);
}

/* ==========================
   Render Global + asignaciÃ³n (FIX desaparecer)
========================== */
function renderGlobalTable(rows, similarSet){
  // NO mostrar ya asignados
  const visible = rows.filter(r => !assignments[normKey(r.name)]);
  globalRows = visible;

  const wrap = byId('global_wrap');
  if(!wrap) return;
  if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no hay datos).</div>'; return; }

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Proveedor activo: <b>${ACTIVE_PROV}</b>. âœ… asigna.  
      <span class="pill sug">Sugerencia</span> = historial
    </div>
    <div class="scroll-x"><table>
      <thead><tr><th></th><th>Producto</th><th>Total</th><th>Tools</th><th>Estado</th></tr></thead>
      <tbody>`;

  visible.forEach((r,i)=>{
    const isSimilar = similarSet.has(r.name);
    const valid = isValidVocab(r.name);
    const sug = getHistorySuggestion(r.name);
    const status = !valid ? '<span class="pill warn">No vÃ¡lido</span>' : (isSimilar? '<span class="pill warn">Posible duplicado</span>' : '<span class="pill ok">OK</span>');
    const sugPill = sug ? ` <span class="pill sug" title="Historial">â†’ ${sug}</span>` : '';
    html += `<tr data-i="${i}" class="${isSimilar?'dup':''}">
      <td>
        <button class="ok-assign" onclick="assignFromGlobal(${i})" title="${valid?'Asignar':'Bloqueado: no estÃ¡ en vocabulario'}" style="${valid?'':'opacity:.45;filter:grayscale(1)'}">âœ…</button>
      </td>
      <td contenteditable="true" data-f="name" ${valid?'':'class="red"'}>${r.name}${isSimilar?'<span class="flag">âš ï¸</span>':''}${sugPill}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpGlobalQty(${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpGlobalQty(${i},+1)">+</button>
        </div>
      </td>
      <td>${status}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const tr = cell.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.i);
    if(!isFinite(idx)) return;
    if(cell.dataset.f==='total'){
      globalRows[idx].total = num(val);
      persistState();
      pushUndo({type:'edit_global_total'});
    }
  });

  // ediciÃ³n nombre + autocomplete
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr = cell.parentElement;
    const idx = Number(tr.dataset.i);
    const f = cell.dataset.f;

    if(f==='name'){
      attachAutocomplete(cell, (picked)=>{
        const fixed = removeDiacriticsUpper(applySynonymsName(picked));
        cell.innerText = fixed;
        globalRows[idx].name = fixed;
        const valid = isValidVocab(fixed);
        cell.classList.toggle('red', !valid);
        tr.classList.remove('dup');
        tr.querySelector('td:last-child').innerHTML = valid ? '<span class="pill ok">OK</span>' : '<span class="pill warn">No vÃ¡lido</span>';
      });
    }

    cell.addEventListener('blur', ()=>{
      const val = (cell.innerText||'').trim();
      if(f==='total'){
        globalRows[idx].total = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(applySynonymsName(val));
        globalRows[idx].name = cleaned;

        const valid = isValidVocab(cleaned);
        cell.classList.toggle('red', !valid);

        if(!valid){
          tr.classList.remove('dup');
          tr.querySelector('td:last-child').innerHTML = '<span class="pill warn">No vÃ¡lido</span>';
        }else{
          // recalcula duplicado local
          let dup=false;
          for(let k=0;k<globalRows.length;k++){
            if(k===idx) continue;
            const sc = similarityScore(globalRows[idx].name, globalRows[k].name);
            if(sc>=0.86 && normKey(globalRows[idx].name)!==normKey(globalRows[k].name)){ dup=true; break; }
          }
          if(dup){
            tr.classList.add('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill warn">Posible duplicado</span>';
          }else{
            tr.classList.remove('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
          }
        }
      }
      persistState();
      pushUndo({type:'edit_global'});
    }, {passive:true});
  });
}

function bumpGlobalQty(idx, delta){
  if(!globalRows[idx]) return;
  globalRows[idx].total = clampQty(num(globalRows[idx].total) + delta);

  // âœ… patch DOM rÃ¡pido (A): sin unificar completo
  const wrap = byId('global_wrap');
  const tr = wrap ? wrap.querySelector(`tr[data-i="${idx}"]`) : null;
  if(tr){
    const tdTotal = tr.querySelector('td[data-f="total"]');
    if(tdTotal) tdTotal.innerText = globalRows[idx].total;
  }

  persistState();
  pushUndo({type:'bump_global_qty'});
}

function rememberHistory(name, prov){
  const k = normKey(name);
  if(!k) return;
  histDB[k] = histDB[k] || { provLast:null, hits:{}, ts:0 };
  histDB[k].provLast = prov;
  histDB[k].hits = histDB[k].hits || {};
  histDB[k].hits[prov] = (histDB[k].hits[prov]||0) + 1;
  histDB[k].ts = Date.now();
}

function addLineToProvider(prov, name, qty){
  orders[prov] = orders[prov] || [];
  const k = normKey(name);
  const exIdx = orders[prov].findIndex(x=> normKey(x.name)===k);
  if(exIdx>-1) orders[prov][exIdx].qty += Number(qty)||0;
  else orders[prov].push({name: removeDiacriticsUpper(name), qty:Number(qty)||0});
}

function assignFromGlobal(idx){
  const item = globalRows[idx];
  if(!item) return;

  const fixedName = removeDiacriticsUpper(applySynonymsName(item.name));
  if(!isValidVocab(fixedName)){
    alert('âŒ Bloqueado: este producto NO estÃ¡ en vocabulario. Corrige el nombre o aÃ±Ã¡delo al vocabulario.');
    return;
  }

  pushUndo({type:'assign', idx, name:fixedName, prov:ACTIVE_PROV, qty:item.total});

  const k = normKey(fixedName);
  assignments[k] = ACTIVE_PROV;

  addLineToProvider(ACTIVE_PROV, fixedName, item.total);
  rememberHistory(fixedName, ACTIVE_PROV);

  // âœ… FIX â€œno desapareceâ€: quitar del DOM inmediatamente
  const wrap = byId('global_wrap');
  const tr = wrap ? wrap.querySelector(`tr[data-i="${idx}"]`) : null;
  if(tr){ tr.remove(); }

  persistState();
  renderProvidersPanels();
  rebuildPricesToday();

  // âœ… rerender seguro (por si Ã­ndices cambiaron)
  idle(()=>unificarGlobal(false));
}

/* ==========================
   Barra proveedores
========================== */
function buildProvBar(){
  const bar = byId('provBar');
  if(!bar) return;
  bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'prov-btn' + (p===ACTIVE_PROV?' active':'');
    b.textContent = p;
    b.onclick = ()=>{
      ACTIVE_PROV = p;
      buildProvBar();
      const el = byId('quickModeLabel');
      if(el && QUICK_MODE==='PROV') el.textContent = 'PROVEEDOR: ' + ACTIVE_PROV;
      idle(()=>unificarGlobal(false));
    };
    bar.appendChild(b);
  });
}

/* ==========================
   Auto-asignaciÃ³n compatible (B)
========================== */
function autoAssignCompatible(){
  // asigna todas las filas visibles que tengan hist provLast
  if(!globalRows.length){ alert('No hay lÃ­neas en Global.'); return; }
  pushUndo({type:'auto_assign'});
  let count=0;

  // snapshot de filas actuales (porque globalRows cambia)
  const rows = globalRows.slice();

  rows.forEach((r)=>{
    const name = removeDiacriticsUpper(applySynonymsName(r.name));
    if(!isValidVocab(name)) return;
    const sug = getHistorySuggestion(name);
    if(!sug) return;

    const k = normKey(name);
    if(assignments[k]) return;

    assignments[k] = sug;
    addLineToProvider(sug, name, r.total);
    rememberHistory(name, sug);
    count++;
  });

  persistState();
  renderProvidersPanels();
  rebuildPricesToday();
  unificarGlobal(true);

  alert(`ğŸ¤– Auto-asignado: ${count} lÃ­neas (segÃºn historial).`);
}

/* ==========================
   Paneles proveedores
========================== */
function unassignProviderLine(prov, idx){
  if(!orders[prov] || !orders[prov][idx]) return;
  const it = orders[prov][idx];
  const k = normKey(it.name);

  pushUndo({type:'unassign_line', prov, idx, name:it.name});

  if(assignments[k] === prov) delete assignments[k];
  orders[prov].splice(idx, 1);

  persistState();
  unificarGlobal(true);
  renderProvidersPanels();
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}
function renderProvidersPanels(){
  const cont = byId('provPanels');
  if(!cont) return;
  cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[];
    const card = document.createElement('div');
    card.className='card';
    const hd = document.createElement('div');
    hd.className='hd';
    hd.innerHTML = `<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small" onclick="exportProvTXT('${p}')">ğŸ“„ TXT ${p}</button>
        <button class="btn small muted" onclick="enviarProvWhatsApp('${p}')">ğŸ“² WhatsApp</button>
      </div>`;
    const bd = document.createElement('div');
    bd.className='bd';

    if(!list.length){
      bd.innerHTML = '<div class="hint">Sin productos asignados.</div>';
    }else{
      let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th><th>Tools</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        const valid = isValidVocab(it.name);
        html += `<tr>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="${valid?'green':'red'}">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
          <td>
            <div class="qty-tools">
              <button class="qty-btn" onclick="bumpProvQty('${p}',${ix},-1)">-</button>
              <button class="qty-btn" onclick="bumpProvQty('${p}',${ix},+1)">+</button>
              <button class="qty-btn" title="Devolver a Global" onclick="unassignProviderLine('${p}',${ix})">â†©ï¸</button>
            </div>
          </td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      bd.innerHTML = html;

      bindQtyShortcuts(bd, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(!orders[prov] || !orders[prov][idx]) return;
        if(f==='qty'){
          orders[prov][idx].qty = num(val);
          persistState();
          pushUndo({type:'edit_provider_qty', prov});
          rebuildPricesToday();
        }
      });

      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(f==='name'){
          attachAutocomplete(cell, picked=>{
            const fixed = removeDiacriticsUpper(applySynonymsName(picked));
            if(!isValidVocab(fixed)){
              alert('âŒ Bloqueado: no estÃ¡ en vocabulario. AÃ±Ã¡delo o corrige.');
              cell.innerText = orders[prov][idx].name;
              return;
            }
            cell.innerText = fixed;
            orders[prov][idx].name = fixed;
            persistState();
            pushUndo({type:'edit_provider', prov});
            rebuildPricesToday();
          });
        }
        cell.addEventListener('blur', ()=>{
          const val = (cell.innerText||'').trim();
          if(f==='qty'){
            orders[prov][idx].qty = num(val)||0;
          }else{
            const fixed = removeDiacriticsUpper(applySynonymsName(val));
            if(!isValidVocab(fixed)){
              alert('âŒ Bloqueado: no estÃ¡ en vocabulario.');
              cell.innerText = orders[prov][idx].name;
              return;
            }
            orders[prov][idx].name = fixed;
          }
          persistState();
          pushUndo({type:'edit_provider', prov});
          rebuildPricesToday();
        }, {passive:true});
      });
    }

    card.appendChild(hd); card.appendChild(bd);
    cont.appendChild(card);
  });
}
function bumpProvQty(prov, idx, delta){
  if(!orders[prov] || !orders[prov][idx]) return;
  orders[prov][idx].qty = clampQty(num(orders[prov][idx].qty) + delta);
  persistState();
  pushUndo({type:'bump_provider_qty', prov});
  renderProvidersPanels();
  rebuildPricesToday();
}
function exportProvTXT(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay lÃ­neas para ' + prov); return; }
  const today = new Date().toISOString().split('T')[0];

  const txt = list.map(x=>{
    if(prov==="ESMO") return `${x.qty}${x.name}`;
    return `${x.qty} ${x.name}`;
  }).join('\n');

  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${prov}_${today}.txt`; a.click();
}
function enviarProvWhatsApp(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay lÃ­neas para ' + prov); return; }

  const txt = list.map(x=>{
    const k = normKey(x.name);
    const pr = pricesDB[k] && pricesDB[k].price ? ` â€” ${Number(pricesDB[k].price).toFixed(2)}â‚¬` : '';
    const base = (prov==="ESMO") ? `${x.qty}${x.name}` : `${x.qty} ${x.name}`;
    return `${base}${pr}`;
  }).join('\n');

  const msg = encodeURIComponent(`ğŸ“¦ *Pedido ${prov}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   Export Global
========================== */
function copiarGlobal(){
  if(!globalRows.length) return;
  const txt = globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n');
  navigator.clipboard.writeText(txt);
  alert('Lista global copiada.');
}
function exportarGlobalTXT(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = globalRows.map(r=>`${r.total}\t${r.name}`).join('\n');
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click();
}
function exportarGlobalXLSX(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([['Producto','Total'], ...globalRows.map(r=>[r.name,r.total])]);
  XLSX.utils.book_append_sheet(wb, ws, 'Global');
  XLSX.writeFile(wb, `lista_global_${today}.xlsx`);
}
function exportResumenGlobalTXT(){
  const all = getAllRowsUnified();
  const totalMap = {};
  all.forEach(r=>{
    const e = removeDiacriticsUpper(applySynonymsName(r.e));
    const k = normKey(e);
    if(!k) return;
    if(!totalMap[k]) totalMap[k] = {name:e, total:0};
    totalMap[k].total += (Number(r.q)||0);
  });

  const byProv = {}; PROVEEDORES.forEach(p=>byProv[p]=[]);
  const unassigned = [];
  Object.values(totalMap).forEach(it=>{
    const k = normKey(it.name);
    const prov = assignments[k];
    if(prov && PROVEEDORES.includes(prov)){
      byProv[prov].push({name:it.name, qty:it.total});
    }else{
      unassigned.push({name:it.name, qty:it.total});
    }
  });

  let out = `ğŸ“¦ PEDIDOS POR PROVEEDOR\n\n`;
  PROVEEDORES.forEach(p=>{
    out += `> ${p}:\n`;
    if(byProv[p].length){
      byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es'));
      byProv[p].forEach(x=>{
        if(p==="ESMO") out += `- ${x.qty}${x.name}\n`;
        else out += `- ${x.qty} ${x.name}\n`;
      });
    }else out += `- (sin lÃ­neas)\n`;
    out += `\n`;
  });

  out += `ğŸ“Œ SIN PROVEEDOR ASIGNADO:\n`;
  if(unassigned.length){
    unassigned.sort((a,b)=>a.name.localeCompare(b.name,'es'));
    unassigned.forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
  }else out += `- (sin lÃ­neas)\n`;

  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([out],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`resumen_pedidos_${today}.txt`; a.click();
}

/* ==========================
   Precios (igual que tu flujo)
========================== */
function getBoughtTodaySet(){
  const set = new Map();
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>{
      const k = normKey(it.name);
      if(!k) return;
      if(!set.has(k)) set.set(k, it.name);
    });
  });
  return set;
}
function rebuildPricesToday(){
  const wrap = byId('prices_wrap');
  if(!wrap) return;

  const bought = getBoughtTodaySet();
  if(!bought.size){
    wrap.innerHTML = `<div class="hint">No hay productos comprados/asignados todavÃ­a.</div>`;
    return;
  }

  bought.forEach((name,k)=>{
    if(!pricesDB[k]) pricesDB[k] = { name:name, price:'', updatedAt:0 };
    else pricesDB[k].name = pricesDB[k].name || name;
  });

  const rows = Array.from(bought.entries()).map(([k,name])=>{
    const rec = pricesDB[k] || {name, price:'', updatedAt:0};
    return { k, name: rec.name || name, price: rec.price || '', updatedAt: rec.updatedAt || 0 };
  }).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  let html = `<div class="scroll-x"><table>
    <thead><tr><th>Producto</th><th>Precio (â‚¬)</th><th>Ãšltima actualizaciÃ³n</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const dt = r.updatedAt ? new Date(r.updatedAt) : null;
    const stamp = dt ? dt.toLocaleString() : '';
    html += `<tr>
      <td class="green">${r.name}</td>
      <td contenteditable="true" data-pricekey="${r.k}" data-f="price">${r.price}</td>
      <td class="hint">${stamp}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); focusNextEditableCell(cell); }});
    cell.addEventListener('blur', ()=>{
      const k = cell.dataset.pricekey;
      const raw = (cell.innerText||'').trim();
      if(!k) return;

      if(raw===''){ cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : ''; return; }
      const n = parseFloat(String(raw).replace(',','.'));
      if(isNaN(n)){ cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : ''; return; }
      const val = n.toFixed(2);

      pricesDB[k] = pricesDB[k] || { name:'', price:'', updatedAt:0 };
      pricesDB[k].price = val;
      pricesDB[k].updatedAt = Date.now();
      persistState();
      idle(()=>renderRepartoTienda());
    }, {passive:true});
  });

  persistState();
}
function exportPricesTXT(){
  const bought = getBoughtTodaySet();
  if(!bought.size){ alert('No hay productos comprados/asignados hoy.'); return; }
  const rows = [];
  bought.forEach((name,k)=>{
    const rec = pricesDB[k];
    if(rec && rec.price) rows.push(`${rec.name || name}\t${rec.price}â‚¬`);
  });
  if(!rows.length){ alert('No hay precios guardados para los productos de hoy.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([rows.join('\n')],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`precios_${today}.txt`; a.click();
}
function resetPricesConfirm(){
  if(!confirm('Â¿Resetear TODOS los precios guardados? (No afecta pedidos ni vocabulario)')) return;
  pricesDB = {};
  persistState();
  rebuildPricesToday();
  alert('Precios reseteados.');
}

/* ==========================
   Reparto (igual que tu lÃ³gica)
========================== */
const repartoState = {};
function keyLine(name){ return normKey(name); }

function getRepartoDestinations(){
  const dests = [];
  dests.push({ key:'sp', label:'ğŸª San Pablo', type:'store' });
  dests.push({ key:'sl', label:'ğŸª San Lesmes', type:'store' });
  dests.push({ key:'st', label:'ğŸª Santiago', type:'store' });

  clients.filter(c=>c.id!=='cli_quick').forEach(c=>{
    const has = (c.rows||[]).some(x=>Number(x.q)>0);
    if(!has) return;
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    dests.push({ key:c.id, label, type:'client' });
  });
  return dests;
}
function buildRepartoSelector(){
  const sel = byId('selRepartoTienda');
  if(!sel) return;
  const dests = getRepartoDestinations();
  const current = sel.value;
  sel.innerHTML = `<option value="">Selecciona destino...</option>` + dests.map(d=>`<option value="${d.key}">${d.label}</option>`).join('');
  if(current && dests.some(d=>d.key===current)) sel.value = current;
}
function marcarTodoReparto(checked){
  const sel = byId('selRepartoTienda');
  const code = sel ? sel.value : '';
  if(!code){ alert('Selecciona un destino primero.'); return; }
  if(!repartoState[code]) renderRepartoTienda();
  if(!repartoState[code]) return;
  Object.keys(repartoState[code]).forEach(k=>{ repartoState[code][k].checked = !!checked; });
  renderRepartoTienda();
}
function renderRepartoTienda(){
  const sel = byId('selRepartoTienda');
  const code = sel ? sel.value : '';
  const wrap = byId('reparto_wrap');
  if(!wrap) return;

  if(!code){ wrap.innerHTML = '<div class="hint">Selecciona un destino para ver su lista.</div>'; return; }

  let lista = [];
  const isClient = clients.some(c=>c.id===code);
  if(isClient){
    const c = clients.find(x=>x.id===code);
    lista = (c && c.rows) ? c.rows : [];
  }else{
    lista = tiendaState[code] || [];
  }
  if(!lista.length){ wrap.innerHTML = '<div class="hint">Sin datos en este destino.</div>'; return; }

  const prev = repartoState[code] || {};
  const next = {};

  lista.forEach(x=>{
    const name = removeDiacriticsUpper(applySynonymsName(x.e));
    const k = keyLine(name);
    if(!k) return;
    const old = prev[k] || { name:name, qty:x.q, price:'', checked:false };
    let price = old.price;
    const pr = pricesDB[k] && pricesDB[k].price ? pricesDB[k].price : '';
    if(!price && pr) price = pr;

    next[k] = { name, qty:x.q, price: price || '', checked: !!old.checked };
  });

  repartoState[code] = next;
  const arr = Object.values(next).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  let totalImporte = 0;
  arr.forEach(r=>{
    const p = parseFloat(String(r.price||'').replace(',','.'));
    if(!isNaN(p) && r.checked) totalImporte += (num(r.qty) * p);
  });

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Seleccionados con precio: <b>${totalImporte ? totalImporte.toFixed(2)+'â‚¬' : '0.00â‚¬'}</b>
    </div>
    <table>
      <thead><tr><th></th><th>Producto</th><th>Cantidad</th><th>Tools</th><th>Precio (â‚¬)</th></tr></thead><tbody>`;

  arr.forEach((r)=>{
    const rowKey = keyLine(r.name);
    html += `<tr>
      <td><input type="checkbox" ${r.checked?'checked':''} onchange="toggleRepartoItem('${code}', '${rowKey}', this.checked)"></td>
      <td>${r.name}</td>
      <td class="green">${r.qty}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpRepartoQty('${code}','${rowKey}',-1)">-</button>
          <button class="qty-btn" onclick="bumpRepartoQty('${code}','${rowKey}',+1)">+</button>
        </div>
      </td>
      <td contenteditable="true" data-f="price" data-rk="${rowKey}" onblur="updateRepartoPrice('${code}', '${rowKey}', this.innerText)">${r.price||''}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); focusNextEditableCell(cell); }});
  });
}
function toggleRepartoItem(code, rowKey, checked){
  if(!repartoState[code] || !repartoState[code][rowKey]) return;
  repartoState[code][rowKey].checked = checked;
  renderRepartoTienda();
}
function updateRepartoPrice(code, rowKey, val){
  if(!repartoState[code] || !repartoState[code][rowKey]) return;
  const raw = String(val||'').trim();
  if(raw===''){ repartoState[code][rowKey].price = ''; renderRepartoTienda(); return; }
  const n = parseFloat(raw.replace(',','.'));
  if(isNaN(n)){ renderRepartoTienda(); return; }
  const fixed = n.toFixed(2);
  repartoState[code][rowKey].price = fixed;

  const name = repartoState[code][rowKey].name;
  const k = normKey(name);
  pricesDB[k] = pricesDB[k] || { name:name, price:'', updatedAt:0 };
  pricesDB[k].name = pricesDB[k].name || name;
  pricesDB[k].price = fixed;
  pricesDB[k].updatedAt = Date.now();

  persistState();
  rebuildPricesToday();
  renderRepartoTienda();
}
function bumpRepartoQty(code, rowKey, delta){
  if(!repartoState[code] || !repartoState[code][rowKey]) return;
  const name = repartoState[code][rowKey].name;
  const nk = normKey(name);

  const c = clients.find(x=>x.id===code);
  if(c){
    const idx = (c.rows||[]).findIndex(r=>normKey(r.e)===nk);
    if(idx>-1){
      c.rows[idx].q = clampQty(num(c.rows[idx].q) + delta);
      persistState();
      pushUndo({type:'bump_reparto_client_qty', code});
      renderClientTable(code);
      renderRepartoTienda();
      idle(()=>unificarGlobal(false));
      return;
    }
  }
  if(code==='sp' || code==='sl' || code==='st'){
    const idx = (tiendaState[code]||[]).findIndex(r=>normKey(r.e)===nk);
    if(idx>-1){
      tiendaState[code][idx].q = clampQty(num(tiendaState[code][idx].q) + delta);
      persistState();
      pushUndo({type:'bump_reparto_store_qty', code});
      renderTable(code);
      renderRepartoTienda();
      idle(()=>unificarGlobal(false));
      return;
    }
  }
}
function exportarRepartoTXT(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  const txt = seleccionados
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x => `${x.qty} ${x.name}${x.price ? ' â€” ' + x.price + 'â‚¬' : ''}`).join('\n');

  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `reparto_${code}_${today}.txt`;
  a.click();
}
function enviarRepartoWhatsApp(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  let total = 0;
  seleccionados.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  let msg = `ğŸšš *Reparto ${code.toUpperCase()}*\n\n`;
  seleccionados.sort((a,b)=>a.name.localeCompare(b.name,'es')).forEach(x=>{
    msg += `- ${x.qty} ${x.name}`;
    if(x.price) msg += ` â€” ${x.price}â‚¬`;
    msg += '\n';
  });
  if(total>0) msg += `\n*TOTAL:* ${total.toFixed(2)}â‚¬`;

  msg = encodeURIComponent(msg);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}
function exportarRepartoPDF(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  const dt = new Date();
  const dateStr = dt.toLocaleDateString();
  const timeStr = dt.toLocaleTimeString();

  let total = 0;
  seleccionados.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  const rowsHTML = seleccionados
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x=>{
      const p = x.price ? Number(x.price).toFixed(2) : '';
      const imp = x.price ? (num(x.qty)*Number(x.price)).toFixed(2) : '';
      return `<tr>
        <td>${escapeHTML(x.name)}</td>
        <td style="text-align:right">${escapeHTML(x.qty)}</td>
        <td style="text-align:right">${p?escapeHTML(p):''}</td>
        <td style="text-align:right">${imp?escapeHTML(imp):''}</td>
      </tr>`;
    }).join('');

  const w = window.open('', '_blank');
  if(!w){ alert('Bloqueado por el navegador. Permite popups.'); return; }

  w.document.open();
  w.document.write(`
    <!doctype html>
    <html lang="es">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Reparto ${escapeHTML(code.toUpperCase())}</title>
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
      <style>
        body{font-family:Poppins,system-ui,Arial;margin:24px;color:#111827}
        h1{font-size:18px;margin:0 0 6px}
        .meta{font-size:12px;color:#6b7280;margin-bottom:14px}
        .grid{width:100%;border-collapse:collapse;font-size:12px}
        .grid th,.grid td{border:1px solid #11182722;padding:6px;vertical-align:top}
        .grid th{background:#11182710;text-transform:uppercase;letter-spacing:.04em}
        .tot{margin-top:10px;font-size:12px}
        @media print{ .noPrint{display:none} }
        .noPrint{margin-bottom:12px}
        button{padding:8px 12px;border:1px solid #11182722;border-radius:10px;background:#fff;cursor:pointer}
      </style>
    </head>
    <body>
      <div class="noPrint">
        <button onclick="window.print()">ğŸ§¾ Imprimir / Guardar como PDF</button>
      </div>
      <h1>ğŸšš Reparto ${escapeHTML(code.toUpperCase())}</h1>
      <div class="meta">${escapeHTML(dateStr)} â€” ${escapeHTML(timeStr)}</div>

      <table class="grid">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Precio</th>
            <th style="text-align:right">Importe</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHTML}
        </tbody>
      </table>

      <div class="tot"><b>TOTAL:</b> ${total.toFixed(2)}â‚¬</div>
    </body>
    </html>
  `);
  w.document.close();
}
function escapeHTML(str){
  return String(str||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* ==========================
   FAB
========================== */
function toggleFabMenu(forceHide){
  const m = byId('fabMenu');
  if(!m) return;
  if(forceHide){ m.classList.remove('show'); return; }
  m.classList.toggle('show');
}
document.addEventListener('click', (e)=>{
  const m = byId('fabMenu'), f = byId('fab');
  if(m && f && !m.contains(e.target) && e.target!==f) m.classList.remove('show');
}, {capture:true});

/* ==========================
   Link repartidor
========================== */
function buildRepartoPayloadForLink(){
  const dateISO = new Date().toISOString().split('T')[0];
  const destinations = [];

  function pushStore(code, label){
    const list = (tiendaState[code]||[]).filter(x=>Number(x.q)>0);
    if(!list.length) return;
    destinations.push({
      id: `STORE_${code.toUpperCase()}`,
      label,
      lines: list.map((x,ix)=>({ id:`${code}_${ix}`, name:x.e, qty:x.q }))
    });
  }
  pushStore('sp','ğŸª San Pablo');
  pushStore('sl','ğŸª San Lesmes');
  pushStore('st','ğŸª Santiago');

  clients.filter(c=>c.id!=='cli_quick').forEach(c=>{
    const rows = (c.rows||[]).filter(x=>Number(x.q)>0);
    if(!rows.length) return;
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    destinations.push({
      id: `CLIENT_${c.id.toUpperCase()}`,
      label,
      lines: rows.map((x,ix)=>({ id:`${c.id}_${ix}`, name:x.e, qty:x.q }))
    });
  });

  return { dateISO, title:"REPARTO", destinations };
}
function generarLinkRepartidor(){
  const payload = buildRepartoPayloadForLink();
  if(!payload.destinations.length){
    alert('No hay pedidos hoy (sin destinos).');
    return;
  }
  const json = JSON.stringify(payload);
  const packed = LZString.compressToEncodedURIComponent(json);

  const baseURL = "https://shaniwaris80-crypto.github.io/reparto/";
  const url = `${baseURL}?data=${packed}`;

  navigator.clipboard?.writeText(url);
  window.open(url, '_blank');
  alert('Link Repartidor generado y copiado. PÃ©galo en WhatsApp al repartidor.');
}

/* ==========================
   INIT robusto (FIX vocab no carga)
========================== */
(function init(){
  try{
    const savedTheme = localStorage.getItem('arslan_theme') || (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);
  }catch{}

  // âš ï¸ Orden robusto:
  // 1) cargar syn
  // 2) cargar state
  // 3) cargar vocab (y caches)
  // Esto evita que cualquier fallo en DOM rompa el vocab.
  try{ loadSynonyms(); }catch(e){ console.error('syn err', e); }
  try{ loadState(); }catch(e){ console.error('state err', e); }
  try{ loadVocab(); }catch(e){ console.error('vocab err', e); }

  try{ loadUndo(); }catch(e){ console.error('undo err', e); }
  try{ wireQuickInputs(); }catch(e){ console.error('quick err', e); }

  // render inicial
  try{ showTab('dic'); }catch{}

  idle(()=>{
    try{ buildProvBar(); }catch{}
    try{ renderProvidersPanels(); }catch{}
    try{ renderClientsUI(); }catch{}
    try{ buildRepartoSelector(); }catch{}
    try{ rebuildPricesToday(); }catch{}
    try{ unificarGlobal(true); }catch{}
    try{ updatePills(); }catch{}
  });
})();
</script>

</body>
</html>
