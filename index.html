<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- âœ… Para generar LINK Repartidor comprimido + LINK Precios -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff; --shadow:0 2px 8px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6; --border:#1f2937; --panel:#111827; --shadow:0 2px 10px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;color:var(--ink);background:var(--bg);margin:0;
    transition: background .2s ease, color .2s ease;
  }
  h1{font-size:18px;margin:0;color:var(--ink)}
  .topbar{
    position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
    backdrop-filter: saturate(1.2) blur(6px);
  }
  .topbar .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .theme-toggle{border:1px solid var(--border); background:var(--panel); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--bg);box-shadow:var(--shadow);margin-bottom:12px; transition: transform .12s ease}
  .card:active{transform:scale(.998)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border); position:relative; gap:8px; flex-wrap:wrap}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px; transition: opacity .2s ease, transform .1s ease}
  .btn:active{transform: translateY(1px)}
  .btn.ghost{background:var(--bg);color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:var(--bg);border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px;background:var(--bg);color:var(--ink)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em; position:sticky; top:0; background:var(--bg); z-index:1}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  [data-theme="dark"] .pill.ok{border-color:#14532d;background:#052e1a;color:#86efac}
  [data-theme="dark"] .pill.warn{border-color:#7f1d1d;background:#2b0d0d;color:#fecaca}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  [data-theme="dark"] .ac-item:hover{background:#111827}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:var(--bg);color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  [data-theme="dark"] .ok-assign{background:#052e1a;color:#86efac}
  .dup{background:#fff5f5}
  [data-theme="dark"] .dup{background:#2b0d0d}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}
  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;
  }
  .tabbar button{
    background:var(--bg);border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;
    padding:6px 8px; border-radius:10px; transition: background .15s ease, color .15s ease
  }
  .tabbar button.active{color:var(--kiwi); background:rgba(22,163,74,.08)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}

  .fab{
    position:fixed; right:14px; bottom:72px; z-index:1001;
    width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%); color:#fff; font-size:22px; box-shadow:var(--shadow)
  }
  .fab-menu{
    position:fixed; right:14px; bottom:134px; z-index:1000; display:none; flex-direction:column; gap:8px
  }
  .fab-menu .fab-item{
    border:1px solid var(--border); background:var(--bg); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow)
  }
  .fab-menu.show{display:flex}

  /* select bonito */
  select{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:var(--bg);
    color:var(--ink);
    font-size:14px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}

  /* âœ… ayudas de teclado + precios + pdf grid */
  .price-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;border:1px solid var(--border);
    background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;border:1px solid var(--border);border-bottom-width:2px;border-radius:8px;
    padding:2px 6px;background:var(--bg);color:var(--ink)
  }
  .qty-tools{display:flex;gap:6px;align-items:center;justify-content:flex-end}
  .qty-btn{
    width:28px;height:28px;border-radius:10px;border:1px solid var(--border);
    background:var(--bg);color:var(--ink);cursor:pointer;font-weight:700
  }
  .qty-btn:active{transform:translateY(1px)}
  .pdf-grid{
    width:100%; border-collapse:collapse;
    font-family:'Poppins',sans-serif; font-size:12px;
  }
  .pdf-grid th,.pdf-grid td{
    border:1px solid #11182722; padding:6px; vertical-align:top;
  }
  .pdf-grid th{background:#11182710; text-transform:uppercase; letter-spacing:.04em}
</style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <h1>ğŸˆ ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</h1>
      <span class="pill">Modo mÃ³vil optimizado</span>
      <span class="pill">ğŸšš Reparto link: /reparto/</span>
      <span class="price-chip" title="Atajos de cantidades">
        <span class="kbd">+</span><span class="kbd">-</span>
        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
        <span class="kbd">Shift</span>=10
        <span class="kbd">Alt</span>=0,1
      </span>
    </div>
    <div class="toolbar">
      <button class="btn ghost small" onclick="generarLinkRepartidor()">ğŸšš Link Repartidor</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ— Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario â†’ Tiendas/Clientes (Estandarizar) â†’ Global (Unificar/Asignar) â†’ Proveedores (TXT/Precios) â†’ Reparto (clic) â†’ PDF/WhatsApp
    </div>

    <!-- TAB: Diccionario -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>ğŸ“š Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="limpiarDia()">ğŸ§¹ Limpiar dÃ­a</button>
            <button class="btn muted" onclick="resetAll()">ğŸ’¥ Reset total</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">
            Un producto por lÃ­nea. Se normaliza a <b>MAYÃšSCULAS</b> sin tildes. Sin duplicados.
          </div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>
    </section>

    <!-- TAB: Tiendas -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sp')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sl')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>ğŸª Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('st')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- âœ… CLIENTES/HOTELES -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ¨ Clientes / Hoteles (con TAG)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addClient()">+ Nuevo cliente</button>
            <button class="btn muted" onclick="saveClients()">Guardar clientes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            AÃ±ade pedidos de hoteles/clientes (Braseros Centro/Forum/Edificio/Tomillares/Severo, Riviera, etc.).  
            âœ… Solo cuentan si tienen lÃ­neas. Se suman a Global/Proveedores/Reparto.
          </div>
          <div id="clients_wrap"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Global -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ§® UnificaciÃ³n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar todo</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">ğŸ“„ TXT Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            âœ… a la izquierda asigna al proveedor activo. Duplicados probables se <span class="red">marcan en rojo</span> y fila rosada (<b>âš ï¸</b>).
            Cantidades con teclado (+/-/â†‘/â†“). Enter baja a la siguiente fila.
          </div>

          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn ghost small" onclick="undoLast()">â†©ï¸ Deshacer</button>
            <span class="pill" id="undoPill">Undo: 0</span>
          </div>

          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Proveedores -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ“¦ DistribuciÃ³n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- âœ… PRECIOS (SOLO COMPRADO/ASIGNADO) + LINK EXTERNO -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ’¶ Precios (solo productos comprados/asignados hoy)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="rebuildPricesToday()">ğŸ”„ Refrescar</button>
            <button class="btn small" onclick="generarLinkPrecios()">ğŸ”— Link precios externo</button>
            <button class="btn small muted" onclick="exportPricesTXT()">ğŸ“„ Export precios TXT</button>
            <button class="btn small muted" onclick="resetPricesConfirm()">ğŸ§½ Reset precios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            âœ… Solo aparecen productos de pedidos por proveedor (lo â€œcompradoâ€) + los no asignados en Global.  
            Si NO cambias un precio, NO se toca. Si estÃ¡ vacÃ­o, se ignora.
          </div>
          <div id="prices_wrap" class="scroll-x"></div>
        </div>
      </div>

      <!-- REPARTO -->
      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>ğŸšš Reparto (tiendas + clientes)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="marcarTodoReparto(true)">âœ… Todo</button>
            <button class="btn small muted" onclick="marcarTodoReparto(false)">â¬œ Nada</button>
            <button class="btn small" onclick="enviarRepartoWhatsApp()">ğŸ“² WhatsApp</button>
            <button class="btn small muted" onclick="exportarRepartoTXT()">ğŸ“„ TXT</button>
            <button class="btn small muted" onclick="exportarRepartoPDF()">ğŸ§¾ PDF (cuadrÃ­cula)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Selecciona destino (tienda o cliente con pedido). Marca lo repartido y exporta.  
            Los precios se autocompletan si existen en â€œPreciosâ€.
          </div>
          <div style="margin-bottom:8px;">
            <select id="selRepartoTienda" onchange="renderRepartoTienda()"></select>
          </div>
          <div id="reparto_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- FAB Global -->
  <button class="fab" id="fab" title="Acciones rÃ¡pidas" style="display:none" onclick="toggleFabMenu()">âš™ï¸</button>
  <div class="fab-menu" id="fabMenu">
    <button class="fab-item" onclick="unificarGlobal(); toggleFabMenu(true)">ğŸ”„ Unificar</button>
    <button class="fab-item" onclick="exportarGlobalTXT(); toggleFabMenu(true)">ğŸ“„ TXT visible</button>
    <button class="fab-item" onclick="exportarGlobalXLSX(); toggleFabMenu(true)">ğŸ“Š Excel</button>
    <button class="fab-item" onclick="copiarGlobal(); toggleFabMenu(true)">ğŸ“‹ Copiar</button>
    <button class="fab-item" onclick="exportResumenGlobalTXT(); toggleFabMenu(true)">ğŸ§¾ TXT Global</button>
  </div>

  <!-- Tabbar -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">ğŸ“š<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">ğŸª<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">ğŸ§®<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">ğŸ“¦<span>Proveedores</span></button>
  </nav>

<script>
/* ==========================
   Tema (claro/oscuro) con persistencia
========================== */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  localStorage.setItem('arslan_theme', t);
}
function toggleTheme(){
  const cur = localStorage.getItem('arslan_theme') || 'light';
  applyTheme(cur==='light'?'dark':'light');
}

/* ==========================
   Debounce util + recÃ¡lculo en idle
========================== */
function debounce(fn, wait=300){
  let t=null;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), wait);
  };
}
const idle = (cb)=> (window.requestIdleCallback? requestIdleCallback(cb): setTimeout(cb, 1));

/* ==========================
   Tabs (mÃ³vil) + render diferido + limpieza
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores'];
  ids.forEach(k=>{
    document.getElementById('tab-'+k).style.display = (k===key)?'block':'none';
    document.getElementById('btn-'+k).classList.toggle('active', k===key);
  });

  const fab = document.getElementById('fab');
  if(key==='global'){ fab.style.display='block'; } else { fab.style.display='none'; toggleFabMenu(true); }

  closeAC();

  if(key==='tiendas'){ idle(()=>{ renderClientsUI(); buildRepartoSelector(); }); }
  if(key==='global'){ idle(()=>{ unificarGlobal(); buildProvBar(); }); }
  if(key==='proveedores'){ idle(()=>{ renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); rebuildPricesToday(); }); }
}

/* ==========================
   Config y utilidades
========================== */
const LS = {
  VOCAB:'arslan_v34_vocab',
  STORES:'arslan_v34_stores',
  ASSIGN:'arslan_v34_assign',
  ORDERS:'arslan_v34_orders',
  CLIENTS:'arslan_v34_clients',
  UNDO:'arslan_v34_undo',
  PRICES:'arslan_v34_prices'
};

const PROVEEDORES = ["ESMO","MONTENEGRO","ÃNGEL VACA","JOSÃ‰ ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];
const IGNORE_WORDS_UP = IGNORE_WORDS.map(x=>String(x).toUpperCase());

const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r,]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/Ã±/g,'N').replace(/Ã‘/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS_UP.includes(t));
  return tokens.join(' ').trim();
}
function num(x){
  const n = Number(String(x).replace(',','.'));
  return isNaN(n)? 0 : n;
}
function stepFromEvent(e){
  // base 1, Shift=10, Alt=0.1
  if(e && e.altKey) return 0.1;
  if(e && e.shiftKey) return 10;
  return 1;
}
function clampQty(v){
  if(!isFinite(v)) return 0;
  if(Math.abs(v) < 1e-9) return 0;
  const s = String(v);
  if(s.includes('.') || s.includes(',')){
    return Math.round(v*1000)/1000;
  }
  return v;
}

/* ==========================
   Vocabulario (CACHE en memoria + persistente)
========================== */
let VOCAB = [];
let VOCAB_KEYS = [];

function buildVocabCache(list){
  VOCAB = list.slice();
  VOCAB_KEYS = VOCAB.map(v => normKey(v));
}
function getVocab(){
  return (VOCAB && VOCAB.length) ? VOCAB : loadVocab();
}

/* ==========================
   Vocabulario RAW oficial
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
MANDARINA PLASENCIA 
MANDARINA USOPRADES 
MANZANA GRNNY SMITH 
NARANJA MESA USOPRADES
NARANJA ZUMO USOPRADES
MANZANA STORY 
GUAYABA
ROMANESCU 
PATATA AGRIA 
PATATA MONALISA
PATATA SPUNTA
CEBOLLINO
ENELDO
REMOLACHA
LECHUGA ROBLE
ESCAROLA
GUISANTES 
KIWI MARIPOSA
AGUACATE LISO
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
CALABAZA VIOLIN
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
NARANJA SANGUINA
GOLDEN AUSTRIA
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
PERA CONFERENCIA PRIMERA BIS
REINETA PARDA
POMELO CHINO
MANDARINA TABALET
BERZA
COL DE BRUSELAS
NUECES SEGUNDA 
ESCAROLA 
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
NARANJA SANGUINA
MANDARINA CERTAMEN
REMOLACHA
MANDARINA SANAHUJA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved = localStorage.getItem(LS.VOCAB);
  const base = saved && saved.trim()? saved : OFFICIAL_VOCAB_RAW;
  const list = uniqueVocab(toLines(base));
  byId('vocabTxt').value = list.join('\n');
  buildVocabCache(list);
  return list;
}

/* ==========================
   Estado global
========================== */
const tiendaState = { sp:[], sl:[], st:[] };
let globalRows = [];
let assignments = {};
let orders = {};
let ACTIVE_PROV = PROVEEDORES[0];

/* CLIENTES/HOTELES */
let clients = []; 
// { id, name, tag, input, rows:[{o,e,q,a}] }

/* PRECIOS */
let pricesDB = {}; 
// key normKey(product) -> { name, price, updatedAt }

/* ==========================
   Persistencia
========================== */
const persistState = debounce(function(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.CLIENTS, JSON.stringify(clients));
  localStorage.setItem(LS.PRICES, JSON.stringify(pricesDB));
}, 350);

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{
    const a = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}');
    assignments = a||{};
  }catch{}
  try{
    const o = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}');
    orders = o||{};
  }catch{}
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });

  try{
    const c = JSON.parse(localStorage.getItem(LS.CLIENTS)||'[]');
    clients = Array.isArray(c)? c : [];
  }catch{ clients = []; }

  try{
    const p = JSON.parse(localStorage.getItem(LS.PRICES)||'{}');
    pricesDB = p && typeof p==='object' ? p : {};
  }catch{ pricesDB = {}; }
}

/* ==========================
   Reset total / Limpiar dÃ­a
========================== */
function resetAll(){
  if(!confirm('Â¿Seguro que quieres limpiar TODO (incluye vocabulario)?')) return;
  // âœ… seguro: borra SOLO claves de esta app
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('arslan_theme');
  location.reload();
}

function limpiarDia(){
  if(!confirm('Â¿Limpiar el dÃ­a? (pone en 0 tiendas, clientes, asignaciones y pedidos. NO borra vocabulario ni precios)')) return;

  // tiendas
  tiendaState.sp = [];
  tiendaState.sl = [];
  tiendaState.st = [];
  byId('in_sp').value = '';
  byId('in_sl').value = '';
  byId('in_st').value = '';
  byId('tbl_sp_wrap').innerHTML = '';
  byId('tbl_sl_wrap').innerHTML = '';
  byId('tbl_st_wrap').innerHTML = '';

  // clientes
  clients = clients.map(c=>({ ...c, input:'', rows:[] }));
  renderClientsUI();

  // asignaciones y pedidos
  assignments = {};
  orders = {};
  PROVEEDORES.forEach(p=>orders[p]=[]);

  // reparto no persistente (por seguridad)
  for(const k in repartoState){ delete repartoState[k]; }

  persistState();
  alert('DÃ­a limpiado. (Vocabulario, precios intactos)');
  idle(()=>{ unificarGlobal(); renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); updateUndoPill(); rebuildPricesToday(); });
}

/* ==========================
   Vocab actions
========================== */
function saveVocab(){
  const txt = byId('vocabTxt').value||'';
  localStorage.setItem(LS.VOCAB, txt);
  const list = uniqueVocab(toLines(txt));
  // reescribe limpio
  byId('vocabTxt').value = list.join('\n');
  buildVocabCache(list);
  alert('Vocabulario guardado.');
  renderClientsUI();
  unificarGlobal();
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por lÃ­nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt').value);
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt').value = merged.join('\n');
  saveVocab();
}

/* ==========================
   Coincidencia aproximada (Dice + TokenSet)
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser lÃ­neas (cantidad + nombre) â€” mejorado
========================== */
function parseMaybeFraction(s){
  const m = String(s||'').match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
  if(!m) return null;
  const a = Number(m[1]), b = Number(m[2]);
  if(!b) return null;
  return a/b;
}

function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s = s.replace(/^[-â€¢*]\s*/,'');
  let qty=null, name=s;

  // x150 / x 150
  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  // 1/2
  if(qty===null){
    const mf = s.match(/\b(\d+\s*\/\s*\d+)\b/);
    if(mf){
      const fr = parseMaybeFraction(mf[1]);
      if(fr!==null){ qty=fr; name=s.replace(mf[0],'').trim(); }
    }
  }

  // al final "150 kilos"
  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas|manojo|manojos|saco|sacos)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }

  // al inicio "3 tomate"
  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }

  if(qty===null){ qty=1; }

  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Autocomplete (mejorado + rÃ¡pido con CACHE)
========================== */
let AC_ACTIVE = null;
let AC_OWNER = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; AC_OWNER=null; } }

document.addEventListener('click', (e)=>{
  if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==AC_OWNER){
    closeAC();
  }
}, {capture:true});

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;

    const qk = normKey(val);
    const vocab = getVocab();

    // primero prefijo, luego contains
    const suggestions = [];
    for(let i=0;i<vocab.length;i++){
      const vk = VOCAB_KEYS[i];
      if(vk.startsWith(qk) || vk.includes(qk)){
        suggestions.push(vocab[i]);
        if(suggestions.length>=8) break;
      }
    }

    // si no hay, usa bestMatch
    if(!suggestions.length){
      const m = bestMatch(val, vocab);
      if(m && m.name) suggestions.push(m.name);
    }

    if(!suggestions.length) return;
    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';
    suggestions.forEach((s)=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ onPick(s); closeAC(); };
      box.appendChild(item);
    });
    document.body.appendChild(box);
    AC_ACTIVE = box;
    AC_OWNER = cell;
  }, {passive:true});
}

/* ==========================
   âœ… Atajos cantidades (delegaciÃ³n)
========================== */
function bindQtyShortcuts(rootEl, getCellValue, setCellValue, onChanged){
  if(!rootEl) return;
  rootEl.addEventListener('keydown', (e)=>{
    const t = e.target;
    if(!t) return;
    if(!(t instanceof HTMLElement)) return;
    if(!t.isContentEditable) return;

    const f = t.dataset && t.dataset.f;
    if(f!=='q' && f!=='qty' && f!=='total') return;

    const key = e.key;
    const isPlus = (key==='+' || key==='=');
    const isMinus = (key==='-' || key==='_');
    const isUp = (key==='ArrowUp');
    const isDown = (key==='ArrowDown');
    const isEnter = (key==='Enter');

    if(isPlus || isMinus || isUp || isDown){
      e.preventDefault();
      const step = stepFromEvent(e);
      const cur = num(getCellValue(t));
      const next = clampQty(cur + ((isMinus || isDown)? -step : step));
      setCellValue(t, next);
      if(typeof onChanged==='function') onChanged(t, next);
      placeCaretAtEnd(t);
      return;
    }

    if(isEnter){
      e.preventDefault();
      focusNextEditableCell(t);
      return;
    }
  }, true);
}

function placeCaretAtEnd(el){
  try{
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch{}
}

function focusNextEditableCell(cur){
  try{
    const tr = cur.closest('tr');
    if(!tr) return;
    const table = tr.closest('table');
    if(!table) return;
    const all = Array.from(table.querySelectorAll('td[contenteditable="true"]'));
    const idx = all.indexOf(cur);
    if(idx>-1 && all[idx+1]){
      all[idx+1].focus();
      return;
    }
  }catch{}
}
</script>
<script>
/* ==========================
   Render tabla tienda
========================== */
function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap');
  const rows = tiendaState[code]||[];
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},+1)">+</button>
        </div>
      </td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    tiendaState[code][i].q = num(val);
    persistState();
    pushUndo({type:'edit_store_qty', code});
    idle(()=>unificarGlobal());
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        tiendaState[code][i].e = picked;
        tiendaState[code][i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_store', code});
        idle(()=>unificarGlobal());
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        tiendaState[code][i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        tiendaState[code][i].e = cleaned;
        const vocab = getVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
      pushUndo({type:'edit_store', code});
      idle(()=>unificarGlobal());
    }, {passive:true});
  });
}

function bumpStoreQty(code, idx, delta){
  if(!tiendaState[code] || !tiendaState[code][idx]) return;
  tiendaState[code][idx].q = clampQty(num(tiendaState[code][idx].q) + delta);
  persistState();
  pushUndo({type:'bump_store_qty', code});
  renderTable(code);
  idle(()=>unificarGlobal());
}

function estandarizar(code){
  const vocab = getVocab();
  const txt = byId('in_'+code).value;
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || p.name;
    rows.push({o:p.original, e:chosen, q:p.qty, a:(normKey(chosen)!==normKey(p.name))});
  });
  tiendaState[code] = rows;
  renderTable(code);
  persistState();
  pushUndo({type:'estandarizar_store', code});
  idle(()=>{ unificarGlobal(); buildRepartoSelector(); });
}

function guardarTienda(code){
  const out = (tiendaState[code]||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  byId('in_'+code).value = out;
  alert(`Tienda ${code.toUpperCase()} guardada en el textarea.`);
}

function exportarTiendaTXT(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${code}_estandarizado_${today}.txt`;
  a.click();
}
function enviarTiendaWhatsApp(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const msg = encodeURIComponent(`ğŸ›’ *Pedido ${code.toUpperCase()}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   CLIENTES/HOTELES
========================== */
function genId(){
  return 'cli_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function addClient(){
  const name = prompt('Nombre cliente/hotel (ej: BRASEROS / RIVIERA / HOTEL CORDON):');
  if(!name) return;
  const tag = prompt('TAG / Sede (ej: CENTRO, FORUM, EDIFICIO, TOMILLARES, SEVERO, GENERAL, TARDE):') || '';
  clients.push({ id: genId(), name: removeDiacriticsUpper(name), tag: removeDiacriticsUpper(tag), input:'', rows:[] });
  persistState();
  renderClientsUI();
}

function saveClients(){
  persistState();
  alert('Clientes guardados.');
  idle(()=>{ unificarGlobal(); buildRepartoSelector(); });
}

function deleteClient(id){
  if(!confirm('Â¿Eliminar este cliente?')) return;
  clients = clients.filter(c=>c.id!==id);
  persistState();
  renderClientsUI();
  idle(()=>{ unificarGlobal(); buildRepartoSelector(); });
}

function renderClientsUI(){
  const wrap = byId('clients_wrap');
  if(!wrap) return;

  if(!clients.length){
    wrap.innerHTML = `<div class="hint">No hay clientes aÃºn. Pulsa â€œ+ Nuevo clienteâ€.</div>`;
    return;
  }

  let html = '';
  clients.forEach((c)=>{
    const label = c.tag ? `${c.name} â€” ${c.tag}` : c.name;
    html += `
      <div class="card" style="margin-bottom:10px">
        <div class="hd">
          <strong>ğŸ¨ ${label}</strong>
          <div class="toolbar">
            <button class="btn small ghost" onclick="estandarizarCliente('${c.id}')">Estandarizar</button>
            <button class="btn small" onclick="guardarCliente('${c.id}')">Guardar</button>
            <button class="btn small muted" onclick="exportarClienteTXT('${c.id}')">TXT</button>
            <button class="btn small muted" onclick="enviarClienteWhatsApp('${c.id}')">WhatsApp</button>
            <button class="btn small muted" onclick="deleteClient('${c.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <div>
              <div class="hint">Nombre</div>
              <input style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--bg);color:var(--ink)"
                value="${c.name||''}" onblur="updateClientField('${c.id}','name',this.value)">
            </div>
            <div>
              <div class="hint">TAG</div>
              <input style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--bg);color:var(--ink)"
                value="${c.tag||''}" onblur="updateClientField('${c.id}','tag',this.value)">
            </div>
          </div>
          <textarea id="in_${c.id}" placeholder="Pega pedido cliente/hotel...">${c.input||''}</textarea>
          <div class="hint">Edita en tabla igual que tiendas. Cantidades con teclado (+/-/â†‘/â†“).</div>
          <div id="tbl_${c.id}_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    `;
  });

  wrap.innerHTML = html;

  clients.forEach(c=>{
    if(Array.isArray(c.rows) && c.rows.length){
      renderClientTable(c.id);
    }
  });
}

function updateClientField(id, field, value){
  const idx = clients.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(field==='name') clients[idx].name = removeDiacriticsUpper(value);
  if(field==='tag') clients[idx].tag = removeDiacriticsUpper(value);
  persistState();
  idle(()=>{ buildRepartoSelector(); unificarGlobal(); });
}

function renderClientTable(id){
  const wrap = byId('tbl_'+id+'_wrap');
  const c = clients.find(x=>x.id===id);
  if(!wrap || !c) return;
  const rows = c.rows||[];
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpClientQty('${id}',${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpClientQty('${id}',${i},+1)">+</button>
        </div>
      </td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    c.rows[i].q = num(val);
    persistState();
    pushUndo({type:'edit_client_qty', id});
    idle(()=>unificarGlobal());
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        c.rows[i].e = picked;
        c.rows[i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_client', id});
        idle(()=>unificarGlobal());
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        c.rows[i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        c.rows[i].e = cleaned;
        const vocab = getVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ c.rows[i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { c.rows[i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
      pushUndo({type:'edit_client', id});
      idle(()=>unificarGlobal());
    }, {passive:true});
  });
}

function bumpClientQty(id, idx, delta){
  const c = clients.find(x=>x.id===id);
  if(!c || !c.rows || !c.rows[idx]) return;
  c.rows[idx].q = clampQty(num(c.rows[idx].q) + delta);
  persistState();
  pushUndo({type:'bump_client_qty', id});
  renderClientTable(id);
  idle(()=>unificarGlobal());
}

function estandarizarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const txt = byId('in_'+id).value;
  c.input = txt;
  const vocab = getVocab();
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || p.name;
    rows.push({o:p.original, e:chosen, q:p.qty, a:(normKey(chosen)!==normKey(p.name))});
  });
  c.rows = rows;
  renderClientTable(id);
  persistState();
  pushUndo({type:'estandarizar_client', id});
  idle(()=>{ unificarGlobal(); buildRepartoSelector(); });
}

function guardarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const out = (c.rows||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  byId('in_'+id).value = out;
  c.input = out;
  persistState();
  alert('Cliente guardado.');
}

function exportarClienteTXT(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const label = (c.tag? `${c.name}_${c.tag}`:c.name).replace(/\s+/g,'_');
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cliente_${label}_${today}.txt`;
  a.click();
}

function enviarClienteWhatsApp(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const label = c.tag? `${c.name} â€” ${c.tag}`:c.name;
  const msg = encodeURIComponent(`ğŸ¨ *Pedido ${label}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}
</script>
<script>
/* ==========================
   UNDO simple (Ãºltimas acciones)
========================== */
let undoStack = [];
function loadUndo(){
  try{ undoStack = JSON.parse(localStorage.getItem(LS.UNDO)||'[]') || []; }catch{ undoStack=[]; }
  updateUndoPill();
}
function pushUndo(meta){
  const snap = {
    meta: meta||{},
    ts: Date.now(),
    tiendaState: JSON.parse(JSON.stringify(tiendaState)),
    clients: JSON.parse(JSON.stringify(clients)),
    assignments: JSON.parse(JSON.stringify(assignments)),
    orders: JSON.parse(JSON.stringify(orders)),
    pricesDB: JSON.parse(JSON.stringify(pricesDB))
  };
  undoStack.push(snap);
  if(undoStack.length>25) undoStack.shift();
  localStorage.setItem(LS.UNDO, JSON.stringify(undoStack));
  updateUndoPill();
}
function updateUndoPill(){
  const el = byId('undoPill');
  if(el) el.textContent = 'Undo: ' + (undoStack.length||0);
}
function undoLast(){
  if(!undoStack.length){ alert('No hay nada para deshacer.'); return; }
  const snap = undoStack.pop();
  tiendaState.sp = snap.tiendaState.sp||[];
  tiendaState.sl = snap.tiendaState.sl||[];
  tiendaState.st = snap.tiendaState.st||[];
  clients = snap.clients||[];
  assignments = snap.assignments||{};
  orders = snap.orders||{};
  pricesDB = snap.pricesDB || {};
  localStorage.setItem(LS.UNDO, JSON.stringify(undoStack));
  persistState();
  updateUndoPill();
  renderTable('sp'); renderTable('sl'); renderTable('st');
  renderClientsUI();
  unificarGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}

/* ==========================
   Unificar global (tiendas + clientes)
========================== */
function getAllRowsUnified(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const clientRows = [];
  clients.forEach(c=>{
    (c.rows||[]).forEach(r=>clientRows.push(r));
  });
  return all.concat(clientRows);
}

function unificarGlobal(){
  const all = getAllRowsUnified();
  const map = new Map();
  all.forEach(r=>{
    const key = normKey(r.e);
    if(!map.has(key)) map.set(key,{name:r.e,total:0});
    map.get(key).total += (Number(r.q)||0);
  });
  const arr = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  const names = arr.map(x=>x.name);
  const similarSet = new Set();

  // âœ… OPT: comparar solo vecinos cercanos (mucho mÃ¡s rÃ¡pido)
  for(let i=0;i<names.length;i++){
    for(let j=i+1;j<Math.min(i+15, names.length);j++){
      const s1 = names[i], s2 = names[j];
      const sc = similarityScore(s1, s2);
      if(sc>=0.86 && normKey(s1)!==normKey(s2)){
        similarSet.add(s1); similarSet.add(s2);
      }
    }
  }
  renderGlobalTable(arr, similarSet);
}

/* ==========================
   GLOBAL + AsignaciÃ³n a proveedor
========================== */
function renderGlobalTable(rows, similarSet){
  const visible = rows.filter(r => !assignments[normKey(r.name)]);
  globalRows = visible;

  const wrap = byId('global_wrap');
  if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no unificado).</div>'; return; }

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Proveedor activo: <b>${ACTIVE_PROV}</b>. Usa âœ… para asignar rÃ¡pidamente.
    </div>
    <div class="scroll-x"><table>
      <thead><tr><th></th><th>Producto</th><th>Total</th><th>Tools</th><th>Estado</th></tr></thead>
      <tbody>`;
  visible.forEach((r,i)=>{
    const isSimilar = similarSet.has(r.name);
    html += `<tr data-i="${i}" class="${isSimilar?'dup':''}">
      <td><button class="ok-assign" onclick="assignFromGlobal(${i})">âœ…</button></td>
      <td contenteditable="true" data-f="name">${r.name}${isSimilar?'<span class="flag">âš ï¸</span>':''}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpGlobalQty(${i},-1)">-</button>
          <button class="qty-btn" onclick="bumpGlobalQty(${i},+1)">+</button>
        </div>
      </td>
      <td>${isSimilar? '<span class="pill warn">Posible duplicado</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const tr = cell.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.i);
    if(!isFinite(idx)) return;
    if(cell.dataset.f==='total'){
      globalRows[idx].total = num(val);
      persistState();
      pushUndo({type:'edit_global_total'});
    }
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr = cell.parentElement;
    const idx = Number(tr.dataset.i);
    const f = cell.dataset.f;
    if(f==='name'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        globalRows[idx].name = picked;
        tr.classList.remove('dup');
        tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='total'){
        globalRows[idx].total = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        globalRows[idx].name = cleaned;
        const vocab = getVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        if(exact){
          tr.classList.remove('dup');
          tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        }else{
          let dup = false;
          for(let k=0;k<globalRows.length;k++){
            if(k===idx) continue;
            const sc = similarityScore(globalRows[idx].name, globalRows[k].name);
            if(sc>=0.86 && normKey(globalRows[idx].name)!==normKey(globalRows[k].name)){ dup=true; break; }
          }
          if(dup){
            tr.classList.add('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill warn">Posible duplicado</span>';
          }else{
            tr.classList.remove('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill">OK</span>';
          }
        }
      }
      persistState();
      pushUndo({type:'edit_global'});
    }, {passive:true});
  });
}

function bumpGlobalQty(idx, delta){
  if(!globalRows[idx]) return;
  globalRows[idx].total = clampQty(num(globalRows[idx].total) + delta);
  pushUndo({type:'bump_global_qty'});
  unificarGlobal();
}

function assignFromGlobal(idx){
  const item = globalRows[idx];
  if(!item) return;
  const k = normKey(item.name);

  pushUndo({type:'assign', idx, name:item.name, prov:ACTIVE_PROV, qty:item.total});

  assignments[k] = ACTIVE_PROV;

  const list = orders[ACTIVE_PROV]||[];
  const exIdx = list.findIndex(x=> normKey(x.name)===k);
  if(exIdx>-1){ list[exIdx].qty += Number(item.total)||0; }
  else{ list.push({name:item.name, qty:Number(item.total)||0}); }
  orders[ACTIVE_PROV] = list;

  persistState();
  idle(()=>unificarGlobal());
  renderProvidersPanels();
  rebuildPricesToday();
}

/* ==========================
   Barra proveedores + paneles (con â€œDevolver a Globalâ€)
========================== */
function buildProvBar(){
  const bar = byId('provBar'); bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'prov-btn' + (p===ACTIVE_PROV?' active':'');
    b.textContent = p;
    b.onclick = ()=>{
      ACTIVE_PROV = p;
      buildProvBar();
      idle(()=>unificarGlobal());
    };
    bar.appendChild(b);
  });
}

function unassignProviderLine(prov, idx){
  if(!orders[prov] || !orders[prov][idx]) return;
  const it = orders[prov][idx];
  const k = normKey(it.name);

  pushUndo({type:'unassign_line', prov, idx, name:it.name});

  // quitar asignaciÃ³n si estÃ¡ asignado a ese prov
  if(assignments[k] === prov) delete assignments[k];

  // quitar lÃ­nea de pedido
  orders[prov].splice(idx, 1);

  persistState();
  unificarGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}

function renderProvidersPanels(){
  const cont = byId('provPanels'); cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[];
    const card = document.createElement('div');
    card.className='card';
    const hd = document.createElement('div');
    hd.className='hd';
    hd.innerHTML = `<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small" onclick="exportProvTXT('${p}')">ğŸ“„ TXT ${p}</button>
        <button class="btn small muted" onclick="enviarProvWhatsApp('${p}')">ğŸ“² WhatsApp</button>
      </div>`;
    const bd = document.createElement('div');
    bd.className='bd';

    if(!list.length){
      bd.innerHTML = '<div class="hint">Sin productos asignados.</div>';
    }else{
      let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th><th>Tools</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        html += `<tr>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
          <td>
            <div class="qty-tools">
              <button class="qty-btn" onclick="bumpProvQty('${p}',${ix},-1)">-</button>
              <button class="qty-btn" onclick="bumpProvQty('${p}',${ix},+1)">+</button>
              <button class="qty-btn" title="Devolver a Global" onclick="unassignProviderLine('${p}',${ix})">â†©ï¸</button>
            </div>
          </td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      bd.innerHTML = html;

      bindQtyShortcuts(bd, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(!orders[prov] || !orders[prov][idx]) return;
        if(f==='qty'){
          orders[prov][idx].qty = num(val);
          persistState();
          pushUndo({type:'edit_provider_qty', prov});
          rebuildPricesToday();
        }
      });

      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(f==='name'){
          attachAutocomplete(cell, picked=>{
            cell.innerText = picked;
            orders[prov][idx].name = picked;
            persistState();
            pushUndo({type:'edit_provider', prov});
            rebuildPricesToday();
          });
        }
        cell.addEventListener('blur', ()=>{
          const val = cell.innerText.trim();
          if(f==='qty'){
            orders[prov][idx].qty = num(val)||0;
          }else{
            orders[prov][idx].name = removeDiacriticsUpper(val);
          }
          persistState();
          pushUndo({type:'edit_provider', prov});
          rebuildPricesToday();
        }, {passive:true});
      });
    }

    card.appendChild(hd); card.appendChild(bd);
    cont.appendChild(card);
  });
}

function bumpProvQty(prov, idx, delta){
  if(!orders[prov] || !orders[prov][idx]) return;
  orders[prov][idx].qty = clampQty(num(orders[prov][idx].qty) + delta);
  persistState();
  pushUndo({type:'bump_provider_qty', prov});
  renderProvidersPanels();
  rebuildPricesToday();
}

function exportProvTXT(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay lÃ­neas para ' + prov); return; }
  const today = new Date().toISOString().split('T')[0];

  // âœ… regla ESMO: sin primer espacio entre cantidad y producto
  const txt = list.map(x=>{
    if(prov==="ESMO") return `${x.qty}${x.name}`;
    return `${x.qty} ${x.name}`;
  }).join('\n');

  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${prov}_${today}.txt`; a.click();
}
function enviarProvWhatsApp(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay lÃ­neas para ' + prov); return; }

  const txt = list.map(x=>{
    const k = normKey(x.name);
    const pr = pricesDB[k] && pricesDB[k].price ? ` â€” ${Number(pricesDB[k].price).toFixed(2)}â‚¬` : '';
    const base = (prov==="ESMO") ? `${x.qty}${x.name}` : `${x.qty} ${x.name}`;
    return `${base}${pr}`;
  }).join('\n');

  const msg = encodeURIComponent(`ğŸ“¦ *Pedido ${prov}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   Export Global
========================== */
function copiarGlobal(){
  if(!globalRows.length) return;
  const txt = globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n');
  navigator.clipboard.writeText(txt);
  alert('Lista global copiada.');
}
function exportarGlobalTXT(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = globalRows.map(r=>`${r.total}\t${r.name}`).join('\n');
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click();
}
function exportarGlobalXLSX(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([['Producto','Total'], ...globalRows.map(r=>[r.name,r.total])]);
  XLSX.utils.book_append_sheet(wb, ws, 'Global');
  XLSX.writeFile(wb, `lista_global_${today}.xlsx`);
}

/* ==========================
   TXT Global (asignados + pendientes)
========================== */
function exportResumenGlobalTXT(){
  const all = getAllRowsUnified();
  const totalMap = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!k) return;
    if(!totalMap[k]) totalMap[k] = {name:r.e, total:0};
    totalMap[k].total += (Number(r.q)||0);
  });

  const byProv = {}; PROVEEDORES.forEach(p=>byProv[p]=[]);
  const unassigned = [];
  Object.values(totalMap).forEach(it=>{
    const k = normKey(it.name);
    const prov = assignments[k];
    if(prov && PROVEEDORES.includes(prov)){
      byProv[prov].push({name:it.name, qty:it.total});
    }else{
      unassigned.push({name:it.name, qty:it.total});
    }
  });

  let out = `ğŸ“¦ PEDIDOS POR PROVEEDOR\n\n`;
  PROVEEDORES.forEach(p=>{
    out += `> ${p}:\n`;
    if(byProv[p].length){
      byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es'));
      byProv[p].forEach(x=>{
        if(p==="ESMO") out += `- ${x.qty}${x.name}\n`;
        else out += `- ${x.qty} ${x.name}\n`;
      });
    }else{
      out += `- (sin lÃ­neas)\n`;
    }
    out += `\n`;
  });

  out += `ğŸ“Œ SIN PROVEEDOR ASIGNADO:\n`;
  if(unassigned.length){
    unassigned.sort((a,b)=>a.name.localeCompare(b.name,'es'));
    unassigned.forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
  }else{
    out += `- (sin lÃ­neas)\n`;
  }

  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([out],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`resumen_pedidos_${today}.txt`; a.click();
}

/* ==========================
   ğŸ’¶ PRECIOS (solo comprado/asignado + no asignados)
========================== */
function getBoughtTodaySet(){
  const set = new Map();
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>{
      const k = normKey(it.name);
      if(!k) return;
      if(!set.has(k)) set.set(k, it.name);
    });
  });

  // â• tambiÃ©n aÃ±adir no asignados de Global, para poder ponerles precio
  const all = getAllRowsUnified();
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!k) return;
    if(!assignments[k] && !set.has(k)){
      set.set(k, r.e);
    }
  });

  return set;
}

function rebuildPricesToday(){
  const wrap = byId('prices_wrap');
  if(!wrap) return;

  const bought = getBoughtTodaySet();
  if(!bought.size){
    wrap.innerHTML = `<div class="hint">No hay productos comprados/asignados todavÃ­a (asigna desde Global o aÃ±ade a pedidos).</div>`;
    return;
  }

  bought.forEach((name,k)=>{
    if(!pricesDB[k]){
      pricesDB[k] = { name:name, price:'', updatedAt:0 };
    }else{
      pricesDB[k].name = pricesDB[k].name || name;
    }
  });

  const rows = Array.from(bought.entries()).map(([k,name])=>{
    const rec = pricesDB[k] || {name, price:'', updatedAt:0};
    return { k, name: rec.name || name, price: rec.price || '', updatedAt: rec.updatedAt || 0 };
  }).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  let html = `<div class="scroll-x"><table>
    <thead><tr><th>Producto</th><th>Precio (â‚¬)</th><th>Ãšltima actualizaciÃ³n</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const dt = r.updatedAt ? new Date(r.updatedAt) : null;
    const stamp = dt ? dt.toLocaleString() : '';
    html += `<tr>
      <td class="green">${r.name}</td>
      <td contenteditable="true" data-pricekey="${r.k}" data-f="price">${r.price}</td>
      <td class="hint">${stamp}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        focusNextEditableCell(cell);
      }
    });
    cell.addEventListener('blur', ()=>{
      const k = cell.dataset.pricekey;
      const raw = (cell.innerText||'').trim();
      if(!k) return;

      if(raw===''){
        cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';
        return;
      }

      const n = parseFloat(String(raw).replace(',','.'));
      if(isNaN(n)){
        cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';
        return;
      }

      const val = n.toFixed(2);

      if(pricesDB[k] && String(pricesDB[k].price||'') === val){
        cell.innerText = val;
        return;
      }

      pricesDB[k] = pricesDB[k] || { name:'', price:'', updatedAt:0 };
      pricesDB[k].price = val;
      pricesDB[k].updatedAt = Date.now();
      persistState();

      idle(()=>renderRepartoTienda());
    }, {passive:true});
  });

  persistState();
}

function exportPricesTXT(){
  const bought = getBoughtTodaySet();
  if(!bought.size){ alert('No hay productos comprados/asignados hoy.'); return; }
  const rows = [];
  bought.forEach((name,k)=>{
    const rec = pricesDB[k];
    if(rec && rec.price){
      rows.push(`${rec.name || name}\t${rec.price}â‚¬`);
    }
  });
  if(!rows.length){ alert('No hay precios guardados para los productos de hoy.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([rows.join('\n')],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`precios_${today}.txt`; a.click();
}

function resetPricesConfirm(){
  if(!confirm('Â¿Resetear TODOS los precios guardados? (No afecta pedidos ni vocabulario)')) return;
  pricesDB = {};
  persistState();
  rebuildPricesToday();
  alert('Precios reseteados.');
}

/* ==========================
   ğŸšš REPARTO (tiendas + clientes)
========================== */
const repartoState = {};
function keyLine(name){ return normKey(name); }

function getRepartoDestinations(){
  const dests = [];
  dests.push({ key:'sp', label:'ğŸª San Pablo', type:'store' });
  dests.push({ key:'sl', label:'ğŸª San Lesmes', type:'store' });
  dests.push({ key:'st', label:'ğŸª Santiago', type:'store' });

  clients.forEach(c=>{
    const has = (c.rows||[]).some(x=>Number(x.q)>0);
    if(!has) return;
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    dests.push({ key:c.id, label, type:'client' });
  });

  return dests;
}

function buildRepartoSelector(){
  const sel = byId('selRepartoTienda');
  if(!sel) return;
  const dests = getRepartoDestinations();
  const current = sel.value;

  sel.innerHTML = `<option value="">Selecciona destino...</option>` + dests.map(d=>`<option value="${d.key}">${d.label}</option>`).join('');
  if(current && dests.some(d=>d.key===current)) sel.value = current;
}

function marcarTodoReparto(checked){
  const sel = byId('selRepartoTienda');
  const code = sel ? sel.value : '';
  if(!code){ alert('Selecciona un destino primero.'); return; }
  if(!repartoState[code]){ renderRepartoTienda(); }
  if(!repartoState[code]) return;

  Object.keys(repartoState[code]).forEach(k=>{
    repartoState[code][k].checked = !!checked;
  });
  renderRepartoTienda();
}

function renderRepartoTienda(){
  const sel = byId('selRepartoTienda');
  const code = sel ? sel.value : '';
  const wrap = byId('reparto_wrap');
  if(!wrap) return;

  if(!code){ wrap.innerHTML = '<div class="hint">Selecciona un destino para ver su lista.</div>'; return; }

  let lista = [];
  const isClient = clients.some(c=>c.id===code);
  if(isClient){
    const c = clients.find(x=>x.id===code);
    lista = (c && c.rows) ? c.rows : [];
  }else{
    lista = tiendaState[code] || [];
  }

  if(!lista.length){ wrap.innerHTML = '<div class="hint">Sin datos en este destino.</div>'; return; }

  const prev = repartoState[code] || {};
  const next = {};

  lista.forEach(x=>{
    const k = keyLine(x.e);
    if(!k) return;
    const old = prev[k] || { name:x.e, qty:x.q, price:'', checked:false };

    let price = old.price;
    const pr = pricesDB[k] && pricesDB[k].price ? pricesDB[k].price : '';
    if(!price && pr) price = pr;

    next[k] = {
      name: x.e,
      qty: x.q,
      price: price || '',
      checked: !!old.checked
    };
  });

  repartoState[code] = next;

  const arr = Object.values(next).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  let totalImporte = 0;
  arr.forEach(r=>{
    const p = parseFloat(String(r.price||'').replace(',','.'));
    if(!isNaN(p) && r.checked){
      totalImporte += (num(r.qty) * p);
    }
  });

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Seleccionados con precio: <b>${totalImporte ? totalImporte.toFixed(2)+'â‚¬' : '0.00â‚¬'}</b>
    </div>
    <table>
      <thead><tr><th></th><th>Producto</th><th>Cantidad</th><th>Tools</th><th>Precio (â‚¬)</th></tr></thead><tbody>`;

  arr.forEach((r,i)=>{
    const rowKey = keyLine(r.name);
    html += `<tr>
      <td><input type="checkbox" ${r.checked?'checked':''} onchange="toggleRepartoItem('${code}', '${rowKey}', this.checked)"></td>
      <td>${r.name}</td>
      <td class="green">${r.qty}</td>
      <td>
        <div class="qty-tools">
          <button class="qty-btn" onclick="bumpRepartoQty('${code}','${rowKey}',-1)">-</button>
          <button class="qty-btn" onclick="bumpRepartoQty('${code}','${rowKey}',+1)">+</button>
        </div>
      </td>
      <td contenteditable="true" data-f="price" data-rk="${rowKey}" onblur="updateRepartoPrice('${code}', '${rowKey}', this.innerText)">${r.price||''}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        focusNextEditableCell(cell);
      }
    });
  });
}

function toggleRepartoItem(code, rowKey, checked){
  if(!repartoState[code]) return;
  if(!repartoState[code][rowKey]) return;
  repartoState[code][rowKey].checked = checked;
  renderRepartoTienda();
}

function updateRepartoPrice(code, rowKey, val){
  if(!repartoState[code]) return;
  if(!repartoState[code][rowKey]) return;

  const raw = String(val||'').trim();
  if(raw===''){
    repartoState[code][rowKey].price = '';
    renderRepartoTienda();
    return;
  }

  const n = parseFloat(raw.replace(',','.'));
  if(isNaN(n)){
    renderRepartoTienda();
    return;
  }

  const fixed = n.toFixed(2);
  repartoState[code][rowKey].price = fixed;

  const name = repartoState[code][rowKey].name;
  const k = normKey(name);
  pricesDB[k] = pricesDB[k] || { name:name, price:'', updatedAt:0 };
  if(String(pricesDB[k].price||'') !== fixed){
    pricesDB[k].name = pricesDB[k].name || name;
    pricesDB[k].price = fixed;
    pricesDB[k].updatedAt = Date.now();
    persistState();
    rebuildPricesToday();
  }else{
    persistState();
  }

  renderRepartoTienda();
}

function bumpRepartoQty(code, rowKey, delta){
  if(!repartoState[code] || !repartoState[code][rowKey]) return;
  const name = repartoState[code][rowKey].name;
  const nk = normKey(name);

  const c = clients.find(x=>x.id===code);
  if(c){
    const idx = (c.rows||[]).findIndex(r=>normKey(r.e)===nk);
    if(idx>-1){
      c.rows[idx].q = clampQty(num(c.rows[idx].q) + delta);
      persistState();
      pushUndo({type:'bump_reparto_client_qty', code});
      renderClientTable(code);
      renderRepartoTienda();
      idle(()=>unificarGlobal());
      return;
    }
  }

  if(code==='sp' || code==='sl' || code==='st'){
    const idx = (tiendaState[code]||[]).findIndex(r=>normKey(r.e)===nk);
    if(idx>-1){
      tiendaState[code][idx].q = clampQty(num(tiendaState[code][idx].q) + delta);
      persistState();
      pushUndo({type:'bump_reparto_store_qty', code});
      renderTable(code);
      renderRepartoTienda();
      idle(()=>unificarGlobal());
      return;
    }
  }
}

function exportarRepartoTXT(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  const txt = seleccionados
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x => `${x.qty} ${x.name}${x.price ? ' â€” ' + x.price + 'â‚¬' : ''}`).join('\n');

  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `reparto_${code}_${today}.txt`;
  a.click();
}

function enviarRepartoWhatsApp(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  let total = 0;
  seleccionados.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  let msg = `ğŸšš *Reparto ${code.toUpperCase()}*\n\n`;
  seleccionados.sort((a,b)=>a.name.localeCompare(b.name,'es')).forEach(x=>{
    msg += `- ${x.qty} ${x.name}`;
    if(x.price) msg += ` â€” ${x.price}â‚¬`;
    msg += '\n';
  });
  if(total>0) msg += `\n*TOTAL:* ${total.toFixed(2)}â‚¬`;

  msg = encodeURIComponent(msg);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   ğŸ§¾ PDF Reparto con cuadrÃ­cula (sin librerÃ­as)
========================== */
function exportarRepartoPDF(){
  const code = byId('selRepartoTienda').value;
  if(!code){ alert('Selecciona un destino primero.'); return; }

  const st = repartoState[code] || {};
  const seleccionados = Object.values(st).filter(x=>x.checked);
  if(!seleccionados.length){ alert('No hay productos seleccionados.'); return; }

  const dt = new Date();
  const dateStr = dt.toLocaleDateString();
  const timeStr = dt.toLocaleTimeString();

  let total = 0;
  seleccionados.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  const rowsHTML = seleccionados
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x=>{
      const p = x.price ? Number(x.price).toFixed(2) : '';
      const imp = x.price ? (num(x.qty)*Number(x.price)).toFixed(2) : '';
      return `<tr>
        <td>${escapeHTML(x.name)}</td>
        <td style="text-align:right">${escapeHTML(x.qty)}</td>
        <td style="text-align:right">${p?escapeHTML(p):''}</td>
        <td style="text-align:right">${imp?escapeHTML(imp):''}</td>
      </tr>`;
    }).join('');

  const w = window.open('', '_blank');
  if(!w){ alert('Bloqueado por el navegador. Permite popups.'); return; }

  w.document.open();
  w.document.write(`
    <!doctype html>
    <html lang="es">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Reparto ${escapeHTML(code.toUpperCase())}</title>
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
      <style>
        body{font-family:Poppins,system-ui,Arial;margin:24px;color:#111827}
        h1{font-size:18px;margin:0 0 6px}
        .meta{font-size:12px;color:#6b7280;margin-bottom:14px}
        .grid{width:100%;border-collapse:collapse;font-size:12px}
        .grid th,.grid td{border:1px solid #11182722;padding:6px;vertical-align:top}
        .grid th{background:#11182710;text-transform:uppercase;letter-spacing:.04em}
        .tot{margin-top:10px;font-size:12px}
        @media print{ .noPrint{display:none} }
        .noPrint{margin-bottom:12px}
        button{padding:8px 12px;border:1px solid #11182722;border-radius:10px;background:#fff;cursor:pointer}
      </style>
    </head>
    <body>
      <div class="noPrint">
        <button onclick="window.print()">ğŸ§¾ Imprimir / Guardar como PDF</button>
      </div>
      <h1>ğŸšš Reparto ${escapeHTML(code.toUpperCase())}</h1>
      <div class="meta">${escapeHTML(dateStr)} â€” ${escapeHTML(timeStr)}</div>

      <table class="grid">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Precio</th>
            <th style="text-align:right">Importe</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHTML}
        </tbody>
      </table>

      <div class="tot"><b>TOTAL:</b> ${total.toFixed(2)}â‚¬</div>
    </body>
    </html>
  `);
  w.document.close();
}

/* ==========================
   Escape HTML
========================== */
function escapeHTML(str){
  return String(str||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* ==========================
   FAB helpers
========================== */
function toggleFabMenu(forceHide){
  const m = byId('fabMenu');
  if(forceHide){ m.classList.remove('show'); return; }
  m.classList.toggle('show');
}
document.addEventListener('click', (e)=>{
  const m = byId('fabMenu'), f = byId('fab');
  if(m && f && !m.contains(e.target) && e.target!==f){ m.classList.remove('show'); }
}, {capture:true});

/* ==========================
   âœ… GENERAR LINK PRECIOS (externo /ponerprecios/)
========================== */
function buildPricesPayloadForLink(){
  const all = getAllRowsUnified();
  const totalMap = {};
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!k) return;
    if(!totalMap[k]) totalMap[k] = {name:r.e, total:0};
    totalMap[k].total += (Number(r.q)||0);
  });

  const products = [];

  // 1) Productos asignados a proveedor (orders)
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>{
      const name = it.name;
      const qty = it.qty;
      const k = normKey(name);
      const rec = pricesDB[k];
      const oldPrice = rec && rec.price ? String(rec.price) : '';
      products.push({
        provider: p,
        name,
        qty,
        oldPrice
      });
    });
  });

  // 2) Productos no asignados (SIN PROVEEDOR)
  Object.values(totalMap).forEach(it=>{
    const k = normKey(it.name);
    if(assignments[k]) return; // ya asignado a algÃºn proveedor
    const rec = pricesDB[k];
    const oldPrice = rec && rec.price ? String(rec.price) : '';
    products.push({
      provider: "SIN PROVEEDOR",
      name: it.name,
      qty: it.total,
      oldPrice
    });
  });

  return {
    title: "PRECIOS",
    dateISO: new Date().toISOString().split('T')[0],
    products
  };
}

function generarLinkPrecios(){
  const payload = buildPricesPayloadForLink();
  if(!payload.products.length){
    alert('No hay productos para poner precios (asigna pedidos o ten Global con lÃ­neas).');
    return;
  }
  const json = JSON.stringify(payload);
  const packed = LZString.compressToEncodedURIComponent(json);
  const baseURL = "https://shaniwaris80-crypto.github.io/ponerprecios/";
  const url = `${baseURL}?data=${packed}`;

  if(navigator.clipboard){
    navigator.clipboard.writeText(url).catch(()=>{});
  }
  window.open(url, '_blank');
  alert('Link de precios generado y copiado al portapapeles (si el navegador lo permite).');
}

/* ==========================
   âœ… GENERAR LINK REPARTIDOR (tu URL fija)
========================== */
function buildRepartoPayloadForLink(){
  const dateISO = new Date().toISOString().split('T')[0];
  const destinations = [];

  function pushStore(code, label){
    const list = (tiendaState[code]||[]).filter(x=>Number(x.q)>0);
    if(!list.length) return;
    destinations.push({
      id: `STORE_${code.toUpperCase()}`,
      label,
      lines: list.map((x,ix)=>({ id:`${code}_${ix}`, name:x.e, qty:x.q }))
    });
  }
  pushStore('sp','ğŸª San Pablo');
  pushStore('sl','ğŸª San Lesmes');
  pushStore('st','ğŸª Santiago');

  clients.forEach(c=>{
    const rows = (c.rows||[]).filter(x=>Number(x.q)>0);
    if(!rows.length) return;
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    destinations.push({
      id: `CLIENT_${c.id.toUpperCase()}`,
      label,
      lines: rows.map((x,ix)=>({ id:`${c.id}_${ix}`, name:x.e, qty:x.q }))
    });
  });

  return { dateISO, title:"REPARTO", destinations };
}

function generarLinkRepartidor(){
  const payload = buildRepartoPayloadForLink();
  if(!payload.destinations.length){
    alert('No hay pedidos hoy (sin destinos).');
    return;
  }
  const json = JSON.stringify(payload);
  const packed = LZString.compressToEncodedURIComponent(json);

  const baseURL = "https://shaniwaris80-crypto.github.io/reparto/";
  const url = `${baseURL}?data=${packed}`;

  navigator.clipboard?.writeText(url);
  window.open(url, '_blank');
  alert('Link Repartidor generado y copiado. PÃ©galo en WhatsApp al repartidor.');
}

/* ==========================
   INIT
========================== */
(function init(){
  const savedTheme = localStorage.getItem('arslan_theme') || (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(savedTheme);

  loadVocab();      // âœ… carga + cache
  loadState();
  loadUndo();

  showTab('dic');
  idle(()=>{ buildProvBar(); unificarGlobal(); renderProvidersPanels(); renderClientsUI(); buildRepartoSelector(); rebuildPricesToday(); });
})();
</script>
</body>
</html>
