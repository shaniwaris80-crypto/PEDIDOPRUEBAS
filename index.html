<!-- ===========================
ARSLAN LISTAS v3.4 â€” INDEX ÃšNICO (MEJORADO A+B+C)
PARTE 1/3
=========================== -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff; --shadow:0 2px 8px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6; --border:#1f2937; --panel:#111827; --shadow:0 2px 10px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;color:var(--ink);background:var(--bg);margin:0;
    transition: background .2s ease, color .2s ease;
  }
  h1{font-size:18px;margin:0;color:var(--ink)}
  .topbar{
    position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
    backdrop-filter: saturate(1.2) blur(6px);
  }
  .topbar .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .theme-toggle{border:1px solid var(--border); background:var(--panel); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--bg);box-shadow:var(--shadow);margin-bottom:12px; transition: transform .12s ease}
  .card:active{transform:scale(.998)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border); position:relative; gap:8px; flex-wrap:wrap}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px; transition: opacity .2s ease, transform .1s ease}
  .btn:active{transform: translateY(1px)}
  .btn.ghost{background:var(--bg);color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:var(--bg);border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px;background:var(--bg);color:var(--ink)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em; position:sticky; top:0; background:var(--bg); z-index:1}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  [data-theme="dark"] .pill.ok{border-color:#14532d;background:#052e1a;color:#86efac}
  [data-theme="dark"] .pill.warn{border-color:#7f1d1d;background:#2b0d0d;color:#fecaca}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  [data-theme="dark"] .ac-item:hover{background:#111827}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:var(--bg);color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  [data-theme="dark"] .ok-assign{background:#052e1a;color:#86efac}
  .dup{background:#fff5f5}
  [data-theme="dark"] .dup{background:#2b0d0d}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}
  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;
  }
  .tabbar button{
    background:var(--bg);border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;
    padding:6px 8px; border-radius:10px; transition: background .15s ease, color .15s ease
  }
  .tabbar button.active{color:var(--kiwi); background:rgba(22,163,74,.08)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}

  .fab{
    position:fixed; right:14px; bottom:72px; z-index:1001;
    width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%); color:#fff; font-size:22px; box-shadow:var(--shadow)
  }
  .fab-menu{
    position:fixed; right:14px; bottom:134px; z-index:1000; display:none; flex-direction:column; gap:8px
  }
  .fab-menu .fab-item{
    border:1px solid var(--border); background:var(--bg); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow)
  }
  .fab-menu.show{display:flex}

  select{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:var(--bg);
    color:var(--ink);
    font-size:14px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}

  .price-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;border:1px solid var(--border);
    background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;border:1px solid var(--border);border-bottom-width:2px;border-radius:8px;
    padding:2px 6px;background:var(--bg);color:var(--ink)
  }
  .qty-tools{display:flex;gap:6px;align-items:center;justify-content:flex-end}
  .qty-btn{
    width:28px;height:28px;border-radius:10px;border:1px solid var(--border);
    background:var(--bg);color:var(--ink);cursor:pointer;font-weight:700
  }
  .qty-btn:active{transform:translateY(1px)}
</style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <h1>ğŸˆ ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</h1>
      <span class="pill">Modo mÃ³vil optimizado</span>
      <span class="pill">ğŸšš Reparto link: /reparto/</span>
      <span class="price-chip" title="Atajos de cantidades">
        <span class="kbd">+</span><span class="kbd">-</span>
        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
        <span class="kbd">Shift</span>=10
        <span class="kbd">Alt</span>=0,1
        <span class="kbd">1..6</span>=Prov
        <span class="kbd">Del</span>=â†©ï¸
      </span>
    </div>
    <div class="toolbar">
      <button class="btn ghost small" onclick="generarLinkRepartidor()">ğŸšš Link Repartidor</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ— Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario â†’ Tiendas/Clientes (Estandarizar) â†’ Global (Unificar/Asignar) â†’ Proveedores (TXT) â†’ Reparto â†’ PDF/WhatsApp
    </div>

    <!-- TAB: Diccionario -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>ğŸ“š Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>

            <!-- âœ… PACK C -->
            <button class="btn muted" onclick="backupAppJSON()">ğŸ’¾ Backup JSON</button>
            <button class="btn muted" onclick="restoreAppJSON()">â™»ï¸ Restaurar JSON</button>

            <button class="btn muted" onclick="limpiarDia()">ğŸ§¹ Limpiar dÃ­a</button>
            <button class="btn muted" onclick="resetAll()">ğŸ’¥ Reset total</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">
            Un producto por lÃ­nea. Se normaliza a <b>MAYÃšSCULAS</b> sin tildes. Sin duplicados.
          </div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>
    </section>

    <!-- TAB: Tiendas -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar</button>
              <button class="btn muted" onclick="focusNextRed('sp')">â›³ Siguiente rojo</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sp')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo..."></textarea>
            <div class="hint">Edita en tabla: OK=verde, Revisar=rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar</button>
              <button class="btn muted" onclick="focusNextRed('sl')">â›³ Siguiente rojo</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sl')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en tabla: OK=verde, Revisar=rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>ğŸª Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar</button>
              <button class="btn muted" onclick="focusNextRed('st')">â›³ Siguiente rojo</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('st')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en tabla: OK=verde, Revisar=rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- âœ… CLIENTES/HOTELES -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ¨ Clientes / Hoteles (con TAG)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addClient()">+ Nuevo cliente</button>
            <button class="btn muted" onclick="saveClients()">Guardar clientes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            AÃ±ade pedidos de hoteles/clientes (Braseros Centro/Forum/Edificio/Tomillares/Severo, Riviera, etc.).  
            âœ… Solo cuentan si tienen lÃ­neas. Se suman a Global/Proveedores/Reparto.
          </div>
          <div id="clients_wrap"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Global -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ§® UnificaciÃ³n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar todo</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">ğŸ“„ TXT Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            âœ… Click en fila asigna al proveedor activo. Teclas <b>1..6</b> asignan directo. <b>Del</b> devuelve a Global.
            Duplicados probables se <span class="red">marcan</span> con âš ï¸.
          </div>

          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn ghost small" onclick="undoLast()">â†©ï¸ Deshacer</button>
            <span class="pill" id="undoPill">Undo: 0</span>
          </div>

          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Proveedores -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ“¦ DistribuciÃ³n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- âœ… PRECIOS (SOLO COMPRADO/ASIGNADO) -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ’¶ Precios (solo productos comprados/asignados hoy)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="rebuildPricesToday()">ğŸ”„ Refrescar</button>
            <button class="btn small muted" onclick="exportPricesTXT()">ğŸ“„ Export precios TXT</button>
            <button class="btn small muted" onclick="resetPricesConfirm()">ğŸ§½ Reset precios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            âœ… Solo aparecen productos de pedidos por proveedor (lo â€œcompradoâ€).  
            Si NO cambias un precio, NO se toca. Si estÃ¡ vacÃ­o, se ignora.
          </div>
          <div id="prices_wrap" class="scroll-x"></div>
        </div>
      </div>

      <!-- REPARTO -->
      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>ğŸšš Reparto (tiendas + clientes)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="marcarTodoReparto(true)">âœ… Todo</button>
            <button class="btn small muted" onclick="marcarTodoReparto(false)">â¬œ Nada</button>
            <button class="btn small" onclick="enviarRepartoWhatsApp()">ğŸ“² WhatsApp</button>
            <button class="btn small muted" onclick="exportarRepartoTXT()">ğŸ“„ TXT</button>
            <button class="btn small muted" onclick="exportarRepartoPDF()">ğŸ§¾ PDF (cuadrÃ­cula)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Selecciona destino. Marca lo repartido y exporta.  
            Los precios se autocompletan desde â€œPreciosâ€ y (si falta) desde precio por proveedor.
          </div>
          <div style="margin-bottom:8px;">
            <select id="selRepartoTienda" onchange="renderRepartoTienda()"></select>
          </div>
          <div id="reparto_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- FAB Global -->
  <button class="fab" id="fab" title="Acciones rÃ¡pidas" style="display:none" onclick="toggleFabMenu()">âš™ï¸</button>
  <div class="fab-menu" id="fabMenu">
    <button class="fab-item" onclick="unificarGlobal(); toggleFabMenu(true)">ğŸ”„ Unificar</button>
    <button class="fab-item" onclick="exportarGlobalTXT(); toggleFabMenu(true)">ğŸ“„ TXT visible</button>
    <button class="fab-item" onclick="exportarGlobalXLSX(); toggleFabMenu(true)">ğŸ“Š Excel</button>
    <button class="fab-item" onclick="copiarGlobal(); toggleFabMenu(true)">ğŸ“‹ Copiar</button>
    <button class="fab-item" onclick="exportResumenGlobalTXT(); toggleFabMenu(true)">ğŸ§¾ TXT Global</button>
  </div>

  <!-- Tabbar -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">ğŸ“š<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">ğŸª<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">ğŸ§®<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">ğŸ“¦<span>Proveedores</span></button>
  </nav>

<script>
/* ==========================
   Tema (claro/oscuro) con persistencia
========================== */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  localStorage.setItem('arslan_theme', t);
}
function toggleTheme(){
  const cur = localStorage.getItem('arslan_theme') || 'light';
  applyTheme(cur==='light'?'dark':'light');
}

/* ==========================
   Debounce util + recÃ¡lculo en idle
========================== */
function debounce(fn, wait=300){
  let t=null;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), wait);
  };
}
const idle = (cb)=> (window.requestIdleCallback? requestIdleCallback(cb): setTimeout(cb, 1));

/* ==========================
   Tabs (mÃ³vil) + render diferido + limpieza
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores'];
  ids.forEach(k=>{
    document.getElementById('tab-'+k).style.display = (k===key)?'block':'none';
    document.getElementById('btn-'+k).classList.toggle('active', k===key);
  });

  const fab = document.getElementById('fab');
  if(key==='global'){ fab.style.display='block'; } else { fab.style.display='none'; toggleFabMenu(true); }

  closeAC();

  if(key==='tiendas'){ idle(()=>{ renderClientsUI(); buildRepartoSelector(); }); }
  if(key==='global'){ idle(()=>{ unificarGlobal(); buildProvBar(); }); }
  if(key==='proveedores'){ idle(()=>{ renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); rebuildPricesToday(); }); }
}

/* ==========================
   Config y utilidades
========================== */
const LS = {
  VOCAB:'arslan_v34_vocab',
  STORES:'arslan_v34_stores',
  ASSIGN:'arslan_v34_assign',
  ORDERS:'arslan_v34_orders',
  CLIENTS:'arslan_v34_clients',
  UNDO:'arslan_v34_undo',
  PRICES:'arslan_v34_prices'
};

const PROVEEDORES = ["ESMO","MONTENEGRO","ÃNGEL VACA","JOSÃ‰ ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];
const IGNORE_WORDS_UP = IGNORE_WORDS.map(x=>String(x).toUpperCase());

const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r,]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/Ã±/g,'N').replace(/Ã‘/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS_UP.includes(t));
  return tokens.join(' ').trim();
}
function num(x){
  const n = Number(String(x).replace(',','.'));
  return isNaN(n)? 0 : n;
}
function stepFromEvent(e){
  if(e && e.altKey) return 0.1;
  if(e && e.shiftKey) return 10;
  return 1;
}
function clampQty(v){
  if(!isFinite(v)) return 0;
  if(Math.abs(v) < 1e-9) return 0;
  const s = String(v);
  if(s.includes('.') || s.includes(',')){
    return Math.round(v*1000)/1000;
  }
  return v;
}

/* ==========================
   Vocabulario (CACHE en memoria + persistente)
========================== */
let VOCAB = [];
let VOCAB_KEYS = [];

function buildVocabCache(list){
  VOCAB = list.slice();
  VOCAB_KEYS = VOCAB.map(v => normKey(v));
}
function getVocab(){
  return (VOCAB && VOCAB.length) ? VOCAB : loadVocab();
}

/* ==========================
   Vocabulario RAW oficial
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
MANDARINA PLASENCIA 
MANDARINA USOPRADES 
MANZANA GRNNY SMITH 
NARANJA MESA USOPRADES
NARANJA ZUMO USOPRADES
MANZANA STORY 
GUAYABA
ROMANESCU 
PATATA AGRIA 
PATATA MONALISA
PATATA SPUNTA
CEBOLLINO
ENELDO
REMOLACHA
LECHUGA ROBLE
ESCAROLA
GUISANTES 
KIWI MARIPOSA
AGUACATE LISO
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
PERA CONFERENCIA PRIMERA BIS
REINETA PARDA
POMELO CHINO
MANDARINA TABALET
BERZA
COL DE BRUSELAS
NUECES SEGUNDA 
ESCAROLA 
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved = localStorage.getItem(LS.VOCAB);
  const base = saved && saved.trim()? saved : OFFICIAL_VOCAB_RAW;
  const list = uniqueVocab(toLines(base));
  byId('vocabTxt').value = list.join('\n');
  buildVocabCache(list);
  return list;
}

/* ==========================
   Estado global
========================== */
const tiendaState = { sp:[], sl:[], st:[] };
let globalRows = [];
let assignments = {};
let orders = {};
let ACTIVE_PROV = PROVEEDORES[0];

/* CLIENTES/HOTELES */
let clients = [];

/* PRECIOS: soporta general + por proveedor + historial */
let pricesDB = {}; 
// key -> { name, price, updatedAt, byProv:{}, history:[] }

/* ==========================
   Persistencia
========================== */
const persistState = debounce(function(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.CLIENTS, JSON.stringify(clients));
  localStorage.setItem(LS.PRICES, JSON.stringify(pricesDB));
}, 350);

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{
    const a = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}');
    assignments = a||{};
  }catch{}
  try{
    const o = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}');
    orders = o||{};
  }catch{}
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });

  try{
    const c = JSON.parse(localStorage.getItem(LS.CLIENTS)||'[]');
    clients = Array.isArray(c)? c : [];
  }catch{ clients = []; }

  try{
    const p = JSON.parse(localStorage.getItem(LS.PRICES)||'{}');
    pricesDB = p && typeof p==='object' ? p : {};
  }catch{ pricesDB = {}; }

  // âœ… Compat: asegura estructura
  Object.keys(pricesDB).forEach(k=>{
    const rec = pricesDB[k];
    if(!rec || typeof rec!=='object'){ pricesDB[k]={name:'',price:'',updatedAt:0,byProv:{},history:[]}; return; }
    rec.byProv = rec.byProv && typeof rec.byProv==='object' ? rec.byProv : {};
    rec.history = Array.isArray(rec.history) ? rec.history : [];
    if(typeof rec.price!=='string') rec.price = String(rec.price||'');
    if(!('updatedAt' in rec)) rec.updatedAt = 0;
  });
}

/* ==========================
   Reset total / Limpiar dÃ­a
========================== */
function resetAll(){
  if(!confirm('Â¿Seguro que quieres limpiar TODO (incluye vocabulario)?')) return;
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('arslan_theme');
  location.reload();
}

function limpiarDia(){
  if(!confirm('Â¿Limpiar el dÃ­a? (pone en 0 tiendas, clientes, asignaciones y pedidos. NO borra vocabulario ni precios)')) return;

  tiendaState.sp = [];
  tiendaState.sl = [];
  tiendaState.st = [];
  byId('in_sp').value = '';
  byId('in_sl').value = '';
  byId('in_st').value = '';
  byId('tbl_sp_wrap').innerHTML = '';
  byId('tbl_sl_wrap').innerHTML = '';
  byId('tbl_st_wrap').innerHTML = '';

  clients = clients.map(c=>({ ...c, input:'', rows:[] }));
  renderClientsUI();

  assignments = {};
  orders = {};
  PROVEEDORES.forEach(p=>orders[p]=[]);

  for(const k in repartoState){ delete repartoState[k]; }

  persistState();
  alert('DÃ­a limpiado. (Vocabulario, precios intactos)');
  idle(()=>{ unificarGlobal(); renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); updateUndoPill(); rebuildPricesToday(); });
}

/* ==========================
   Vocab actions
========================== */
function saveVocab(){
  const txt = byId('vocabTxt').value||'';
  localStorage.setItem(LS.VOCAB, txt);
  const list = uniqueVocab(toLines(txt));
  byId('vocabTxt').value = list.join('\n');
  buildVocabCache(list);
  alert('Vocabulario guardado.');
  renderClientsUI();
  unificarGlobal();
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por lÃ­nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt').value);
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt').value = merged.join('\n');
  saveVocab();
}

/* ==========================
   Coincidencia aproximada (Dice + TokenSet)
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser lÃ­neas (cantidad + nombre)
========================== */
function parseMaybeFraction(s){
  const m = String(s||'').match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
  if(!m) return null;
  const a = Number(m[1]), b = Number(m[2]);
  if(!b) return null;
  return a/b;
}

function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s = s.replace(/^[-â€¢*]\s*/,'');
  let qty=null, name=s;

  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  if(qty===null){
    const mf = s.match(/\b(\d+\s*\/\s*\d+)\b/);
    if(mf){
      const fr = parseMaybeFraction(mf[1]);
      if(fr!==null){ qty=fr; name=s.replace(mf[0],'').trim(); }
    }
  }

  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas|manojo|manojos|saco|sacos)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }

  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }

  if(qty===null){ qty=1; }

  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Autocomplete + historial (PACK A)
========================== */
const LS_AC = 'arslan_v34_ac_hist';
let AC_HIST = {};
try{ AC_HIST = JSON.parse(localStorage.getItem(LS_AC)||'{}') || {}; }catch{ AC_HIST = {}; }

function bumpAcHist(name){
  const k = normKey(name);
  if(!k) return;
  AC_HIST[k] = (AC_HIST[k]||0) + 1;
  localStorage.setItem(LS_AC, JSON.stringify(AC_HIST));
}
function rankSuggestions(suggestions){
  return suggestions.slice().sort((a,b)=>{
    const ha = AC_HIST[normKey(a)]||0;
    const hb = AC_HIST[normKey(b)]||0;
    if(hb!==ha) return hb-ha;
    return a.localeCompare(b,'es');
  });
}

let AC_ACTIVE = null;
let AC_OWNER = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; AC_OWNER=null; } }

document.addEventListener('click', (e)=>{
  if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==AC_OWNER){
    closeAC();
  }
}, {capture:true});

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;

    const qk = normKey(val);
    const vocab = getVocab();

    const suggestions = [];
    for(let i=0;i<vocab.length;i++){
      const vk = VOCAB_KEYS[i];
      if(vk.startsWith(qk) || vk.includes(qk)){
        suggestions.push(vocab[i]);
        if(suggestions.length>=10) break;
      }
    }

    if(!suggestions.length){
      const m = bestMatch(val, vocab);
      if(m && m.name) suggestions.push(m.name);
    }

    if(!suggestions.length) return;

    const ranked = rankSuggestions(suggestions);

    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';

    ranked.forEach((s)=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ bumpAcHist(s); onPick(s); closeAC(); };
      box.appendChild(item);
    });

    document.body.appendChild(box);
    AC_ACTIVE = box;
    AC_OWNER = cell;
  }, {passive:true});
}

/* ==========================
   âœ… Atajos cantidades (delegaciÃ³n)
========================== */
function bindQtyShortcuts(rootEl, getCellValue, setCellValue, onChanged){
  if(!rootEl) return;
  rootEl.addEventListener('keydown', (e)=>{
    const t = e.target;
    if(!t) return;
    if(!(t instanceof HTMLElement)) return;
    if(!t.isContentEditable) return;

    const f = t.dataset && t.dataset.f;
    if(f!=='q' && f!=='qty' && f!=='total') return;

    const key = e.key;
    const isPlus = (key==='+' || key==='=');
    const isMinus = (key==='-' || key==='_');
    const isUp = (key==='ArrowUp');
    const isDown = (key==='ArrowDown');
    const isEnter = (key==='Enter');

    if(isPlus || isMinus || isUp || isDown){
      e.preventDefault();
      const step = stepFromEvent(e);
      const cur = num(getCellValue(t));
      const next = clampQty(cur + ((isMinus || isDown)? -step : step));
      setCellValue(t, next);
      if(typeof onChanged==='function') onChanged(t, next);
      placeCaretAtEnd(t);
      return;
    }

    if(isEnter){
      e.preventDefault();
      focusNextEditableCell(t);
      return;
    }
  }, true);
}

function placeCaretAtEnd(el){
  try{
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch{}
}

function focusNextEditableCell(cur){
  try{
    const tr = cur.closest('tr');
    if(!tr) return;
    const table = tr.closest('table');
    if(!table) return;
    const all = Array.from(table.querySelectorAll('td[contenteditable="true"]'));
    const idx = all.indexOf(cur);
    if(idx>-1 && all[idx+1]){
      all[idx+1].focus();
      return;
    }
  }catch{}
}
</script>
<!-- ===========================
ARSLAN LISTAS v3.4 â€” INDEX ÃšNICO (MEJORADO A+B+C)
PARTE 2/3
=========================== -->
<script>
/* ==========================
   Tablas por tienda (editable + autocorrecciÃ³n)
========================== */
function buildStoreRowsFromTextarea(key){
  const txt = byId('in_'+key).value||'';
  const lines = toLines(txt);
  const vocab = getVocab();

  const rows = [];
  for(const ln of lines){
    const p = parseLine(ln);
    if(!p) continue;

    // âœ… normalizaciÃ³n + sinÃ³nimos (Gundeya -> Guindilla)
    let rawName = stripGenericWords(p.name);
    let nk = normKey(rawName);
    if(nk==='GUNDEYA') rawName = 'GUINDILLA';

    // Match exact / approx
    let match = null;
    const exactIdx = VOCAB_KEYS.indexOf(normKey(rawName));
    if(exactIdx>-1){
      match = VOCAB[exactIdx];
    }else{
      const bm = bestMatch(rawName, vocab);
      if(bm && bm.score >= 0.62) match = bm.name;
    }

    const finalName = match ? match : rawName;
    const ok = !!match;

    rows.push({
      id: 'r_'+Math.random().toString(16).slice(2),
      qty: clampQty(p.qty),
      name: removeDiacriticsUpper(finalName),
      ok,
      original: p.original
    });
  }
  return rows;
}

function estandarizar(key){
  tiendaState[key] = buildStoreRowsFromTextarea(key);
  renderStoreTable(key);
  persistState();
}
function guardarTienda(key){
  // si estÃ¡ vacÃ­o pero hay tabla, mantiene tabla. Si hay texto, reinterpreta.
  const txt = byId('in_'+key).value||'';
  if(txt.trim()){
    tiendaState[key] = buildStoreRowsFromTextarea(key);
  }
  renderStoreTable(key);
  persistState();
  alert('Guardado: ' + (key==='sp'?'San Pablo':key==='sl'?'San Lesmes':'Santiago'));
}

function focusNextRed(key){
  const wrap = byId('tbl_'+key+'_wrap');
  const reds = wrap.querySelectorAll('tr[data-ok="0"] td[data-f="name"]');
  if(reds.length){
    reds[0].focus();
    placeCaretAtEnd(reds[0]);
    reds[0].scrollIntoView({behavior:'smooth', block:'center'});
  }else{
    alert('No hay filas rojas (sin match).');
  }
}

function renderStoreTable(key){
  const wrap = byId('tbl_'+key+'_wrap');
  const rows = tiendaState[key] || [];
  if(!rows.length){
    wrap.innerHTML = '';
    return;
  }

  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th style="min-width:90px">Cant.</th>
        <th>Producto</th>
        <th style="min-width:90px">Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector('tbody');

  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;
    tr.dataset.ok = r.ok ? '1' : '0';

    if(!r.ok) tr.classList.add('dup'); // usamos estilo suave para resaltar

    tr.innerHTML = `
      <td style="white-space:nowrap">
        <div style="display:flex;gap:8px;align-items:center">
          <span contenteditable="true" data-f="q" style="min-width:48px;display:inline-block">${r.qty}</span>
          <div class="qty-tools">
            <button class="qty-btn" data-act="dec" title="-">-</button>
            <button class="qty-btn" data-act="inc" title="+">+</button>
          </div>
        </div>
      </td>
      <td contenteditable="true" data-f="name">${r.name}</td>
      <td>
        <button class="ok-assign" data-act="toggle">${r.ok?'OK âœ…':'Revisar â—'}</button>
      </td>
    `;
    tb.appendChild(tr);

    const nameCell = tr.querySelector('td[data-f="name"]');
    attachAutocomplete(nameCell, (picked)=>{
      nameCell.innerText = picked;
      r.name = removeDiacriticsUpper(picked);
      r.ok = true;
      tr.dataset.ok='1';
      tr.classList.remove('dup');
      tr.querySelector('[data-act="toggle"]').textContent = 'OK âœ…';
      persistState();
      closeAC();
    });

    tr.querySelector('[data-act="toggle"]').onclick = ()=>{
      // si es rojo, intenta forzar mejor match ahora
      const vocab = getVocab();
      const bm = bestMatch(r.name, vocab);
      if(bm && bm.score>=0.62){
        r.name = removeDiacriticsUpper(bm.name);
        nameCell.innerText = r.name;
        r.ok = true;
      }else{
        r.ok = !r.ok;
      }
      tr.dataset.ok = r.ok?'1':'0';
      tr.classList.toggle('dup', !r.ok);
      tr.querySelector('[data-act="toggle"]').textContent = r.ok?'OK âœ…':'Revisar â—';
      persistState();
    };

    tr.querySelector('[data-act="dec"]').onclick = ()=>{
      r.qty = clampQty(num(r.qty) - 1);
      tr.querySelector('[data-f="q"]').innerText = r.qty;
      persistState();
    };
    tr.querySelector('[data-act="inc"]').onclick = ()=>{
      r.qty = clampQty(num(r.qty) + 1);
      tr.querySelector('[data-f="q"]').innerText = r.qty;
      persistState();
    };

    // cambios manuales
    const qCell = tr.querySelector('[data-f="q"]');
    qCell.addEventListener('blur', ()=>{
      r.qty = clampQty(num(qCell.innerText));
      qCell.innerText = r.qty;
      persistState();
    });

    nameCell.addEventListener('blur', ()=>{
      const val = stripGenericWords(nameCell.innerText);
      if(!val){ nameCell.innerText = r.name; return; }

      // âœ… Autocompletar al corregir manualmente (PACK A)
      const vocab = getVocab();
      const exactIdx = VOCAB_KEYS.indexOf(normKey(val));
      if(exactIdx>-1){
        r.name = VOCAB[exactIdx];
        r.ok = true;
      }else{
        const bm = bestMatch(val, vocab);
        if(bm && bm.score>=0.62){
          r.name = bm.name;
          r.ok = true;
        }else{
          r.name = removeDiacriticsUpper(val);
          r.ok = false;
        }
      }
      nameCell.innerText = removeDiacriticsUpper(r.name);
      tr.dataset.ok = r.ok?'1':'0';
      tr.classList.toggle('dup', !r.ok);
      tr.querySelector('[data-act="toggle"]').textContent = r.ok?'OK âœ…':'Revisar â—';
      bumpAcHist(r.name);
      persistState();
    });
  });

  wrap.innerHTML='';
  wrap.appendChild(table);

  // âœ… atajos +/âˆ’ â†‘/â†“
  bindQtyShortcuts(
    wrap,
    (cell)=>cell.innerText,
    (cell,v)=>cell.innerText=v,
    ()=>{ persistState(); }
  );
}

/* ==========================
   Export tienda TXT / WhatsApp
========================== */
function formatListTXT(rows){
  // formato  "3 TOMATE" (sin checklist)
  return rows.map(r=>`${r.qty} ${removeDiacriticsUpper(r.name)}`).join('\n');
}
function exportarTiendaTXT(key){
  const rows = tiendaState[key]||[];
  const txt = formatListTXT(rows);
  navigator.clipboard.writeText(txt).then(()=>alert('Copiado TXT.'));
}
function enviarTiendaWhatsApp(key){
  const rows = tiendaState[key]||[];
  const name = (key==='sp'?'SAN PABLO':key==='sl'?'SAN LESMES':'SANTIAGO');
  const txt = `*${name}*\n` + formatListTXT(rows);
  const url = `https://wa.me/?text=${encodeURIComponent(txt)}`;
  window.open(url,'_blank');
}

/* ==========================
   CLIENTES/HOTELES (PACK B)
========================== */
function newClientObj(){
  return {
    id:'c_'+Math.random().toString(16).slice(2),
    name:'', tag:'',
    input:'', rows:[]
  };
}
function addClient(){
  clients.push(newClientObj());
  renderClientsUI();
  persistState();
}
function saveClients(){
  // recalcula filas de cada cliente si hay input
  clients.forEach(c=>{
    if(c.input && c.input.trim()){
      c.rows = buildClientRows(c.input);
    }
  });
  renderClientsUI();
  persistState();
  alert('Clientes guardados.');
}
function buildClientRows(text){
  const lines = toLines(text);
  const vocab = getVocab();
  const rows = [];
  for(const ln of lines){
    const p = parseLine(ln);
    if(!p) continue;
    let rawName = stripGenericWords(p.name);
    let nk = normKey(rawName);
    if(nk==='GUNDEYA') rawName='GUINDILLA';

    let match=null;
    const exactIdx = VOCAB_KEYS.indexOf(normKey(rawName));
    if(exactIdx>-1) match = VOCAB[exactIdx];
    else{
      const bm = bestMatch(rawName, vocab);
      if(bm && bm.score>=0.62) match = bm.name;
    }
    rows.push({
      id:'cr_'+Math.random().toString(16).slice(2),
      qty: clampQty(p.qty),
      name: removeDiacriticsUpper(match?match:rawName),
      ok: !!match,
      original: p.original
    });
  }
  return rows;
}

function renderClientsUI(){
  const wrap = byId('clients_wrap');
  wrap.innerHTML = '';

  if(!clients.length){
    const d = document.createElement('div');
    d.className='hint';
    d.textContent='No hay clientes aÃºn. Pulsa â€œ+ Nuevo clienteâ€.';
    wrap.appendChild(d);
    return;
  }

  clients.forEach((c, idx)=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="hd">
        <strong>ğŸ¨ Cliente ${idx+1}</strong>
        <div class="toolbar">
          <button class="btn muted small" data-act="std">Estandarizar</button>
          <button class="btn small" data-act="save">Guardar</button>
          <button class="btn muted small" data-act="del">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:8px">
          <div>
            <div class="hint">Nombre</div>
            <input data-f="name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--ink)" value="${c.name||''}" placeholder="RIVIERA / BRASEROS..." />
          </div>
          <div>
            <div class="hint">TAG (opcional)</div>
            <input data-f="tag" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--ink)" value="${c.tag||''}" placeholder="CENTRO / EDIFICIO / FORUM..." />
          </div>
        </div>
        <textarea data-f="input" placeholder="Pega pedido del cliente...">${c.input||''}</textarea>
        <div class="hint" style="margin-top:6px">Se sumarÃ¡ a Global y a Proveedores. Si estÃ¡ vacÃ­o, no cuenta.</div>
        <div data-f="tbl" class="scroll-x" style="margin-top:8px"></div>
      </div>
    `;
    wrap.appendChild(card);

    const nameI = card.querySelector('input[data-f="name"]');
    const tagI  = card.querySelector('input[data-f="tag"]');
    const txtA  = card.querySelector('textarea[data-f="input"]');
    const tblW  = card.querySelector('[data-f="tbl"]');

    nameI.oninput = ()=>{ c.name = nameI.value; persistState(); };
    tagI.oninput  = ()=>{ c.tag  = tagI.value; persistState(); };
    txtA.oninput  = debounce(()=>{ c.input = txtA.value; persistState(); }, 250);

    card.querySelector('[data-act="std"]').onclick = ()=>{
      c.rows = buildClientRows(txtA.value||'');
      renderClientTable(c, tblW);
      persistState();
    };
    card.querySelector('[data-act="save"]').onclick = ()=>{
      c.input = txtA.value||'';
      if(c.input.trim()) c.rows = buildClientRows(c.input);
      renderClientTable(c, tblW);
      persistState();
      alert('Cliente guardado.');
    };
    card.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm('Â¿Eliminar este cliente?')) return;
      clients = clients.filter(x=>x.id!==c.id);
      renderClientsUI();
      persistState();
    };

    renderClientTable(c, tblW);
  });
}

function renderClientTable(c, wrap){
  const rows = c.rows || [];
  if(!rows.length){ wrap.innerHTML=''; return; }

  const table = document.createElement('table');
  table.innerHTML = `
    <thead><tr>
      <th style="min-width:90px">Cant.</th>
      <th>Producto</th>
      <th style="min-width:90px">Estado</th>
    </tr></thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector('tbody');

  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;
    tr.dataset.ok = r.ok?'1':'0';
    if(!r.ok) tr.classList.add('dup');

    tr.innerHTML = `
      <td style="white-space:nowrap">
        <div style="display:flex;gap:8px;align-items:center">
          <span contenteditable="true" data-f="q" style="min-width:48px;display:inline-block">${r.qty}</span>
          <div class="qty-tools">
            <button class="qty-btn" data-act="dec">-</button>
            <button class="qty-btn" data-act="inc">+</button>
          </div>
        </div>
      </td>
      <td contenteditable="true" data-f="name">${r.name}</td>
      <td><button class="ok-assign" data-act="toggle">${r.ok?'OK âœ…':'Revisar â—'}</button></td>
    `;
    tb.appendChild(tr);

    const nameCell = tr.querySelector('td[data-f="name"]');
    attachAutocomplete(nameCell, (picked)=>{
      nameCell.innerText = picked;
      r.name = removeDiacriticsUpper(picked);
      r.ok = true;
      tr.dataset.ok='1';
      tr.classList.remove('dup');
      tr.querySelector('[data-act="toggle"]').textContent = 'OK âœ…';
      persistState();
      closeAC();
    });

    tr.querySelector('[data-act="toggle"]').onclick = ()=>{
      const vocab = getVocab();
      const bm = bestMatch(r.name, vocab);
      if(bm && bm.score>=0.62){
        r.name = removeDiacriticsUpper(bm.name);
        nameCell.innerText = r.name;
        r.ok = true;
      }else{
        r.ok = !r.ok;
      }
      tr.dataset.ok = r.ok?'1':'0';
      tr.classList.toggle('dup', !r.ok);
      tr.querySelector('[data-act="toggle"]').textContent = r.ok?'OK âœ…':'Revisar â—';
      persistState();
    };

    tr.querySelector('[data-act="dec"]').onclick = ()=>{
      r.qty = clampQty(num(r.qty) - 1);
      tr.querySelector('[data-f="q"]').innerText = r.qty;
      persistState();
    };
    tr.querySelector('[data-act="inc"]').onclick = ()=>{
      r.qty = clampQty(num(r.qty) + 1);
      tr.querySelector('[data-f="q"]').innerText = r.qty;
      persistState();
    };

    const qCell = tr.querySelector('[data-f="q"]');
    qCell.addEventListener('blur', ()=>{
      r.qty = clampQty(num(qCell.innerText));
      qCell.innerText = r.qty;
      persistState();
    });

    nameCell.addEventListener('blur', ()=>{
      const val = stripGenericWords(nameCell.innerText);
      if(!val){ nameCell.innerText = r.name; return; }

      const vocab = getVocab();
      const exactIdx = VOCAB_KEYS.indexOf(normKey(val));
      if(exactIdx>-1){
        r.name = VOCAB[exactIdx];
        r.ok = true;
      }else{
        const bm = bestMatch(val, vocab);
        if(bm && bm.score>=0.62){
          r.name = bm.name;
          r.ok = true;
        }else{
          r.name = removeDiacriticsUpper(val);
          r.ok = false;
        }
      }
      nameCell.innerText = removeDiacriticsUpper(r.name);
      tr.dataset.ok = r.ok?'1':'0';
      tr.classList.toggle('dup', !r.ok);
      tr.querySelector('[data-act="toggle"]').textContent = r.ok?'OK âœ…':'Revisar â—';
      bumpAcHist(r.name);
      persistState();
    });
  });

  wrap.innerHTML='';
  wrap.appendChild(table);

  bindQtyShortcuts(
    wrap,
    (cell)=>cell.innerText,
    (cell,v)=>cell.innerText=v,
    ()=>{ persistState(); }
  );
}

/* ==========================
   GLOBAL: unificar tiendas + clientes
========================== */
function collectAllRows(){
  const out = [];

  // tiendas
  ['sp','sl','st'].forEach(k=>{
    (tiendaState[k]||[]).forEach(r=>{
      if(!r.name) return;
      out.push({ source: k.toUpperCase(), qty: num(r.qty), name: removeDiacriticsUpper(r.name) });
    });
  });

  // clientes
  (clients||[]).forEach(c=>{
    if(!c) return;
    const has = (c.rows||[]).length>0;
    if(!has) return;
    const label = removeDiacriticsUpper((c.name||'CLIENTE') + (c.tag?(' â€” '+c.tag):''));
    (c.rows||[]).forEach(r=>{
      if(!r.name) return;
      out.push({ source: label, qty: num(r.qty), name: removeDiacriticsUpper(r.name) });
    });
  });

  return out;
}

function normalizeGuindilla(name){
  const nk = normKey(name);
  if(nk==='GUNDEYA') return 'GUINDILLA';
  return name;
}

/* âœ… DetecciÃ³n de duplicados probables (PACK A) */
function probableDuplicateKey(name){
  // quita palabras muy comunes, deja tokens
  return stripGenericWords(name);
}
function findProbableDuplicates(names){
  const map = new Map();
  names.forEach(n=>{
    const k = probableDuplicateKey(n);
    if(!k) return;
    const arr = map.get(k)||[];
    arr.push(n);
    map.set(k, arr);
  });
  const dups = new Set();
  map.forEach(arr=>{
    if(arr.length>1){
      // si hay varios nombres distintos para misma clave, marcar
      const uniq = Array.from(new Set(arr.map(x=>normKey(x))));
      if(uniq.length>1) arr.forEach(x=>dups.add(normKey(x)));
    }
  });
  return dups;
}

/* ==========================
   UNDO (PACK A)
========================== */
let UNDO_STACK = [];
function pushUndo(action){
  UNDO_STACK.push(action);
  if(UNDO_STACK.length>60) UNDO_STACK.shift();
  localStorage.setItem(LS.UNDO, JSON.stringify(UNDO_STACK));
  updateUndoPill();
}
function loadUndo(){
  try{
    UNDO_STACK = JSON.parse(localStorage.getItem(LS.UNDO)||'[]');
    if(!Array.isArray(UNDO_STACK)) UNDO_STACK=[];
  }catch{ UNDO_STACK=[]; }
  updateUndoPill();
}
function updateUndoPill(){
  const el = byId('undoPill');
  if(el) el.textContent = 'Undo: ' + (UNDO_STACK.length||0);
}
function undoLast(){
  const last = UNDO_STACK.pop();
  localStorage.setItem(LS.UNDO, JSON.stringify(UNDO_STACK));
  updateUndoPill();
  if(!last){ alert('Nada que deshacer'); return; }

  // acciÃ³n: {name, from, to, idx?}
  const { name, from, to } = last;
  const k = normKey(name);
  if(to==='GLOBAL'){
    // fue devuelto a GLOBAL => volver a asignar
    assignments[k] = from;
  }else{
    // fue asignado a to => volver a estado anterior
    if(from==='GLOBAL') delete assignments[k];
    else assignments[k] = from;
  }
  persistState();
  idle(()=>{ unificarGlobal(); renderProvidersPanels(); rebuildPricesToday(); });
}

/* ==========================
   Unificar global (suma + asignaciÃ³n)
========================== */
function unificarGlobal(){
  const all = collectAllRows();

  // suma por producto (nombre)
  const sum = new Map();
  all.forEach(r=>{
    let name = normalizeGuindilla(r.name);
    name = removeDiacriticsUpper(name);
    if(!name) return;
    const key = normKey(name);
    const prev = sum.get(key);
    if(!prev){
      sum.set(key, { name, qty: num(r.qty) });
    }else{
      prev.qty += num(r.qty);
    }
  });

  globalRows = Array.from(sum.values())
    .map(x=>({ name:x.name, qty: clampQty(x.qty) }))
    .sort((a,b)=>a.name.localeCompare(b.name,'es'));

  // Duplicados probables
  const dupSet = findProbableDuplicates(globalRows.map(r=>r.name));

  renderGlobalTable(dupSet);
  persistState();
  return globalRows;
}

function buildProvBar(){
  const bar = byId('provBar');
  if(!bar) return;
  bar.innerHTML='';
  PROVEEDORES.forEach((p, idx)=>{
    const b = document.createElement('button');
    b.className = 'prov-btn' + (p===ACTIVE_PROV?' active':'');
    b.textContent = (idx+1) + ' ' + p;
    b.onclick = ()=>{ ACTIVE_PROV = p; buildProvBar(); };
    bar.appendChild(b);
  });
}

function assignToProv(name, prov){
  const k = normKey(name);
  const prev = assignments[k] || 'GLOBAL';
  if(prev===prov) return;

  assignments[k] = prov;
  pushUndo({ name, from: prev, to: prov });
  persistState();
}

function returnToGlobal(name){
  const k = normKey(name);
  const prev = assignments[k] || 'GLOBAL';
  if(prev==='GLOBAL') return;

  delete assignments[k];
  pushUndo({ name, from: prev, to: 'GLOBAL' });
  persistState();
}

function renderGlobalTable(dupSet){
  const wrap = byId('global_wrap');
  if(!wrap) return;
  if(!globalRows.length){
    wrap.innerHTML = '<div class="hint">No hay productos aÃºn. Estandariza tiendas/clientes y vuelve.</div>';
    return;
  }

  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th style="min-width:90px">Cant.</th>
        <th>Producto</th>
        <th style="min-width:120px">Proveedor</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector('tbody');

  globalRows.forEach((r)=>{
    const tr = document.createElement('tr');
    const k = normKey(r.name);
    const prov = assignments[k] || 'GLOBAL';
    const isDup = dupSet && dupSet.has(k);

    if(isDup) tr.classList.add('dup');

    tr.innerHTML = `
      <td><span contenteditable="true" data-f="qty">${r.qty}</span></td>
      <td>
        <span>${r.name}</span>
        ${isDup?'<span class="flag">âš ï¸ posible duplicado</span>':''}
      </td>
      <td><span class="pill">${prov}</span></td>
    `;
    tb.appendChild(tr);

    // âœ… click asigna al proveedor activo
    tr.addEventListener('click', (e)=>{
      const tgt = e.target;
      if(tgt && tgt.getAttribute && tgt.getAttribute('contenteditable')==='true') return;
      assignToProv(r.name, ACTIVE_PROV);
      // actualiza UI rÃ¡pida
      tr.querySelector('td:nth-child(3) .pill').textContent = ACTIVE_PROV;
      idle(()=>{ renderProvidersPanels(); rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
    });

    // qty edit
    const qCell = tr.querySelector('[data-f="qty"]');
    qCell.addEventListener('blur', ()=>{
      r.qty = clampQty(num(qCell.innerText));
      qCell.innerText = r.qty;
      persistState();
      idle(()=>{ renderProvidersPanels(); rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
    });
  });

  wrap.innerHTML='';
  wrap.appendChild(table);

  bindQtyShortcuts(
    wrap,
    (cell)=>cell.innerText,
    (cell,v)=>cell.innerText=v,
    ()=>{ persistState(); }
  );

  // âœ… Teclas 1..6 y DEL en la tabla
  wrap.onkeydown = (e)=>{
    const key = e.key;
    if(key>='1' && key<='6'){
      const idx = Number(key)-1;
      const prov = PROVEEDORES[idx];
      const sel = window.getSelection();
      if(!sel || !sel.anchorNode) return;
      const tr = sel.anchorNode.nodeType===3 ? sel.anchorNode.parentElement.closest('tr') : sel.anchorNode.closest('tr');
      if(!tr) return;
      const name = tr.querySelector('td:nth-child(2) span')?.textContent || '';
      if(!name) return;
      assignToProv(name, prov);
      tr.querySelector('td:nth-child(3) .pill').textContent = prov;
      e.preventDefault();
      idle(()=>{ renderProvidersPanels(); rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
    }
    if(key==='Delete'){
      const sel = window.getSelection();
      if(!sel || !sel.anchorNode) return;
      const tr = sel.anchorNode.nodeType===3 ? sel.anchorNode.parentElement.closest('tr') : sel.anchorNode.closest('tr');
      if(!tr) return;
      const name = tr.querySelector('td:nth-child(2) span')?.textContent || '';
      if(!name) return;
      returnToGlobal(name);
      tr.querySelector('td:nth-child(3) .pill').textContent = 'GLOBAL';
      e.preventDefault();
      idle(()=>{ renderProvidersPanels(); rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
    }
  };
}

/* ==========================
   Export global
========================== */
function exportarGlobalTXT(){
  const txt = globalRows.map(r=>`${r.qty} ${r.name}`).join('\n');
  navigator.clipboard.writeText(txt).then(()=>alert('TXT global copiado.'));
}

function exportResumenGlobalTXT(){
  // TXT global por proveedor (resumen)
  const map = {};
  PROVEEDORES.forEach(p=>map[p]=[]);
  const global = [];

  globalRows.forEach(r=>{
    const k = normKey(r.name);
    const prov = assignments[k] || 'GLOBAL';
    if(prov==='GLOBAL') global.push(r);
    else map[prov].push(r);
  });

  let out = '';
  if(global.length){
    out += `GLOBAL\n` + global.map(r=>`${r.qty} ${r.name}`).join('\n') + '\n\n';
  }
  PROVEEDORES.forEach(p=>{
    const arr = map[p]||[];
    if(!arr.length) return;
    out += `${p}\n` + arr.map(r=>`${r.qty} ${r.name}`).join('\n') + '\n\n';
  });

  navigator.clipboard.writeText(out.trim()).then(()=>alert('Resumen TXT por proveedor copiado.'));
}

function copiarGlobal(){
  exportarGlobalTXT();
}

function exportarGlobalXLSX(){
  // Genera un XLSX con columnas: Producto, Cantidad, Proveedor
  const data = globalRows.map(r=>{
    const k = normKey(r.name);
    return { Producto:r.name, Cantidad:r.qty, Proveedor:(assignments[k]||'GLOBAL') };
  });
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Global');
  XLSX.writeFile(wb, 'ARSLAN_GLOBAL.xlsx');
}

/* ==========================
   FAB
========================== */
function toggleFabMenu(forceClose){
  const m = byId('fabMenu');
  if(forceClose){ m.classList.remove('show'); return; }
  m.classList.toggle('show');
}
</script>
<!-- ===========================
ARSLAN LISTAS v3.4 â€” INDEX ÃšNICO (MEJORADO A+B+C)
PARTE 3/3  âœ… (Proveedores + Precios + Reparto + Link Repartidor + INIT)
PÃ‰GALO JUSTO DESPUÃ‰S DE LA PARTE 2 (sin cerrar </script> antes)
=========================== -->
<script>
/* ==========================
   (PACK C) Autocompletado inteligente: historial + boost
========================== */
const LS_AC_HIST = 'arslan_v34_ac_hist';
let AC_HIST = {};
function loadAcHist(){
  try{
    AC_HIST = JSON.parse(localStorage.getItem(LS_AC_HIST)||'{}') || {};
  }catch{ AC_HIST = {}; }
}
function bumpAcHist(name){
  const k = normKey(name);
  if(!k) return;
  AC_HIST[k] = (AC_HIST[k]||0) + 1;
  localStorage.setItem(LS_AC_HIST, JSON.stringify(AC_HIST));
}
// override ligero: reordena sugerencias en attachAutocomplete (si existe)
(function patchAutocompleteRanking(){
  const _attach = attachAutocomplete;
  window.attachAutocomplete = function(cell, onPick){
    // llama el original, pero la lÃ³gica interna ya existe
    // aquÃ­ solo metemos â€œbumpâ€ al elegir
    _attach(cell, (picked)=>{
      bumpAcHist(picked);
      onPick(picked);
    });
  };
})();

/* ==========================
   PROVEEDORES: construir lÃ­neas desde GLOBAL asignado
========================== */
function buildOrdersFromAssignments(){
  // resetea orders segÃºn assignments y globalRows actuales
  const byProv = {};
  PROVEEDORES.forEach(p=>byProv[p]=[]);
  globalRows.forEach(r=>{
    const k = normKey(r.name);
    const prov = assignments[k];
    if(!prov || !PROVEEDORES.includes(prov)) return;
    byProv[prov].push({ name:r.name, qty: r.qty });
  });
  // ordenar por nombre
  PROVEEDORES.forEach(p=>{
    byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es'));
    orders[p] = byProv[p];
  });
  persistState();
}

function renderProvidersPanels(){
  const cont = byId('provPanels');
  if(!cont) return;

  // âœ… Siempre reconstruye desde asignaciones (para no desincronizar)
  buildOrdersFromAssignments();

  cont.innerHTML = '';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[];

    const card = document.createElement('div');
    card.className = 'card';

    const hd = document.createElement('div');
    hd.className = 'hd';
    hd.innerHTML = `
      <strong>ğŸ“¦ ${p}</strong>
      <div class="toolbar">
        <button class="btn small muted" onclick="copiarProvTXT('${p}')">ğŸ“„ Copiar TXT</button>
        <button class="btn small" onclick="enviarProvWhatsApp('${p}')">ğŸ“² WhatsApp</button>
      </div>
    `;

    const bd = document.createElement('div');
    bd.className = 'bd';

    if(!list.length){
      bd.innerHTML = `<div class="hint">Sin lÃ­neas para ${p}.</div>`;
    }else{
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th style="min-width:90px">Cant.</th>
            <th>Producto</th>
            <th style="min-width:110px">Precio</th>
            <th style="min-width:160px">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tb = table.querySelector('tbody');

      list.forEach((it)=>{
        const tr = document.createElement('tr');
        const k = normKey(it.name);
        const pr = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';

        tr.innerHTML = `
          <td><span contenteditable="true" data-f="qty">${it.qty}</span></td>
          <td><span>${it.name}</span></td>
          <td><span class="price-chip">${pr? (pr+'â‚¬') : 'â€”'}</span></td>
          <td>
            <div class="qty-tools" style="justify-content:flex-start">
              <button class="qty-btn" data-act="dec">-</button>
              <button class="qty-btn" data-act="inc">+</button>
              <button class="qty-btn" title="Devolver a Global" data-act="back">â†©ï¸</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);

        const qCell = tr.querySelector('[data-f="qty"]');
        qCell.addEventListener('blur', ()=>{
          it.qty = clampQty(num(qCell.innerText));
          qCell.innerText = it.qty;

          // cambia qty tambiÃ©n en globalRows (para coherencia)
          const gi = globalRows.findIndex(x=>normKey(x.name)===k);
          if(gi>-1) globalRows[gi].qty = it.qty;

          persistState();
          idle(()=>{ rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
        });

        tr.querySelector('[data-act="dec"]').onclick = ()=>{
          it.qty = clampQty(num(it.qty)-1);
          qCell.innerText = it.qty;
          qCell.dispatchEvent(new Event('blur'));
        };
        tr.querySelector('[data-act="inc"]').onclick = ()=>{
          it.qty = clampQty(num(it.qty)+1);
          qCell.innerText = it.qty;
          qCell.dispatchEvent(new Event('blur'));
        };
        tr.querySelector('[data-act="back"]').onclick = ()=>{
          returnToGlobal(it.name);
          idle(()=>{ unificarGlobal(); renderProvidersPanels(); rebuildPricesToday(); buildRepartoSelector(); renderRepartoTienda(); });
        };
      });

      bd.appendChild(table);

      bindQtyShortcuts(
        bd,
        (cell)=>cell.innerText,
        (cell,v)=>cell.innerText=v,
        ()=>{ persistState(); }
      );
    }

    card.appendChild(hd);
    card.appendChild(bd);
    cont.appendChild(card);
  });
}

/* ==========================
   TXT proveedor (regla ESMO) + WhatsApp
========================== */
function provTxtLines(prov){
  const list = orders[prov]||[];
  const lines = list.map(it=>{
    // âœ… regla ESMO: sin espacio entre cantidad y producto
    if(prov === 'ESMO') return `${it.qty}${it.name}`;
    return `${it.qty} ${it.name}`;
  });
  return lines;
}

function copiarProvTXT(prov){
  const txt = provTxtLines(prov).join('\n');
  navigator.clipboard.writeText(txt).then(()=>alert(`TXT ${prov} copiado.`));
}

function enviarProvWhatsApp(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay lÃ­neas.'); return; }

  // âœ… precios SOLO se muestran aquÃ­ (PACK C)
  const lines = list.map(it=>{
    const k = normKey(it.name);
    const pr = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';
    const base = (prov==='ESMO') ? `${it.qty}${it.name}` : `${it.qty} ${it.name}`;
    return pr ? `${base} â€” ${Number(pr).toFixed(2)}â‚¬` : base;
  });

  const msg = `ğŸ“¦ *Pedido ${prov}*\n\n` + lines.join('\n');
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
}

/* ==========================
   PRECIOS (solo comprado/asignado hoy)
========================== */
function getBoughtTodaySet(){
  const set = new Map();
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>{
      const k = normKey(it.name);
      if(!k) return;
      if(!set.has(k)) set.set(k, it.name);
    });
  });
  return set;
}

function rebuildPricesToday(){
  const wrap = byId('prices_wrap');
  if(!wrap) return;

  const bought = getBoughtTodaySet();
  if(!bought.size){
    wrap.innerHTML = `<div class="hint">No hay productos comprados/asignados todavÃ­a (asigna desde Global).</div>`;
    return;
  }

  // asegura existencia
  bought.forEach((name,k)=>{
    pricesDB[k] = pricesDB[k] || { name:name, price:'', updatedAt:0 };
    pricesDB[k].name = pricesDB[k].name || name;
  });

  const rows = Array.from(bought.entries()).map(([k,name])=>{
    const rec = pricesDB[k];
    return { k, name: rec.name || name, price: rec.price || '', updatedAt: rec.updatedAt || 0 };
  }).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  let html = `<div class="scroll-x"><table>
    <thead><tr><th>Producto</th><th>Precio (â‚¬)</th><th>Actualizado</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const stamp = r.updatedAt ? new Date(r.updatedAt).toLocaleString() : '';
    html += `<tr>
      <td class="green">${r.name}</td>
      <td contenteditable="true" data-f="price" data-k="${r.k}">${r.price||''}</td>
      <td class="hint">${stamp}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        focusNextEditableCell(cell);
      }
    });
    cell.addEventListener('blur', ()=>{
      const k = cell.dataset.k;
      const raw = (cell.innerText||'').trim();
      if(!k) return;

      // vacÃ­o => ignorar (no tocar)
      if(raw===''){
        cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';
        return;
      }

      const n = parseFloat(raw.replace(',','.'));
      if(isNaN(n)){
        cell.innerText = (pricesDB[k] && pricesDB[k].price) ? pricesDB[k].price : '';
        return;
      }

      const val = n.toFixed(2);
      pricesDB[k] = pricesDB[k] || { name:'', price:'', updatedAt:0 };
      pricesDB[k].price = val;
      pricesDB[k].updatedAt = Date.now();
      persistState();

      // refrescos dependientes
      idle(()=>{ renderProvidersPanels(); renderRepartoTienda(); });
    }, {passive:true});
  });

  persistState();
}

function exportPricesTXT(){
  const bought = getBoughtTodaySet();
  if(!bought.size){ alert('No hay productos de hoy.'); return; }
  const rows = [];
  bought.forEach((name,k)=>{
    const rec = pricesDB[k];
    if(rec && rec.price){
      rows.push(`${rec.name || name}\t${rec.price}â‚¬`);
    }
  });
  if(!rows.length){ alert('No hay precios guardados hoy.'); return; }
  const txt = rows.join('\n');
  navigator.clipboard.writeText(txt).then(()=>alert('Precios (hoy) copiados.'));
}

function resetPricesConfirm(){
  if(!confirm('Â¿Resetear TODOS los precios guardados?')) return;
  pricesDB = {};
  persistState();
  rebuildPricesToday();
  idle(()=>renderProvidersPanels());
  alert('Precios reseteados.');
}

/* ==========================
   REPARTO (tiendas + clientes)
========================== */
const repartoState = {}; // por destino

function getRepartoDestinations(){
  const dests = [
    { key:'sp', label:'ğŸª San Pablo', type:'store' },
    { key:'sl', label:'ğŸª San Lesmes', type:'store' },
    { key:'st', label:'ğŸª Santiago', type:'store' },
  ];
  (clients||[]).forEach(c=>{
    const has = (c.rows||[]).some(x=>num(x.qty)>0);
    if(!has) return;
    const lbl = (c.tag && c.tag.trim())
      ? `ğŸ¨ ${removeDiacriticsUpper(c.name||'CLIENTE')} â€” ${removeDiacriticsUpper(c.tag)}`
      : `ğŸ¨ ${removeDiacriticsUpper(c.name||'CLIENTE')}`;
    dests.push({ key:c.id, label:lbl, type:'client' });
  });
  return dests;
}

function buildRepartoSelector(){
  const sel = byId('selRepartoTienda');
  if(!sel) return;
  const dests = getRepartoDestinations();
  const cur = sel.value;

  sel.innerHTML =
    `<option value="">Selecciona destino...</option>` +
    dests.map(d=>`<option value="${d.key}">${d.label}</option>`).join('');

  if(cur && dests.some(d=>d.key===cur)) sel.value = cur;
}

function getRowsForDestination(code){
  if(code==='sp'||code==='sl'||code==='st'){
    return (tiendaState[code]||[]).map(r=>({ name:r.name, qty:r.qty }));
  }
  const c = (clients||[]).find(x=>x.id===code);
  if(!c) return [];
  return (c.rows||[]).map(r=>({ name:r.name, qty:r.qty }));
}

function renderRepartoTienda(){
  const sel = byId('selRepartoTienda');
  const wrap = byId('reparto_wrap');
  if(!wrap) return;

  const code = sel ? sel.value : '';
  if(!code){
    wrap.innerHTML = `<div class="hint">Selecciona un destino para ver su lista.</div>`;
    return;
  }

  const rows = getRowsForDestination(code).filter(x=>num(x.qty)>0);
  if(!rows.length){
    wrap.innerHTML = `<div class="hint">Este destino no tiene lÃ­neas.</div>`;
    return;
  }

  const prev = repartoState[code] || {};
  const next = {};

  rows.forEach(r=>{
    const k = normKey(r.name);
    const old = prev[k] || { checked:false, price:'', name:r.name, qty:r.qty };

    // autocompleta precio desde pricesDB si no hay
    let pr = old.price;
    if(!pr && pricesDB[k] && pricesDB[k].price) pr = pricesDB[k].price;

    next[k] = { name:r.name, qty:r.qty, checked:!!old.checked, price: pr || '' };
  });

  repartoState[code] = next;

  const arr = Object.values(next).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  // total seleccionado con precio
  let total = 0;
  arr.forEach(x=>{
    if(!x.checked) return;
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Seleccionados con precio: <b>${total.toFixed(2)}â‚¬</b>
    </div>
    <table>
      <thead>
        <tr>
          <th style="min-width:40px"></th>
          <th>Producto</th>
          <th style="min-width:90px">Cant.</th>
          <th style="min-width:140px">Tools</th>
          <th style="min-width:110px">Precio</th>
        </tr>
      </thead>
      <tbody>
  `;

  arr.forEach(x=>{
    const k = normKey(x.name);
    html += `
      <tr>
        <td><input type="checkbox" ${x.checked?'checked':''} onchange="toggleRepartoItem('${code}','${k}',this.checked)"></td>
        <td>${x.name}</td>
        <td class="green">${x.qty}</td>
        <td>
          <div class="qty-tools">
            <button class="qty-btn" onclick="bumpRepartoQty('${code}','${k}',-1)">-</button>
            <button class="qty-btn" onclick="bumpRepartoQty('${code}','${k}',+1)">+</button>
          </div>
        </td>
        <td contenteditable="true" data-f="price" data-k="${k}" onblur="updateRepartoPrice('${code}','${k}',this.innerText)">${x.price||''}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable][data-f="price"]').forEach(cell=>{
    cell.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        focusNextEditableCell(cell);
      }
    });
  });
}

function toggleRepartoItem(code, k, checked){
  if(!repartoState[code] || !repartoState[code][k]) return;
  repartoState[code][k].checked = !!checked;
  renderRepartoTienda();
}

function updateRepartoPrice(code, k, val){
  if(!repartoState[code] || !repartoState[code][k]) return;
  const raw = String(val||'').trim();
  if(raw===''){
    repartoState[code][k].price = '';
    renderRepartoTienda();
    return;
  }
  const n = parseFloat(raw.replace(',','.'));
  if(isNaN(n)){
    renderRepartoTienda();
    return;
  }
  const fixed = n.toFixed(2);
  repartoState[code][k].price = fixed;

  // guarda tambiÃ©n en pricesDB (PACK C)
  const name = repartoState[code][k].name;
  pricesDB[k] = pricesDB[k] || { name:name, price:'', updatedAt:0 };
  pricesDB[k].name = pricesDB[k].name || name;
  pricesDB[k].price = fixed;
  pricesDB[k].updatedAt = Date.now();

  persistState();
  idle(()=>{ rebuildPricesToday(); renderProvidersPanels(); });
  renderRepartoTienda();
}

function bumpRepartoQty(code, k, delta){
  // actualiza fuente (tienda o cliente) y luego repaint
  if(code==='sp'||code==='sl'||code==='st'){
    const idx = (tiendaState[code]||[]).findIndex(r=>normKey(r.name)===k);
    if(idx>-1){
      tiendaState[code][idx].qty = clampQty(num(tiendaState[code][idx].qty) + delta);
      persistState();
      renderStoreTable(code);
      idle(()=>unificarGlobal());
      renderRepartoTienda();
    }
    return;
  }
  const c = (clients||[]).find(x=>x.id===code);
  if(!c) return;
  const idx = (c.rows||[]).findIndex(r=>normKey(r.name)===k);
  if(idx>-1){
    c.rows[idx].qty = clampQty(num(c.rows[idx].qty) + delta);
    persistState();
    renderClientsUI();
    idle(()=>unificarGlobal());
    renderRepartoTienda();
  }
}

function marcarTodoReparto(checked){
  const code = byId('selRepartoTienda')?.value || '';
  if(!code){ alert('Selecciona un destino primero.'); return; }
  const st = repartoState[code] || {};
  Object.keys(st).forEach(k=>st[k].checked = !!checked);
  repartoState[code] = st;
  renderRepartoTienda();
}

function exportarRepartoTXT(){
  const code = byId('selRepartoTienda')?.value || '';
  if(!code){ alert('Selecciona un destino.'); return; }
  const st = repartoState[code] || {};
  const sel = Object.values(st).filter(x=>x.checked);
  if(!sel.length){ alert('No hay seleccionados.'); return; }

  const txt = sel
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x=>`${x.qty} ${x.name}${x.price?(' â€” '+x.price+'â‚¬'):''}`)
    .join('\n');

  navigator.clipboard.writeText(txt).then(()=>alert('Reparto TXT copiado.'));
}

function enviarRepartoWhatsApp(){
  const code = byId('selRepartoTienda')?.value || '';
  if(!code){ alert('Selecciona un destino.'); return; }
  const st = repartoState[code] || {};
  const sel = Object.values(st).filter(x=>x.checked);
  if(!sel.length){ alert('No hay seleccionados.'); return; }

  let total = 0;
  sel.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  let msg = `ğŸšš *Reparto ${code.toUpperCase()}*\n\n`;
  sel.sort((a,b)=>a.name.localeCompare(b.name,'es')).forEach(x=>{
    msg += `- ${x.qty} ${x.name}`;
    if(x.price) msg += ` â€” ${x.price}â‚¬`;
    msg += '\n';
  });
  msg += `\n*TOTAL:* ${total.toFixed(2)}â‚¬`;

  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
}

/* ==========================
   ğŸ§¾ PDF (cuadrÃ­cula) sin librerÃ­as externas
========================== */
function exportarRepartoPDF(){
  const code = byId('selRepartoTienda')?.value || '';
  if(!code){ alert('Selecciona un destino.'); return; }
  const st = repartoState[code] || {};
  const sel = Object.values(st).filter(x=>x.checked);
  if(!sel.length){ alert('No hay seleccionados.'); return; }

  const dt = new Date();
  const dateStr = dt.toLocaleDateString();
  const timeStr = dt.toLocaleTimeString();

  let total = 0;
  sel.forEach(x=>{
    const p = parseFloat(String(x.price||'').replace(',','.'));
    if(!isNaN(p)) total += (num(x.qty)*p);
  });

  const rowsHTML = sel
    .sort((a,b)=>a.name.localeCompare(b.name,'es'))
    .map(x=>{
      const p = x.price ? Number(x.price).toFixed(2) : '';
      const imp = x.price ? (num(x.qty)*Number(x.price)).toFixed(2) : '';
      return `<tr>
        <td>${escapeHTML(x.name)}</td>
        <td style="text-align:right">${escapeHTML(x.qty)}</td>
        <td style="text-align:right">${p?escapeHTML(p):''}</td>
        <td style="text-align:right">${imp?escapeHTML(imp):''}</td>
      </tr>`;
    }).join('');

  const w = window.open('', '_blank');
  if(!w){ alert('Popups bloqueados. Permite popups para exportar PDF.'); return; }

  w.document.open();
  w.document.write(`
    <!doctype html>
    <html lang="es">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Reparto ${escapeHTML(code.toUpperCase())}</title>
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
      <style>
        body{font-family:Poppins,system-ui,Arial;margin:24px;color:#111827}
        h1{font-size:18px;margin:0 0 6px}
        .meta{font-size:12px;color:#6b7280;margin-bottom:14px}
        .grid{width:100%;border-collapse:collapse;font-size:12px}
        .grid th,.grid td{border:1px solid #11182722;padding:6px;vertical-align:top}
        .grid th{background:#11182710;text-transform:uppercase;letter-spacing:.04em}
        .tot{margin-top:10px;font-size:12px}
        @media print{ .noPrint{display:none} }
        .noPrint{margin-bottom:12px}
        button{padding:8px 12px;border:1px solid #11182722;border-radius:10px;background:#fff;cursor:pointer}
      </style>
    </head>
    <body>
      <div class="noPrint">
        <button onclick="window.print()">ğŸ§¾ Imprimir / Guardar como PDF</button>
      </div>
      <h1>ğŸšš Reparto ${escapeHTML(code.toUpperCase())}</h1>
      <div class="meta">${escapeHTML(dateStr)} â€” ${escapeHTML(timeStr)}</div>

      <table class="grid">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Precio</th>
            <th style="text-align:right">Importe</th>
          </tr>
        </thead>
        <tbody>${rowsHTML}</tbody>
      </table>

      <div class="tot"><b>TOTAL:</b> ${total.toFixed(2)}â‚¬</div>
    </body>
    </html>
  `);
  w.document.close();
}

/* ==========================
   Escape HTML
========================== */
function escapeHTML(str){
  return String(str||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* ==========================
   LINK REPARTIDOR (payload comprimido)
========================== */
function buildRepartoPayloadForLink(){
  const dateISO = new Date().toISOString().split('T')[0];
  const destinations = [];

  function pushDestination(id, label, rows){
    const lines = rows.filter(x=>num(x.qty)>0).map((x,ix)=>({
      id: `${id}_${ix}`,
      name: removeDiacriticsUpper(x.name),
      qty: num(x.qty)
    }));
    if(!lines.length) return;
    destinations.push({ id, label, lines });
  }

  pushDestination('STORE_SP','ğŸª San Pablo', (tiendaState.sp||[]));
  pushDestination('STORE_SL','ğŸª San Lesmes', (tiendaState.sl||[]));
  pushDestination('STORE_ST','ğŸª Santiago', (tiendaState.st||[]));

  (clients||[]).forEach(c=>{
    const rows = (c.rows||[]).filter(x=>num(x.qty)>0);
    if(!rows.length) return;
    const label = (c.tag && c.tag.trim())
      ? `ğŸ¨ ${removeDiacriticsUpper(c.name||'CLIENTE')} â€” ${removeDiacriticsUpper(c.tag)}`
      : `ğŸ¨ ${removeDiacriticsUpper(c.name||'CLIENTE')}`;
    pushDestination(`CLIENT_${c.id}`, label, rows);
  });

  return { dateISO, title:"REPARTO", destinations };
}

function generarLinkRepartidor(){
  const payload = buildRepartoPayloadForLink();
  if(!payload.destinations.length){
    alert('No hay pedidos hoy (sin destinos).');
    return;
  }
  const packed = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
  const baseURL = "https://shaniwaris80-crypto.github.io/reparto/";
  const url = `${baseURL}?data=${packed}`;

  navigator.clipboard?.writeText(url);
  window.open(url, '_blank');
  alert('Link Repartidor generado y copiado.');
}

/* ==========================
   INIT (sin romper tu HTML)
========================== */
(function init(){
  // tema
  const savedTheme = localStorage.getItem('arslan_theme') || 'light';
  applyTheme(savedTheme);

  loadAcHist();

  // vocab + cache
  loadVocab();

  // estado
  loadState();

  // undo
  loadUndo();

  // UI inicial
  showTab('dic');

  idle(()=>{
    buildProvBar();
    // render si hay estado guardado
    renderStoreTable('sp');
    renderStoreTable('sl');
    renderStoreTable('st');
    renderClientsUI();

    unificarGlobal();
    renderProvidersPanels();
    buildRepartoSelector();
    rebuildPricesToday();
    renderRepartoTienda();
  });
})();
</script>
<!-- FIN PARTE 3/3 -->
