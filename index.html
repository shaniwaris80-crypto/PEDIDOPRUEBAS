<!-- ===========================
PARTE 1/3 â€” ARSLAN LISTAS v3.4 (D+E+F+H) â€” TODO EN 1 INDEX
âœ… FIX: vocab carga siempre
âœ… FIX: asignar desaparece al instante
Packs: D+E+F+H
=========================== -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS (D+E+F+H)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff; --shadow:0 2px 8px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6; --border:#1f2937; --panel:#111827; --shadow:0 2px 10px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;color:var(--ink);background:var(--bg);margin:0;
    transition: background .2s ease, color .2s ease;
  }
  h1{font-size:18px;margin:0;color:var(--ink)}
  .topbar{
    position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
    backdrop-filter: saturate(1.2) blur(6px);
    gap:10px; flex-wrap:wrap;
  }
  .topbar .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .theme-toggle{border:1px solid var(--border); background:var(--panel); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--bg);box-shadow:var(--shadow);margin-bottom:12px; transition: transform .12s ease}
  .card:active{transform:scale(.998)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border); position:relative; gap:8px; flex-wrap:wrap}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px; transition: opacity .2s ease, transform .1s ease}
  .btn:active{transform: translateY(1px)}
  .btn.ghost{background:var(--bg);color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:var(--bg);border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px;background:var(--bg);color:var(--ink)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em; position:sticky; top:0; background:var(--bg); z-index:1}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  [data-theme="dark"] .pill.ok{border-color:#14532d;background:#052e1a;color:#86efac}
  [data-theme="dark"] .pill.warn{border-color:#7f1d1d;background:#2b0d0d;color:#fecaca}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  [data-theme="dark"] .ac-item:hover{background:#111827}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:var(--bg);color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  [data-theme="dark"] .ok-assign{background:#052e1a;color:#86efac}
  .dup{background:#fff5f5}
  [data-theme="dark"] .dup{background:#2b0d0d}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}

  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;
  }
  .tabbar button{
    background:var(--bg);border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;
    padding:6px 8px; border-radius:10px; transition: background .15s ease, color .15s ease
  }
  .tabbar button.active{color:var(--kiwi); background:rgba(22,163,74,.08)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}

  .fab{
    position:fixed; right:14px; bottom:72px; z-index:1001;
    width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%); color:#fff; font-size:22px; box-shadow:var(--shadow)
  }
  .fab-menu{
    position:fixed; right:14px; bottom:134px; z-index:1000; display:none; flex-direction:column; gap:8px
  }
  .fab-menu .fab-item{
    border:1px solid var(--border); background:var(--bg); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow)
  }
  .fab-menu.show{display:flex}

  select, input{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:var(--bg);
    color:var(--ink);
    font-size:14px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}

  .price-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;border:1px solid var(--border);
    background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;border:1px solid var(--border);border-bottom-width:2px;border-radius:8px;
    padding:2px 6px;background:var(--bg);color:var(--ink)
  }
  .qty-tools{display:flex;gap:6px;align-items:center;justify-content:flex-end}
  .qty-btn{
    width:28px;height:28px;border-radius:10px;border:1px solid var(--border);
    background:var(--bg);color:var(--ink);cursor:pointer;font-weight:700
  }
  .qty-btn:active{transform:translateY(1px)}
  .mini{
    display:flex;gap:8px;align-items:center;flex-wrap:wrap
  }
  .mini .pill{cursor:pointer}

  /* Pack D: QuickAdd */
  .quickadd{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    border:1px solid var(--border); background:var(--panel); padding:8px; border-radius:14px;
  }
  .quickadd .qa-grow{flex:2; min-width:220px}
  .quickadd .qa-small{flex:1; min-width:160px}
</style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <h1>ğŸˆ ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</h1>
      <span class="pill">D+E+F+H</span>
      <span class="pill">ğŸšš Reparto link: /reparto/</span>
      <span class="price-chip" title="Atajos de cantidades">
        <span class="kbd">+</span><span class="kbd">-</span>
        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
        <span class="kbd">Shift</span>=10
        <span class="kbd">Alt</span>=0,1
        <span class="kbd">Enter</span>=siguiente
      </span>
    </div>
    <div class="toolbar">
      <button class="btn ghost small" onclick="generarLinkRepartidor()">ğŸšš Link Repartidor</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ— Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario â†’ Tiendas/Clientes â†’ Global (Asignar) â†’ Proveedores â†’ Precios (solo comprado) â†’ Reparto â†’ PDF/WhatsApp
    </div>

    <!-- Pack D: QuickAdd (escÃ¡ner) -->
    <div class="card">
      <div class="hd">
        <strong>âš¡ QuickAdd (modo escÃ¡ner)</strong>
        <div class="toolbar">
          <span class="pill ok" onclick="toggleScannerMode()" id="scanPill">ESCÃNER: ON</span>
          <button class="btn small muted" onclick="quickAddClear()">Limpiar</button>
        </div>
      </div>
      <div class="bd">
        <div class="quickadd">
          <div class="qa-small">
            <div class="hint">Destino</div>
            <select id="qa_dest" onchange="qaSyncPlaceholder()"></select>
          </div>
          <div class="qa-grow">
            <div class="hint">LÃ­nea (ej: â€œtomate rama 3kgâ€ o â€œx150 naranjasâ€)</div>
            <input id="qa_line" placeholder="Escribe y Enterâ€¦" onkeydown="qaKeydown(event)">
          </div>
          <div class="qa-small">
            <div class="hint">AcciÃ³n</div>
            <button class="btn" onclick="quickAddLine()">â• AÃ±adir</button>
          </div>
        </div>
        <div class="hint" style="margin-top:8px">
          Enter aÃ±ade y vuelve al input. Usa esto para meter pedidos sÃºper rÃ¡pido sin tocar pantallas.
        </div>
      </div>
    </div>

    <!-- TAB: Diccionario -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>ğŸ“š Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="limpiarDia()">ğŸ§¹ Limpiar dÃ­a</button>
            <button class="btn muted" onclick="resetAll()">ğŸ’¥ Reset total</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">
            Un producto por lÃ­nea. Se normaliza a <b>MAYÃšSCULAS</b> sin tildes. Sin duplicados.
          </div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>

      <!-- Pack E: Panel fuera de vocab -->
      <div class="card">
        <div class="hd">
          <strong>ğŸ§¯ Fuera de vocab (detector)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="scanOutOfVocab()">ğŸ” Escanear</button>
            <button class="btn small" onclick="addAllOutOfVocab()">â• AÃ±adir todo</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Detecta productos que aparecen en tiendas/clientes/proveedores y NO estÃ¡n en el vocab. AÃ±ade en 1 toque.
          </div>
          <div id="oov_wrap" class="scroll-x"></div>
        </div>
      </div>

      <!-- Pack E: Duplicados PRO -->
      <div class="card">
        <div class="hd">
          <strong>ğŸ§¬ Duplicados PRO</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="scanDuplicatesPro()">ğŸ§ª Escanear</button>
            <button class="btn small" onclick="mergeSelectedDuplicates()">ğŸ”— Fusionar seleccionados</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Detecta duplicados en TODA la lista global (no solo vecinos) y permite fusionar cantidades.
          </div>
          <div id="dup_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Tiendas -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sp')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo..."></textarea>
            <div class="hint">Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“). Enter baja a la siguiente celda.</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sl')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“). Enter baja a la siguiente celda.</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>ğŸª Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('st')">ğŸ“² WhatsApp</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“). Enter baja a la siguiente celda.</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- CLIENTES/HOTELES -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ¨ Clientes / Hoteles (con TAG)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addClient()">+ Nuevo cliente</button>
            <button class="btn muted" onclick="saveClients()">Guardar clientes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            AÃ±ade pedidos de hoteles/clientes. Se suman a Global/Proveedores/Reparto.
          </div>
          <div id="clients_wrap"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Global -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ§® UnificaciÃ³n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar todo</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">ğŸ“„ TXT Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            âœ… Asigna con âœ… al proveedor activo. Ahora al asignar **DESAPARECE al instante**.
          </div>

          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn ghost small" onclick="undoLast()">â†©ï¸ Deshacer</button>
            <span class="pill" id="undoPill">Undo: 0</span>
            <button class="btn small muted" onclick="applySmartOrdering()">ğŸ§¹ Ordenar (H)</button>
          </div>

          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Proveedores -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ“¦ DistribuciÃ³n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Pack F: PRECIOS PRO (POR PROVEEDOR + HISTORIAL) -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ’¶ Precios PRO (solo comprado hoy, por proveedor)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="rebuildPricesToday()">ğŸ”„ Refrescar</button>
            <button class="btn small muted" onclick="exportPricesTXT()">ğŸ“„ Export precios TXT</button>
            <button class="btn small muted" onclick="resetPricesConfirm()">ğŸ§½ Reset precios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            âœ… Sale SOLO lo comprado/asignado hoy.  
            âœ… Precio por proveedor (ESMO/MONTENEGRO/...). Guarda historial y fecha.
          </div>
          <div id="prices_wrap" class="scroll-x"></div>
        </div>
      </div>

      <!-- REPARTO -->
      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>ğŸšš Reparto (tiendas + clientes)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="marcarTodoReparto(true)">âœ… Todo</button>
            <button class="btn small muted" onclick="marcarTodoReparto(false)">â¬œ Nada</button>
            <button class="btn small" onclick="enviarRepartoWhatsApp()">ğŸ“² WhatsApp</button>
            <button class="btn small muted" onclick="exportarRepartoTXT()">ğŸ“„ TXT</button>
            <button class="btn small muted" onclick="exportarRepartoPDF()">ğŸ§¾ PDF (cuadrÃ­cula)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Marca lo repartido y exporta. Los precios se autocompletan desde â€œPrecios PROâ€.
          </div>
          <div style="margin-bottom:8px;">
            <select id="selRepartoTienda" onchange="renderRepartoTienda()"></select>
          </div>
          <div id="reparto_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- FAB Global -->
  <button class="fab" id="fab" title="Acciones rÃ¡pidas" style="display:none" onclick="toggleFabMenu()">âš™ï¸</button>
  <div class="fab-menu" id="fabMenu">
    <button class="fab-item" onclick="unificarGlobal(); toggleFabMenu(true)">ğŸ”„ Unificar</button>
    <button class="fab-item" onclick="exportarGlobalTXT(); toggleFabMenu(true)">ğŸ“„ TXT visible</button>
    <button class="fab-item" onclick="exportarGlobalXLSX(); toggleFabMenu(true)">ğŸ“Š Excel</button>
    <button class="fab-item" onclick="copiarGlobal(); toggleFabMenu(true)">ğŸ“‹ Copiar</button>
    <button class="fab-item" onclick="exportResumenGlobalTXT(); toggleFabMenu(true)">ğŸ§¾ TXT Global</button>
  </div>

  <!-- Tabbar -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">ğŸ“š<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">ğŸª<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">ğŸ§®<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">ğŸ“¦<span>Proveedores</span></button>
  </nav>

<script>
/* ==========================
   Tema (claro/oscuro) con persistencia
========================== */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  localStorage.setItem('arslan_theme', t);
}
function toggleTheme(){
  const cur = localStorage.getItem('arslan_theme') || 'light';
  applyTheme(cur==='light'?'dark':'light');
}

/* ==========================
   Debounce + idle
========================== */
function debounce(fn, wait=300){
  let t=null;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), wait);
  };
}
const idle = (cb)=> (window.requestIdleCallback? requestIdleCallback(cb): setTimeout(cb, 1));

/* ==========================
   Tabs
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores'];
  ids.forEach(k=>{
    const el = document.getElementById('tab-'+k);
    const bt = document.getElementById('btn-'+k);
    if(el) el.style.display = (k===key)?'block':'none';
    if(bt) bt.classList.toggle('active', k===key);
  });

  const fab = document.getElementById('fab');
  if(fab){
    if(key==='global'){ fab.style.display='block'; } else { fab.style.display='none'; toggleFabMenu(true); }
  }

  closeAC();

  if(key==='tiendas'){ idle(()=>{ renderClientsUI(); buildRepartoSelector(); buildQuickAddDestinations(); }); }
  if(key==='global'){ idle(()=>{ unificarGlobal(); buildProvBar(); buildQuickAddDestinations(); }); }
  if(key==='proveedores'){ idle(()=>{ renderProvidersPanels(); buildRepartoSelector(); renderRepartoTienda(); rebuildPricesToday(); buildQuickAddDestinations(); }); }
}

/* ==========================
   Config + utilidades
========================== */
const LS = {
  VOCAB:'arslan_v34_vocab',
  STORES:'arslan_v34_stores',
  ASSIGN:'arslan_v34_assign',
  ORDERS:'arslan_v34_orders',
  CLIENTS:'arslan_v34_clients',
  UNDO:'arslan_v34_undo',
  PRICES:'arslan_v34_prices_v2' // âœ… nueva estructura
};

const PROVEEDORES = ["ESMO","MONTENEGRO","ÃNGEL VACA","JOSÃ‰ ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kgs','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos','bolsa','bandeja','bdja'];
const IGNORE_WORDS_UP = IGNORE_WORDS.map(x=>String(x).toUpperCase());

const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/Ã±/g,'N').replace(/Ã‘/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS_UP.includes(t));
  return tokens.join(' ').trim();
}
function num(x){
  const n = Number(String(x).replace(',','.'));
  return isNaN(n)? 0 : n;
}
function stepFromEvent(e){
  if(e && e.altKey) return 0.1;
  if(e && e.shiftKey) return 10;
  return 1;
}
function clampQty(v){
  if(!isFinite(v)) return 0;
  if(Math.abs(v) < 1e-9) return 0;
  return Math.round(v*1000)/1000;
}

/* ==========================
   Pack H: Normalizador extra (texto sucio)
   - "tomate rama 3kg" -> qty=3, name="TOMATE RAMA"
   - "x150 naranjas" -> qty=150
========================== */
function smartPreNormalize(raw){
  let s = String(raw||'').replace(/\t/g,' ').trim();
  s = s.replace(/^[-â€¢*]\s*/,'');
  s = s.replace(/\s{2,}/g,' ');

  // separadores tipo "3kg" => "3 kg"
  s = s.replace(/(\d)(kg|kgs|kilo|kilos|uds|ud|u|caja|cajas|manojo|manojos)\b/ig, '$1 $2');
  // "x 150" o "x150"
  s = s.replace(/\b(x)\s*(\d)/ig, 'x$2');

  return s.trim();
}
</script>
<!-- ===========================
FIN PARTE 1/3
No cierres nada. Sigue PARTE 2/3 justo despuÃ©s.
=========================== -->
<!-- ===========================
PARTE 2/3 â€” SCRIPT (nÃºcleo + tablas + clientes + global + FIX asignaciÃ³n)
Pega justo despuÃ©s de PARTE 1 (sin borrar nada)
=========================== -->
<script>
/* ==========================
   Pack D: Scanner / QuickAdd
========================== */
let SCANNER_ON = true;

function toggleScannerMode(){
  SCANNER_ON = !SCANNER_ON;
  const pill = byId('scanPill');
  if(pill){
    pill.textContent = 'ESCÃNER: ' + (SCANNER_ON?'ON':'OFF');
    pill.className = 'pill ' + (SCANNER_ON?'ok':'warn');
  }
  const inp = byId('qa_line');
  if(inp) inp.focus();
}

function buildQuickAddDestinations(){
  const sel = byId('qa_dest');
  if(!sel) return;

  const dests = getRepartoDestinations(); // stores + clients con lÃ­neas
  // AÃ±adimos tambiÃ©n clientes aunque no tengan todavÃ­a lÃ­neas (por si QuickAdd crea)
  const allClients = (clients||[]).map(c=>{
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    return { key:c.id, label, type:'client' };
  });

  const base = [
    { key:'sp', label:'ğŸª San Pablo', type:'store' },
    { key:'sl', label:'ğŸª San Lesmes', type:'store' },
    { key:'st', label:'ğŸª Santiago', type:'store' },
  ];

  // merge unique
  const map = new Map();
  base.concat(allClients).concat(dests).forEach(d=>{
    if(!d || !d.key) return;
    if(!map.has(d.key)) map.set(d.key, d);
  });

  const arr = Array.from(map.values());
  const cur = sel.value || 'sp';
  sel.innerHTML = arr.map(d=>`<option value="${d.key}">${d.label}</option>`).join('');
  if(arr.some(x=>x.key===cur)) sel.value = cur;
  qaSyncPlaceholder();
}

function qaSyncPlaceholder(){
  const inp = byId('qa_line');
  if(!inp) return;
  inp.placeholder = SCANNER_ON ? 'Escanea / escribe y Enterâ€¦' : 'Escribe y Enterâ€¦';
}

function qaKeydown(e){
  if(e.key==='Enter'){
    e.preventDefault();
    quickAddLine();
  }
}

function quickAddClear(){
  const inp = byId('qa_line');
  if(inp) inp.value='';
  inp?.focus();
}

function quickAddLine(){
  const dest = (byId('qa_dest')?.value || 'sp').trim();
  const line = (byId('qa_line')?.value || '').trim();
  if(!line) return;

  const p = parseLine(line);
  if(!p || !p.name) return;

  // estandariza con vocab
  const vocab = getVocab();
  const exact = vocab.find(v=> normKey(v)===normKey(p.name));
  let chosen = exact || null;
  let needsReview = false;

  if(!chosen){
    const m = bestMatch(p.name, vocab);
    chosen = (m && m.name) ? m.name : removeDiacriticsUpper(p.name);
    needsReview = true;
  }

  const row = { o: removeDiacriticsUpper(smartPreNormalize(line)), e: chosen, q: p.qty, a: needsReview };

  // destino store
  if(dest==='sp' || dest==='sl' || dest==='st'){
    (tiendaState[dest] = tiendaState[dest] || []).push(row);
    renderTable(dest);
  }else{
    // destino client
    let c = clients.find(x=>x.id===dest);
    if(!c){
      // crea client auto si no existe
      c = { id:dest, name: removeDiacriticsUpper(dest), tag:'', input:'', rows:[] };
      clients.push(c);
      renderClientsUI();
    }
    (c.rows = c.rows || []).push(row);
    renderClientTable(c.id);
  }

  persistState();
  pushUndo({type:'quickadd', dest});
  // refrescos instantÃ¡neos
  unificarGlobal();
  buildRepartoSelector();
  renderProvidersPanels();
  rebuildPricesToday();
  buildQuickAddDestinations();

  // scanner UX
  const inp = byId('qa_line');
  if(inp){
    inp.value='';
    if(SCANNER_ON) inp.focus();
  }
}

/* ==========================
   Vocabulario (CACHE en memoria + persistente)
========================== */
let VOCAB = [];
let VOCAB_KEYS = [];

function buildVocabCache(list){
  VOCAB = list.slice();
  VOCAB_KEYS = VOCAB.map(v => normKey(v));
}
function getVocab(){
  return (VOCAB && VOCAB.length) ? VOCAB : loadVocab();
}

/* ==========================
   Vocabulario RAW oficial
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
MANDARINA PLASENCIA 
MANDARINA USOPRADES 
MANZANA GRNNY SMITH 
NARANJA MESA USOPRADES
NARANJA ZUMO USOPRADES
MANZANA STORY 
GUAYABA
ROMANESCU 
PATATA AGRIA 
PATATA MONALISA
PATATA SPUNTA
CEBOLLINO
ENELDO
REMOLACHA
LECHUGA ROBLE
ESCAROLA
GUISANTES 
KIWI MARIPOSA
AGUACATE LISO
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
PERA CONFERENCIA PRIMERA BIS
REINETA PARDA
POMELO CHINO
MANDARINA TABALET
BERZA
COL DE BRUSELAS
NUECES SEGUNDA 
ESCAROLA 
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}

function loadVocab(){
  const txtEl = byId('vocabTxt');
  const saved = localStorage.getItem(LS.VOCAB);

  // âœ… FIX VOCAB: SIEMPRE una fuente vÃ¡lida
  const base = (saved && saved.trim()) ? saved : OFFICIAL_VOCAB_RAW;

  const list = uniqueVocab(toLines(base));
  if(txtEl) txtEl.value = list.join('\n');
  buildVocabCache(list);
  return list;
}

/* ==========================
   Estado global
========================== */
const tiendaState = { sp:[], sl:[], st:[] };
let globalRows = [];
let assignments = {};
let orders = {};
let ACTIVE_PROV = PROVEEDORES[0];

let clients = []; // { id, name, tag, input, rows:[] }

/* Pack F: precios PRO v2 */
let pricesDB = {}; 
// pricesDB[normKey(product)] = { name, providers:{[prov]:{price,updatedAt}}, last:{price,updatedAt,prov} }

/* ==========================
   Persistencia
========================== */
const persistState = debounce(function(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.CLIENTS, JSON.stringify(clients));
  localStorage.setItem(LS.PRICES, JSON.stringify(pricesDB));
}, 250);

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{ assignments = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}') || {}; }catch{ assignments={}; }
  try{ orders = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}') || {}; }catch{ orders={}; }
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });

  try{ clients = JSON.parse(localStorage.getItem(LS.CLIENTS)||'[]'); if(!Array.isArray(clients)) clients=[]; }catch{ clients=[]; }

  // âœ… precios v2
  try{
    pricesDB = JSON.parse(localStorage.getItem(LS.PRICES)||'{}') || {};
    if(typeof pricesDB !== 'object' || Array.isArray(pricesDB)) pricesDB = {};
  }catch{ pricesDB = {}; }
}

/* ==========================
   Reset total / Limpiar dÃ­a
========================== */
function resetAll(){
  if(!confirm('Â¿Seguro que quieres limpiar TODO (incluye vocabulario)?')) return;
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('arslan_theme');
  location.reload();
}

function limpiarDia(){
  if(!confirm('Â¿Limpiar el dÃ­a? (tiendas, clientes, asignaciones y pedidos. NO borra vocabulario ni precios)')) return;

  tiendaState.sp = []; tiendaState.sl = []; tiendaState.st = [];
  byId('in_sp') && (byId('in_sp').value='');
  byId('in_sl') && (byId('in_sl').value='');
  byId('in_st') && (byId('in_st').value='');
  byId('tbl_sp_wrap') && (byId('tbl_sp_wrap').innerHTML='');
  byId('tbl_sl_wrap') && (byId('tbl_sl_wrap').innerHTML='');
  byId('tbl_st_wrap') && (byId('tbl_st_wrap').innerHTML='');

  clients = (clients||[]).map(c=>({ ...c, input:'', rows:[] }));

  assignments = {};
  orders = {}; PROVEEDORES.forEach(p=>orders[p]=[]);

  for(const k in repartoState){ delete repartoState[k]; }

  persistState();
  alert('DÃ­a limpiado. (Vocabulario y precios intactos)');

  // refresh instantÃ¡neo
  unificarGlobal();
  renderProvidersPanels();
  buildRepartoSelector();
  renderRepartoTienda();
  rebuildPricesToday();
  renderClientsUI();
  buildQuickAddDestinations();
}

/* ==========================
   Vocab actions
========================== */
function saveVocab(){
  const txt = (byId('vocabTxt')?.value)||'';
  localStorage.setItem(LS.VOCAB, txt);
  const list = uniqueVocab(toLines(txt));
  byId('vocabTxt') && (byId('vocabTxt').value = list.join('\n'));
  buildVocabCache(list);
  alert('Vocabulario guardado.');
  renderClientsUI();
  unificarGlobal();
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por lÃ­nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt')?.value || '');
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt') && (byId('vocabTxt').value = merged.join('\n'));
  saveVocab();
}

/* ==========================
   Coincidencia aproximada (Dice + TokenSet)
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser lÃ­neas (cantidad + nombre)
========================== */
function parseMaybeFraction(s){
  const m = String(s||'').match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
  if(!m) return null;
  const a = Number(m[1]), b = Number(m[2]);
  if(!b) return null;
  return a/b;
}

function parseLine(raw){
  if(!raw) return null;
  let s = smartPreNormalize(raw);
  let qty=null, name=s;

  // x150 / x 150
  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  // 1/2
  if(qty===null){
    const mf = s.match(/\b(\d+\s*\/\s*\d+)\b/);
    if(mf){
      const fr = parseMaybeFraction(mf[1]);
      if(fr!==null){ qty=fr; name=s.replace(mf[0],'').trim(); }
    }
  }

  // al final "150 kilos"
  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas|manojo|manojos|saco|sacos|bolsa|bandeja|bdja)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }

  // al inicio "3 tomate"
  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }

  if(qty===null){ qty=1; }
  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Autocomplete
========================== */
let AC_ACTIVE = null;
let AC_OWNER = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; AC_OWNER=null; } }

document.addEventListener('click', (e)=>{
  if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==AC_OWNER){
    closeAC();
  }
}, {capture:true});

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;

    const qk = normKey(val);
    const vocab = getVocab();

    const suggestions = [];
    for(let i=0;i<vocab.length;i++){
      const vk = VOCAB_KEYS[i];
      if(vk.startsWith(qk) || vk.includes(qk)){
        suggestions.push(vocab[i]);
        if(suggestions.length>=8) break;
      }
    }

    if(!suggestions.length){
      const m = bestMatch(val, vocab);
      if(m && m.name) suggestions.push(m.name);
    }
    if(!suggestions.length) return;

    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';

    suggestions.forEach((s)=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ onPick(s); closeAC(); };
      box.appendChild(item);
    });

    document.body.appendChild(box);
    AC_ACTIVE = box;
    AC_OWNER = cell;
  }, {passive:true});
}

/* ==========================
   Atajos cantidades (delegaciÃ³n)
========================== */
function bindQtyShortcuts(rootEl, getCellValue, setCellValue, onChanged){
  if(!rootEl) return;
  rootEl.addEventListener('keydown', (e)=>{
    const t = e.target;
    if(!t || !(t instanceof HTMLElement) || !t.isContentEditable) return;

    const f = t.dataset && t.dataset.f;
    if(f!=='q' && f!=='qty' && f!=='total') return;

    const key = e.key;
    const isPlus = (key==='+' || key==='=');
    const isMinus = (key==='-' || key==='_');
    const isUp = (key==='ArrowUp');
    const isDown = (key==='ArrowDown');
    const isEnter = (key==='Enter');

    if(isPlus || isMinus || isUp || isDown){
      e.preventDefault();
      const step = stepFromEvent(e);
      const cur = num(getCellValue(t));
      const next = clampQty(cur + ((isMinus || isDown)? -step : step));
      setCellValue(t, next);
      if(typeof onChanged==='function') onChanged(t, next);
      placeCaretAtEnd(t);
      return;
    }

    if(isEnter){
      e.preventDefault();
      focusNextEditableCell(t);
      return;
    }
  }, true);
}

function placeCaretAtEnd(el){
  try{
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch{}
}

function focusNextEditableCell(cur){
  try{
    const tr = cur.closest('tr');
    if(!tr) return;
    const table = tr.closest('table');
    if(!table) return;
    const all = Array.from(table.querySelectorAll('td[contenteditable="true"]'));
    const idx = all.indexOf(cur);
    if(idx>-1 && all[idx+1]){ all[idx+1].focus(); return; }
  }catch{}
}

/* ==========================
   Render tabla tienda
========================== */
function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap');
  const rows = tiendaState[code]||[];
  if(!wrap) return;
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td><div class="qty-tools">
        <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},-1)">-</button>
        <button class="qty-btn" onclick="bumpStoreQty('${code}',${i},+1)">+</button>
      </div></td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    tiendaState[code][i].q = num(val);
    persistState();
    pushUndo({type:'edit_store_qty', code});
    unificarGlobal();
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;

    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        tiendaState[code][i].e = picked;
        tiendaState[code][i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_store', code});
        unificarGlobal();
      });
    }

    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        tiendaState[code][i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        tiendaState[code][i].e = cleaned;
        const vocab = getVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
      pushUndo({type:'edit_store', code});
      unificarGlobal();
    }, {passive:true});
  });
}

function bumpStoreQty(code, idx, delta){
  if(!tiendaState[code] || !tiendaState[code][idx]) return;
  tiendaState[code][idx].q = clampQty(num(tiendaState[code][idx].q) + delta);
  persistState();
  pushUndo({type:'bump_store_qty', code});
  renderTable(code);
  unificarGlobal();
}

function estandarizar(code){
  const vocab = getVocab();
  const txt = byId('in_'+code)?.value || '';
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || removeDiacriticsUpper(p.name);
    rows.push({o:p.original, e:chosen, q:p.qty, a:true});
  });
  tiendaState[code] = rows;
  renderTable(code);
  persistState();
  pushUndo({type:'estandarizar_store', code});
  unificarGlobal();
  buildRepartoSelector();
  buildQuickAddDestinations();
}

function guardarTienda(code){
  const out = (tiendaState[code]||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  const el = byId('in_'+code);
  if(el) el.value = out;
  alert(`Tienda ${code.toUpperCase()} guardada en el textarea.`);
}

function exportarTiendaTXT(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${code}_estandarizado_${today}.txt`;
  a.click();
}
function enviarTiendaWhatsApp(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const msg = encodeURIComponent(`ğŸ›’ *Pedido ${code.toUpperCase()}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   CLIENTES/HOTELES
========================== */
function genId(){ return 'cli_' + Math.random().toString(16).slice(2) + Date.now().toString(16); }

function addClient(){
  const name = prompt('Nombre cliente/hotel (ej: BRASEROS / RIVIERA / HOTEL CORDON):');
  if(!name) return;
  const tag = prompt('TAG / Sede (ej: CENTRO, FORUM, EDIFICIO, TOMILLARES, SEVERO, GENERAL):') || '';
  clients.push({ id: genId(), name: removeDiacriticsUpper(name), tag: removeDiacriticsUpper(tag), input:'', rows:[] });
  persistState();
  renderClientsUI();
  buildQuickAddDestinations();
}

function saveClients(){
  persistState();
  alert('Clientes guardados.');
  unificarGlobal();
  buildRepartoSelector();
  buildQuickAddDestinations();
}

function deleteClient(id){
  if(!confirm('Â¿Eliminar este cliente?')) return;
  clients = clients.filter(c=>c.id!==id);
  persistState();
  renderClientsUI();
  unificarGlobal();
  buildRepartoSelector();
  buildQuickAddDestinations();
}

function updateClientField(id, field, value){
  const idx = clients.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(field==='name') clients[idx].name = removeDiacriticsUpper(value);
  if(field==='tag') clients[idx].tag = removeDiacriticsUpper(value);
  persistState();
  buildRepartoSelector();
  buildQuickAddDestinations();
  unificarGlobal();
}

function renderClientsUI(){
  const wrap = byId('clients_wrap');
  if(!wrap) return;

  if(!clients.length){
    wrap.innerHTML = `<div class="hint">No hay clientes aÃºn. Pulsa â€œ+ Nuevo clienteâ€.</div>`;
    return;
  }

  let html = '';
  clients.forEach((c)=>{
    const label = c.tag ? `${c.name} â€” ${c.tag}` : c.name;
    html += `
      <div class="card" style="margin-bottom:10px">
        <div class="hd">
          <strong>ğŸ¨ ${label}</strong>
          <div class="toolbar">
            <button class="btn small ghost" onclick="estandarizarCliente('${c.id}')">Estandarizar</button>
            <button class="btn small" onclick="guardarCliente('${c.id}')">Guardar</button>
            <button class="btn small muted" onclick="exportarClienteTXT('${c.id}')">TXT</button>
            <button class="btn small muted" onclick="enviarClienteWhatsApp('${c.id}')">WhatsApp</button>
            <button class="btn small muted" onclick="deleteClient('${c.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <div>
              <div class="hint">Nombre</div>
              <input value="${c.name||''}" onblur="updateClientField('${c.id}','name',this.value)">
            </div>
            <div>
              <div class="hint">TAG</div>
              <input value="${c.tag||''}" onblur="updateClientField('${c.id}','tag',this.value)">
            </div>
          </div>
          <textarea id="in_${c.id}" placeholder="Pega pedido cliente/hotel...">${c.input||''}</textarea>
          <div class="hint">Cantidades con teclado (+/-/â†‘/â†“) y Enter siguiente celda.</div>
          <div id="tbl_${c.id}_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    `;
  });

  wrap.innerHTML = html;

  clients.forEach(c=>{
    if(Array.isArray(c.rows) && c.rows.length){
      renderClientTable(c.id);
    }
  });
}

function renderClientTable(id){
  const wrap = byId('tbl_'+id+'_wrap');
  const c = clients.find(x=>x.id===id);
  if(!wrap || !c) return;
  const rows = c.rows||[];
  if(!rows.length){ wrap.innerHTML=''; return; }

  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Tools</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td><div class="qty-tools">
        <button class="qty-btn" onclick="bumpClientQty('${id}',${i},-1)">-</button>
        <button class="qty-btn" onclick="bumpClientQty('${id}',${i},+1)">+</button>
      </div></td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  bindQtyShortcuts(wrap, (cell)=>cell.innerText, (cell,val)=>{ cell.innerText = val; }, (cell,val)=>{
    const i = Number(cell.dataset.i);
    c.rows[i].q = num(val);
    persistState();
    pushUndo({type:'edit_client_qty', id});
    unificarGlobal();
  });

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;

    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        c.rows[i].e = picked;
        c.rows[i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
        pushUndo({type:'edit_client', id});
        unificarGlobal();
      });
    }

    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        c.rows[i].q = num(val)||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        c.rows[i].e = cleaned;
        const vocab = getVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ c.rows[i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { c.rows[i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
      pushUndo({type:'edit_client', id});
      unificarGlobal();
    }, {passive:true});
  });
}

function bumpClientQty(id, idx, delta){
  const c = clients.find(x=>x.id===id);
  if(!c || !c.rows || !c.rows[idx]) return;
  c.rows[idx].q = clampQty(num(c.rows[idx].q) + delta);
  persistState();
  pushUndo({type:'bump_client_qty', id});
  renderClientTable(id);
  unificarGlobal();
}

function estandarizarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const txt = byId('in_'+id)?.value || '';
  c.input = txt;

  const vocab = getVocab();
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || removeDiacriticsUpper(p.name);
    rows.push({o:p.original, e:chosen, q:p.qty, a:true});
  });

  c.rows = rows;
  renderClientTable(id);
  persistState();
  pushUndo({type:'estandarizar_client', id});
  unificarGlobal();
  buildRepartoSelector();
  buildQuickAddDestinations();
}

function guardarCliente(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const out = (c.rows||[]).map(r=> `${r.e} ${r.q}`).join('\n');
  const el = byId('in_'+id);
  if(el) el.value = out;
  c.input = out;
  persistState();
  alert('Cliente guardado.');
}

function exportarClienteTXT(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const label = (c.tag? `${c.name}_${c.tag}`:c.name).replace(/\s+/g,'_');
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cliente_${label}_${today}.txt`;
  a.click();
}

function enviarClienteWhatsApp(id){
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const tienda = c.rows || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('AÃºn hay productos por revisar (en rojo).'); return; }
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const label = c.tag? `${c.name} â€” ${c.tag}`:c.name;
  const msg = encodeURIComponent(`ğŸ¨ *Pedido ${label}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   Pack E: Fuera de Vocab (detector + aÃ±adir)
========================== */
function collectAllNamesInSystem(){
  const set = new Map(); // key -> name
  function addName(name){
    const k = normKey(name);
    if(!k) return;
    if(!set.has(k)) set.set(k, removeDiacriticsUpper(name));
  }

  // tiendas
  ['sp','sl','st'].forEach(code=>{
    (tiendaState[code]||[]).forEach(r=>addName(r.e));
  });

  // clientes
  (clients||[]).forEach(c=>{
    (c.rows||[]).forEach(r=>addName(r.e));
  });

  // proveedores
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(it=>addName(it.name));
  });

  return set;
}

let OOV_CACHE = []; // [{k,name,checked}]
function scanOutOfVocab(){
  const wrap = byId('oov_wrap');
  if(!wrap) return;

  const vocab = getVocab();
  const vocabSet = new Set(vocab.map(v=>normKey(v)));
  const all = collectAllNamesInSystem();

  const out = [];
  all.forEach((name,k)=>{
    if(!vocabSet.has(k)){
      out.push({k, name, checked:true});
    }
  });

  OOV_CACHE = out.sort((a,b)=>a.name.localeCompare(b.name,'es'));

  if(!OOV_CACHE.length){
    wrap.innerHTML = `<div class="hint">âœ… Todo estÃ¡ dentro del vocabulario.</div>`;
    return;
  }

  let html = `<div class="scroll-x"><table>
    <thead><tr><th></th><th>Producto fuera de vocab</th></tr></thead><tbody>`;
  OOV_CACHE.forEach((r,i)=>{
    html += `<tr>
      <td><input type="checkbox" ${r.checked?'checked':''} onchange="toggleOOV(${i},this.checked)"></td>
      <td>${r.name}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;
}

function toggleOOV(i, val){
  if(!OOV_CACHE[i]) return;
  OOV_CACHE[i].checked = !!val;
}

function addAllOutOfVocab(){
  if(!OOV_CACHE.length) scanOutOfVocab();
  const sel = OOV_CACHE.filter(x=>x.checked).map(x=>x.name);
  if(!sel.length){ alert('No hay seleccionados.'); return; }

  const current = toLines(byId('vocabTxt')?.value || '');
  const merged = uniqueVocab(current.concat(sel));
  byId('vocabTxt') && (byId('vocabTxt').value = merged.join('\n'));
  saveVocab();

  alert('AÃ±adidos al vocabulario: ' + sel.length);
  scanOutOfVocab();
}

/* ==========================
   Pack E: Duplicados PRO (scanner + merge)
========================== */
let DUP_PAIRS = []; // [{a:{k,name,qty}, b:{k,name,qty}, score, checked}]
function scanDuplicatesPro(){
  const wrap = byId('dup_wrap');
  if(!wrap) return;

  // generar mapa total unificado
  const all = getAllRowsUnified();
  const map = new Map();
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!k) return;
    if(!map.has(k)) map.set(k, {k, name:r.e, qty:0});
    map.get(k).qty += (Number(r.q)||0);
  });

  const arr = Array.from(map.values()).sort((x,y)=>x.name.localeCompare(y.name,'es'));
  const pairs = [];

  // O(n^2) limitado por ventana + primer token (rÃ¡pido)
  for(let i=0;i<arr.length;i++){
    const a = arr[i];
    const aTok = stripGenericWords(a.name).split(' ')[0] || '';
    for(let j=i+1;j<Math.min(i+40, arr.length);j++){
      const b = arr[j];
      const bTok = stripGenericWords(b.name).split(' ')[0] || '';
      if(aTok && bTok && aTok!==bTok) continue;

      const sc = similarityScore(a.name, b.name);
      if(sc>=0.90 && a.k!==b.k){
        pairs.push({ a, b, score: sc, checked:true });
      }
    }
  }

  DUP_PAIRS = pairs;

  if(!pairs.length){
    wrap.innerHTML = `<div class="hint">âœ… No se detectaron duplicados PRO.</div>`;
    return;
  }

  let html = `<div class="scroll-x"><table>
    <thead><tr><th></th><th>Nombre A</th><th>Qty A</th><th>Nombre B</th><th>Qty B</th><th>Score</th></tr></thead><tbody>`;
  pairs.forEach((p,idx)=>{
    html += `<tr>
      <td><input type="checkbox" ${p.checked?'checked':''} onchange="toggleDupPair(${idx},this.checked)"></td>
      <td>${p.a.name}</td>
      <td style="text-align:right">${p.a.qty}</td>
      <td>${p.b.name}</td>
      <td style="text-align:right">${p.b.qty}</td>
      <td style="text-align:right">${p.score.toFixed(2)}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  wrap.innerHTML = html;
}

function toggleDupPair(i,val){
  if(!DUP_PAIRS[i]) return;
  DUP_PAIRS[i].checked = !!val;
}

function mergeSelectedDuplicates(){
  const sel = (DUP_PAIRS||[]).filter(x=>x.checked);
  if(!sel.length){ alert('No hay pares seleccionados.'); return; }

  // regla: fusiona B dentro de A (mantiene el nombre A)
  // aplicamos sobre tiendas + clientes + proveedores + asignaciones
  function replaceEverywhere(fromKey, toName){
    const toKey = normKey(toName);

    // tiendas
    ['sp','sl','st'].forEach(code=>{
      (tiendaState[code]||[]).forEach(r=>{
        if(normKey(r.e)===fromKey) r.e = toName;
      });
    });

    // clientes
    (clients||[]).forEach(c=>{
      (c.rows||[]).forEach(r=>{
        if(normKey(r.e)===fromKey) r.e = toName;
      });
    });

    // proveedores
    PROVEEDORES.forEach(p=>{
      (orders[p]||[]).forEach(it=>{
        if(normKey(it.name)===fromKey) it.name = toName;
      });
    });

    // asignaciones: mueve si existÃ­a
    if(assignments[fromKey]){
      if(!assignments[toKey]) assignments[toKey] = assignments[fromKey];
      delete assignments[fromKey];
    }

    // precios: mueve registro
    if(pricesDB[fromKey]){
      if(!pricesDB[toKey]) pricesDB[toKey] = pricesDB[fromKey];
      delete pricesDB[fromKey];
    }
  }

  pushUndo({type:'merge_dups', n:sel.length});

  sel.forEach(p=>{
    replaceEverywhere(p.b.k, p.a.name);
  });

  persistState();
  renderTable('sp'); renderTable('sl'); renderTable('st');
  renderClientsUI();
  renderProvidersPanels();
  rebuildPricesToday();
  unificarGlobal();

  alert('Fusionados: ' + sel.length + ' pares.');
  scanDuplicatesPro();
}

/* ==========================
   Global unify helpers
========================== */
function getAllRowsUnified(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const clientRows = [];
  (clients||[]).forEach(c=>{
    (c.rows||[]).forEach(r=>clientRows.push(r));
  });
  return all.concat(clientRows);
}
</script>
<!-- ===========================
FIN PARTE 2/3
Ahora dime: OK PARTE 3
y te doy la Ãºltima (UNDO + GLOBAL + PROVEEDORES + PRECIOS PRO + REPARTO + INIT)
=========================== -->
<!-- ===========================
PARTE 3/3 â€” GLOBAL + PROVEEDORES + PRECIOS PRO + REPARTO + UNDO + INIT
Pega justo despuÃ©s de PARTE 2 (sin borrar nada)
=========================== -->
<script>
/* ==========================
   UNDO (Pack H)
========================== */
let UNDO_STACK = [];
const UNDO_MAX = 40;

function pushUndo(meta){
  try{
    const snap = {
      meta: meta||{},
      stores: JSON.parse(JSON.stringify(tiendaState)),
      clients: JSON.parse(JSON.stringify(clients)),
      assign: JSON.parse(JSON.stringify(assignments)),
      orders: JSON.parse(JSON.stringify(orders)),
      prices: JSON.parse(JSON.stringify(pricesDB)),
      reparto: JSON.parse(JSON.stringify(repartoState)),
      active: ACTIVE_PROV
    };
    UNDO_STACK.push(snap);
    if(UNDO_STACK.length > UNDO_MAX) UNDO_STACK.shift();
    const pill = byId('undoPill');
    if(pill) pill.textContent = `UNDO: ${UNDO_STACK.length}`;
  }catch{}
}

function undo(){
  if(!UNDO_STACK.length){ alert('No hay acciones para deshacer.'); return; }
  const last = UNDO_STACK.pop();
  try{
    // restaurar
    ['sp','sl','st'].forEach(k=>{
      tiendaState[k] = Array.isArray(last.stores?.[k]) ? last.stores[k] : [];
    });
    clients = Array.isArray(last.clients) ? last.clients : [];
    assignments = last.assign || {};
    orders = last.orders || {};
    pricesDB = last.prices || {};
    repartoState = last.reparto || {};

    ACTIVE_PROV = last.active || PROVEEDORES[0];

    // render total
    renderTable('sp'); renderTable('sl'); renderTable('st');
    renderClientsUI();
    unificarGlobal();
    renderProvidersPanels();
    buildRepartoSelector();
    renderRepartoTienda();
    rebuildPricesToday();
    buildQuickAddDestinations();

    persistState();
    const pill = byId('undoPill');
    if(pill) pill.textContent = `UNDO: ${UNDO_STACK.length}`;
  }catch(e){
    console.error(e);
    alert('Error al deshacer.');
  }
}

/* ==========================
   Global consolidado
========================== */
function unificarGlobal(){
  const wrap = byId('global_wrap');
  if(!wrap) return;

  const all = getAllRowsUnified();

  // Consolidar por estandarizado
  const map = new Map();
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!k) return;
    if(!map.has(k)) map.set(k, { e: removeDiacriticsUpper(r.e), q:0, a:false });
    const cur = map.get(k);
    cur.q += num(r.q);
    cur.a = cur.a || !!r.a;
  });

  globalRows = Array.from(map.values())
    .sort((x,y)=> x.e.localeCompare(y.e,'es'));

  if(!globalRows.length){
    wrap.innerHTML = `<div class="hint">AÃºn no hay productos estandarizados.</div>`;
    return;
  }

  let html = `<div class="scroll-x"><table>
    <thead><tr><th>Producto</th><th>Total</th><th>AsignaciÃ³n</th><th>AcciÃ³n</th></tr></thead><tbody>`;

  globalRows.forEach(r=>{
    const k = normKey(r.e);
    const prov = assignments[k] || '';
    const warn = r.a ? ' class="red"' : '';
    html += `<tr${warn}>
      <td>${r.e}</td>
      <td style="text-align:right" data-k="${k}" data-f="total" contenteditable="true">${roundNice(r.q)}</td>
      <td>
        <select data-k="${k}" onchange="assignProvider(this.dataset.k, this.value)">
          <option value="">â€”</option>
          ${PROVEEDORES.map(p=>`<option value="${p}" ${p===prov?'selected':''}>${p}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn small" onclick="enviarAProveedor('${k}')">Asignar</button></td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  wrap.innerHTML = html;

  // atajos qty
  bindQtyShortcuts(wrap,
    (cell)=>cell.innerText,
    (cell,val)=>{ cell.innerText = val; },
    (cell,val)=>{
      const k = cell.dataset.k;
      updateGlobalQtyByKey(k, num(val));
    }
  );

  // blur para ediciÃ³n qty global
  wrap.querySelectorAll('td[contenteditable="true"][data-f="total"]').forEach(cell=>{
    cell.addEventListener('blur', ()=>{
      const k = cell.dataset.k;
      updateGlobalQtyByKey(k, num(cell.innerText));
    }, {passive:true});
  });

  // actualizar pill
  const n = globalRows.length;
  const pill = byId('globalPill');
  if(pill) pill.textContent = `GLOBAL: ${n}`;
}

function updateGlobalQtyByKey(k, newQty){
  // Ajusta proporcionalmente en origen NO (serÃ­a complejo).
  // AquÃ­ sÃ³lo afecta la asignaciÃ³n al proveedor, manteniendo global como "override" temporal:
  // Creamos/actualizamos override por key y lo aplicamos al enviar a proveedor.
  if(!k) return;
  newQty = clampQty(newQty);

  // guardamos override en assignments meta
  assignments.__override = assignments.__override || {};
  assignments.__override[k] = newQty;

  persistState();
  pushUndo({type:'global_override', k});
  renderProvidersPanels();
  rebuildPricesToday();
}

function getEffectiveGlobalQty(k, fallback){
  const ov = assignments?.__override?.[k];
  if(ov===0 || ov) return num(ov);
  return num(fallback);
}

/* ==========================
   AsignaciÃ³n a proveedor (FIX: al asignar desaparece de "sin asignar")
========================== */
function assignProvider(k, prov){
  if(!k) return;
  if(!prov){
    delete assignments[k];
  }else{
    assignments[k] = prov;
  }
  persistState();
  pushUndo({type:'assign_provider', k});
  renderProvidersPanels();
  buildRepartoSelector();
  rebuildPricesToday();
}

function enviarAProveedor(k){
  const row = globalRows.find(r=> normKey(r.e)===k );
  if(!row){ alert('No encontrado.'); return; }

  const prov = assignments[k] || '';
  if(!prov){ alert('Selecciona proveedor primero.'); return; }

  // qty efectiva (con override)
  const qEff = getEffectiveGlobalQty(k, row.q);

  const item = { name: row.e, qty: qEff, done:false, assignedAt: Date.now() };

  // âœ… insertar/merge por producto
  orders[prov] = orders[prov] || [];
  const idx = orders[prov].findIndex(x=> normKey(x.name)===k );
  if(idx>-1){
    orders[prov][idx].qty = qEff;
    orders[prov][idx].done = false;
    orders[prov][idx].assignedAt = Date.now();
  }else{
    orders[prov].push(item);
  }

  // âœ… FIX: si estaba en "sin asignar" visualmente, ya no debe aparecer ahÃ­
  // (nuestro render usa assignments + orders, asÃ­ que sÃ³lo refrescamos)
  persistState();
  pushUndo({type:'send_to_provider', k, prov});
  renderProvidersPanels();
  buildRepartoSelector();
  rebuildPricesToday();
}

/* ==========================
   Panel Proveedores
========================== */
function renderProvidersPanels(){
  const wrap = byId('providers_wrap');
  if(!wrap) return;

  let html = '';
  PROVEEDORES.forEach(p=>{
    const items = (orders[p]||[]).slice().sort((a,b)=> a.name.localeCompare(b.name,'es'));
    const total = items.reduce((s,x)=>s+num(x.qty),0);

    html += `
      <div class="card" style="margin-bottom:10px">
        <div class="hd">
          <strong>ğŸšš ${p}</strong>
          <div class="toolbar">
            <button class="btn small ghost" onclick="setActiveProv('${p}')">Ver</button>
            <button class="btn small muted" onclick="exportProvTXT('${p}')">TXT</button>
            <button class="btn small muted" onclick="sendProvWA('${p}')">WhatsApp</button>
            <button class="btn small muted" onclick="markAllDone('${p}')">âœ… Todo</button>
            <button class="btn small muted" onclick="clearProv('${p}')">ğŸ§¹</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <div class="pill">${items.length} Ã­tems</div>
            <div class="pill">Î£ qty: ${roundNice(total)}</div>
          </div>
          <div id="prov_${cssSafe(p)}"></div>
        </div>
      </div>
    `;
  });

  wrap.innerHTML = html;

  PROVEEDORES.forEach(p=> renderProvTable(p));
}

function setActiveProv(p){
  ACTIVE_PROV = p;
  persistState();
  const t = byId('activeProvTitle');
  if(t) t.textContent = `Proveedor activo: ${p}`;
  renderPriceProviderSelect();
  rebuildPricesToday();
}

function renderProvTable(p){
  const host = byId('prov_'+cssSafe(p));
  if(!host) return;
  const items = (orders[p]||[]);

  if(!items.length){
    host.innerHTML = `<div class="hint">Sin Ã­tems.</div>`;
    return;
  }

  let html = `<div class="scroll-x"><table>
  <thead><tr><th>Done</th><th>Qty</th><th>Producto</th><th>Tools</th></tr></thead><tbody>`;
  items.forEach((it,i)=>{
    html += `<tr class="${it.done?'done':''}">
      <td style="text-align:center"><input type="checkbox" ${it.done?'checked':''} onchange="toggleDone('${p}',${i},this.checked)"></td>
      <td contenteditable="true" data-p="${p}" data-i="${i}" data-f="qty">${roundNice(it.qty)}</td>
      <td contenteditable="true" data-p="${p}" data-i="${i}" data-f="name">${it.name}</td>
      <td><div class="qty-tools">
        <button class="qty-btn" onclick="bumpProvQty('${p}',${i},-1)">-</button>
        <button class="qty-btn" onclick="bumpProvQty('${p}',${i},+1)">+</button>
        <button class="qty-btn" onclick="delProvItem('${p}',${i})">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  host.innerHTML = html;

  bindQtyShortcuts(host,
    (cell)=>cell.innerText,
    (cell,val)=>{ cell.innerText = val; },
    (cell,val)=>{
      const pp = cell.dataset.p;
      const i = Number(cell.dataset.i);
      if(!orders[pp] || !orders[pp][i]) return;
      orders[pp][i].qty = clampQty(num(val));
      persistState();
      pushUndo({type:'edit_prov_qty', pp});
      rebuildPricesToday();
      buildRepartoSelector();
      renderRepartoTienda();
    }
  );

  host.querySelectorAll('td[contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', ()=>{
      const pp = cell.dataset.p;
      const i = Number(cell.dataset.i);
      const f = cell.dataset.f;
      if(!orders[pp] || !orders[pp][i]) return;

      if(f==='qty'){
        orders[pp][i].qty = clampQty(num(cell.innerText));
      }else{
        const newName = removeDiacriticsUpper(cell.innerText);
        orders[pp][i].name = newName;
      }
      persistState();
      pushUndo({type:'edit_prov_cell', pp});
      rebuildPricesToday();
      buildRepartoSelector();
      renderRepartoTienda();
    }, {passive:true});
  });
}

function toggleDone(p, i, val){
  if(!orders[p] || !orders[p][i]) return;
  orders[p][i].done = !!val;
  persistState();
  pushUndo({type:'toggle_done', p});
  renderProvTable(p);
  buildRepartoSelector();
  renderRepartoTienda();
}
function bumpProvQty(p,i,delta){
  if(!orders[p] || !orders[p][i]) return;
  orders[p][i].qty = clampQty(num(orders[p][i].qty) + delta);
  persistState();
  pushUndo({type:'bump_prov_qty', p});
  renderProvTable(p);
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}
function delProvItem(p,i){
  if(!orders[p] || !orders[p][i]) return;
  if(!confirm('Â¿Eliminar este Ã­tem del proveedor?')) return;
  orders[p].splice(i,1);
  persistState();
  pushUndo({type:'del_prov_item', p});
  renderProvTable(p);
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}
function markAllDone(p){
  if(!orders[p] || !orders[p].length) return;
  orders[p].forEach(x=>x.done=true);
  persistState();
  pushUndo({type:'mark_all_done', p});
  renderProvTable(p);
  buildRepartoSelector();
  renderRepartoTienda();
}
function clearProv(p){
  if(!confirm(`Â¿Vaciar lista de ${p}?`)) return;
  orders[p] = [];
  persistState();
  pushUndo({type:'clear_prov', p});
  renderProvTable(p);
  rebuildPricesToday();
  buildRepartoSelector();
  renderRepartoTienda();
}

function provText(p){
  const arr = (orders[p]||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'es'));
  // regla ESMO: sin espacio tras cantidad
  if(String(p).toUpperCase()==='ESMO'){
    return arr.map(x=> `${roundNice(x.qty)}${x.name}`).join('\n');
  }
  return arr.map(x=> `${roundNice(x.qty)} ${x.name}`).join('\n');
}

function exportProvTXT(p){
  const txt = provText(p);
  if(!txt.trim()){ alert('VacÃ­o.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `pedido_${p}_${today}.txt`;
  a.click();
}
function sendProvWA(p){
  const txt = provText(p);
  if(!txt.trim()){ alert('VacÃ­o.'); return; }
  const msg = encodeURIComponent(`ğŸšš *${p}*\n\n${txt}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* ==========================
   PRECIOS PRO (Pack F)
   - precios sÃ³lo en lista de precios
   - por proveedor
========================== */
function getPriceRecord(productName){
  const k = normKey(productName);
  return pricesDB[k] || null;
}

function ensurePriceRecord(productName){
  const k = normKey(productName);
  if(!pricesDB[k]){
    pricesDB[k] = { name: removeDiacriticsUpper(productName), providers:{}, last:null };
  }
  return pricesDB[k];
}

function setProviderPrice(productName, provider, price){
  const rec = ensurePriceRecord(productName);
  rec.name = removeDiacriticsUpper(productName);
  rec.providers = rec.providers || {};
  rec.providers[provider] = { price: num(price), updatedAt: Date.now() };
  rec.last = { price: num(price), updatedAt: Date.now(), prov: provider };
  persistState();
  pushUndo({type:'set_price', provider});
}

function renderPriceProviderSelect(){
  const sel = byId('priceProvSel');
  if(!sel) return;
  const cur = ACTIVE_PROV || PROVEEDORES[0];
  sel.innerHTML = PROVEEDORES.map(p=>`<option value="${p}" ${p===cur?'selected':''}>${p}</option>`).join('');
  sel.value = cur;
}

function onChangePriceProvider(){
  const sel = byId('priceProvSel');
  if(!sel) return;
  ACTIVE_PROV = sel.value;
  persistState();
  rebuildPricesToday();
}

function rebuildPricesToday(){
  const wrap = byId('prices_wrap');
  if(!wrap) return;

  const prov = ACTIVE_PROV || PROVEEDORES[0];
  const items = (orders[prov]||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'es'));

  if(!items.length){
    wrap.innerHTML = `<div class="hint">No hay Ã­tems en ${prov}. Asigna productos desde GLOBAL.</div>`;
    return;
  }

  // construir filas: sÃ³lo productos comprados (en el proveedor activo)
  let html = `<div class="scroll-x"><table>
    <thead><tr><th>Producto</th><th>Qty</th><th>Precio</th><th>Total</th></tr></thead><tbody>`;

  let sum = 0;
  items.forEach(it=>{
    const rec = ensurePriceRecord(it.name);
    const pRec = rec.providers?.[prov];
    const price = pRec ? num(pRec.price) : '';
    const total = (price!=='' ? num(price)*num(it.qty) : '');
    if(total!=='' && isFinite(total)) sum += total;

    html += `<tr>
      <td>${rec.name}</td>
      <td style="text-align:right">${roundNice(it.qty)}</td>
      <td>
        <input class="price-input" inputmode="decimal" placeholder="â‚¬" value="${price!==''?String(price):''}"
          onblur="priceBlur('${escapeAttr(rec.name)}','${escapeAttr(prov)}',this.value)">
      </td>
      <td style="text-align:right">${total!==''? eur(total): 'â€”'}</td>
    </tr>`;
  });

  html += `</tbody></table></div>
    <div class="row" style="margin-top:10px">
      <div class="pill">Proveedor: ${prov}</div>
      <div class="pill">Subtotal con precios: ${eur(sum)}</div>
    </div>
  `;

  wrap.innerHTML = html;
}

function priceBlur(prod, prov, val){
  const p = num(val);
  if(!val.trim()){
    // no borramos historial, solo dejamos vacÃ­o
    persistState();
    return;
  }
  if(!isFinite(p) || p<0){ alert('Precio invÃ¡lido'); return; }
  setProviderPrice(prod, prov, p);
  rebuildPricesToday();
}

function exportPricesTXT(){
  const prov = ACTIVE_PROV || PROVEEDORES[0];
  const items = (orders[prov]||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'es'));
  if(!items.length){ alert('No hay Ã­tems.'); return; }

  let lines = [];
  items.forEach(it=>{
    const rec = ensurePriceRecord(it.name);
    const pRec = rec.providers?.[prov];
    if(!pRec) return; // âœ… si no hay nuevo precio, ignorar
    lines.push(`${rec.name}\t${num(pRec.price)}â‚¬`);
  });
  if(!lines.length){ alert('No hay precios cargados para este proveedor.'); return; }

  const txt = lines.join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `precios_${prov}_${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
}

function sendPricesWA(){
  const prov = ACTIVE_PROV || PROVEEDORES[0];
  const items = (orders[prov]||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'es'));
  if(!items.length){ alert('No hay Ã­tems.'); return; }

  let lines = [];
  items.forEach(it=>{
    const rec = ensurePriceRecord(it.name);
    const pRec = rec.providers?.[prov];
    if(!pRec) return;
    lines.push(`${rec.name}: ${num(pRec.price)}â‚¬`);
  });
  if(!lines.length){ alert('No hay precios cargados para este proveedor.'); return; }

  const msg = encodeURIComponent(`ğŸ’¶ *PRECIOS ${prov}*\n\n` + lines.join('\n'));
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* PDF cuadrÃ­cula con precios (si existe jsPDF lo usa; si no, imprime) */
function exportPricesPDF(){
  const prov = ACTIVE_PROV || PROVEEDORES[0];
  const items = (orders[prov]||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'es'));
  if(!items.length){ alert('No hay Ã­tems.'); return; }

  const rows = [];
  items.forEach(it=>{
    const rec = ensurePriceRecord(it.name);
    const pRec = rec.providers?.[prov];
    if(!pRec) return;
    rows.push([rec.name, `${num(pRec.price)}â‚¬`]);
  });
  if(!rows.length){ alert('No hay precios cargados.'); return; }

  if(window.jspdf && window.jspdf.jsPDF){
    const doc = new window.jspdf.jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
    doc.setFontSize(14);
    doc.text(`PRECIOS â€” ${prov}`, 40, 40);
    doc.setFontSize(10);

    // cuadrÃ­cula simple (2 columnas)
    const margin = 40;
    const pageW = doc.internal.pageSize.getWidth();
    const colW = (pageW - margin*2);
    const rowH = 18;
    let y = 70;

    rows.forEach((r, idx)=>{
      if(y > doc.internal.pageSize.getHeight()-60){
        doc.addPage(); y = 40;
      }
      // lÃ­nea
      doc.rect(margin, y-rowH+4, colW, rowH);
      // separador
      doc.line(margin + colW*0.75, y-rowH+4, margin + colW*0.75, y+4);
      doc.text(String(r[0]), margin+6, y);
      doc.text(String(r[1]), margin + colW*0.75 + 6, y);
      y += rowH;
    });

    doc.save(`precios_${prov}_${new Date().toISOString().split('T')[0]}.pdf`);
    return;
  }

  // fallback print
  const w = window.open('', '_blank');
  const html = `
  <html><head><meta charset="utf-8"><title>Precios ${prov}</title>
  <style>
    body{font-family:Arial; padding:20px}
    h1{font-size:18px}
    table{border-collapse:collapse; width:100%}
    td,th{border:1px solid #333; padding:6px}
    th{background:#eee}
  </style></head><body>
  <h1>PRECIOS â€” ${prov}</h1>
  <table><thead><tr><th>Producto</th><th>Precio</th></tr></thead>
  <tbody>${rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('')}</tbody>
  </table>
  <script>window.print()</script>
  </body></html>`;
  w.document.write(html);
  w.document.close();
}

/* ==========================
   REPARTO (estructura simple con estado done + fotos)
========================== */
function getRepartoDestinations(){
  // devuelve destinos con key y label para QA
  const arr = [];
  // tiendas (ya estÃ¡n en QA base)
  // clientes
  (clients||[]).forEach(c=>{
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    arr.push({ key:c.id, label, type:'client' });
  });
  return arr;
}

function buildRepartoSelector(){
  const sel = byId('rep_dest_sel');
  if(!sel) return;

  const opts = [];
  opts.push({key:'sp', label:'ğŸª San Pablo'});
  opts.push({key:'sl', label:'ğŸª San Lesmes'});
  opts.push({key:'st', label:'ğŸª Santiago'});
  (clients||[]).forEach(c=>{
    const label = c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
    opts.push({key:c.id, label});
  });

  const cur = sel.value || 'sp';
  sel.innerHTML = opts.map(o=>`<option value="${o.key}">${o.label}</option>`).join('');
  if(opts.some(o=>o.key===cur)) sel.value = cur;
}

function getDestRows(destKey){
  if(destKey==='sp'||destKey==='sl'||destKey==='st'){
    return (tiendaState[destKey]||[]).filter(r=>!r.a);
  }
  const c = clients.find(x=>x.id===destKey);
  return (c?.rows||[]).filter(r=>!r.a);
}

function ensureRepartoDest(destKey){
  if(!repartoState[destKey]){
    repartoState[destKey] = { done:{}, photos:[], finished:false, finishedAt:null };
  }
  return repartoState[destKey];
}

function renderRepartoTienda(){
  const wrap = byId('reparto_wrap');
  if(!wrap) return;
  const sel = byId('rep_dest_sel');
  const destKey = sel ? sel.value : 'sp';

  const dest = ensureRepartoDest(destKey);
  const rows = getDestRows(destKey);

  const label = (function(){
    if(destKey==='sp') return 'ğŸª San Pablo';
    if(destKey==='sl') return 'ğŸª San Lesmes';
    if(destKey==='st') return 'ğŸª Santiago';
    const c = clients.find(x=>x.id===destKey);
    if(!c) return 'ğŸ¨ Cliente';
    return c.tag ? `ğŸ¨ ${c.name} â€” ${c.tag}` : `ğŸ¨ ${c.name}`;
  })();

  if(!rows.length){
    wrap.innerHTML = `<div class="hint">No hay lÃ­neas (o estÃ¡n pendientes de revisar) para ${label}.</div>`;
    return;
  }

  let html = `<div class="card">
    <div class="hd">
      <strong>ğŸ“¦ Reparto â€” ${label}</strong>
      <div class="toolbar">
        <button class="btn small muted" onclick="repFinish('${destKey}')">Finalizar</button>
        <button class="btn small muted" onclick="repClear('${destKey}')">Reset</button>
      </div>
    </div>
    <div class="bd">
      <div class="hint">Marca entregado por lÃ­nea. Puedes aÃ±adir fotos al final.</div>
      <div class="scroll-x"><table>
        <thead><tr><th>OK</th><th>Qty</th><th>Producto</th></tr></thead><tbody>`;

  rows.forEach(r=>{
    const k = normKey(r.e);
    const done = !!dest.done[k];
    html += `<tr class="${done?'done':''}">
      <td style="text-align:center"><input type="checkbox" ${done?'checked':''} onchange="repToggle('${destKey}','${k}',this.checked)"></td>
      <td style="text-align:right">${roundNice(r.q)}</td>
      <td>${r.e}</td>
    </tr>`;
  });

  html += `</tbody></table></div>

    <div class="row" style="margin-top:10px">
      <input type="file" accept="image/*" capture="environment" multiple onchange="repAddPhotos('${destKey}', this.files)">
      <button class="btn small muted" onclick="repSendWA('${destKey}')">WhatsApp resumen</button>
    </div>

    <div class="hint" style="margin-top:8px">${dest.finished ? 'âœ… Finalizado: '+ new Date(dest.finishedAt||Date.now()).toLocaleString() : 'â³ No finalizado'}</div>
    </div>
  </div>`;

  wrap.innerHTML = html;
}

function repToggle(destKey, itemKey, val){
  const dest = ensureRepartoDest(destKey);
  dest.done[itemKey] = !!val;
  persistState();
  pushUndo({type:'rep_toggle', destKey});
  renderRepartoTienda();
}

function repAddPhotos(destKey, files){
  const dest = ensureRepartoDest(destKey);
  if(!files || !files.length) return;

  const arr = Array.from(files);
  let pending = arr.length;

  arr.forEach(f=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      dest.photos.push({ data: String(reader.result||''), ts: Date.now(), name: f.name||'foto' });
      pending--;
      if(pending<=0){
        persistState();
        pushUndo({type:'rep_photos', destKey});
        alert('Fotos aÃ±adidas.');
      }
    };
    reader.readAsDataURL(f);
  });
}

function repFinish(destKey){
  const dest = ensureRepartoDest(destKey);
  dest.finished = true;
  dest.finishedAt = Date.now();
  persistState();
  pushUndo({type:'rep_finish', destKey});
  alert('Reparto finalizado.');
  renderRepartoTienda();
}

function repClear(destKey){
  if(!confirm('Â¿Resetear estado de reparto de este destino?')) return;
  repartoState[destKey] = { done:{}, photos:[], finished:false, finishedAt:null };
  persistState();
  pushUndo({type:'rep_clear', destKey});
  renderRepartoTienda();
}

function repSummary(destKey){
  const dest = ensureRepartoDest(destKey);
  const rows = getDestRows(destKey);

  const done = [];
  const pending = [];
  rows.forEach(r=>{
    const k = normKey(r.e);
    const line = `${roundNice(r.q)} ${r.e}`;
    if(dest.done[k]) done.push(line);
    else pending.push(line);
  });

  return { done, pending, photos: dest.photos||[], finished: dest.finished, finishedAt: dest.finishedAt };
}

function repSendWA(destKey){
  const sel = byId('rep_dest_sel');
  const label = sel ? sel.options[sel.selectedIndex].textContent : destKey;

  const s = repSummary(destKey);
  const msg = [
    `ğŸ“¦ *REPARTO â€” ${label}*`,
    s.finished ? `âœ… Finalizado: ${new Date(s.finishedAt||Date.now()).toLocaleString()}` : `â³ No finalizado`,
    '',
    `âœ… Entregado (${s.done.length})`,
    s.done.length? s.done.join('\n') : 'â€”',
    '',
    `â³ Pendiente (${s.pending.length})`,
    s.pending.length? s.pending.join('\n') : 'â€”',
    '',
    `ğŸ“¸ Fotos guardadas: ${s.photos.length}`
  ].join('\n');

  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
}

/* ==========================
   OOV / DUP UI buttons hookups
========================== */
function openOOV(){
  scanOutOfVocab();
  const t = byId('oov_title');
  if(t) t.scrollIntoView({behavior:'smooth', block:'start'});
}
function openDUP(){
  scanDuplicatesPro();
  const t = byId('dup_title');
  if(t) t.scrollIntoView({behavior:'smooth', block:'start'});
}

/* ==========================
   INIT
========================== */
(function init(){
  // Theme default DIA
  if(!localStorage.getItem('arslan_theme')) localStorage.setItem('arslan_theme','day');
  applyTheme();

  loadState();
  loadVocab();          // âœ… FIX: carga vocab SIEMPRE
  renderClientsUI();
  renderTable('sp'); renderTable('sl'); renderTable('st');
  unificarGlobal();
  renderProvidersPanels();
  buildRepartoSelector();
  renderRepartoTienda();
  renderPriceProviderSelect();
  rebuildPricesToday();
  buildQuickAddDestinations();
  qaSyncPlaceholder();

  // pills
  const undoP = byId('undoPill');
  if(undoP) undoP.textContent = `UNDO: ${UNDO_STACK.length}`;
  const t = byId('activeProvTitle');
  if(t) t.textContent = `Proveedor activo: ${ACTIVE_PROV}`;

  // keyboard global shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.altKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
    if(e.altKey && e.key.toLowerCase()==='s'){ e.preventDefault(); toggleScannerMode(); }
  });

})();
</script>
</body>
</html>
<!-- ===========================
FIN PARTE 3/3
=========================== -->
