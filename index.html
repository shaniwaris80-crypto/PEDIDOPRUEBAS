<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- âœ… Para generar LINK Repartidor comprimido + LINK Precios -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff; --shadow:0 2px 8px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6; --border:#1f2937; --panel:#111827; --shadow:0 2px 10px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;color:var(--ink);background:var(--bg);margin:0;
    transition: background .2s ease, color .2s ease;
  }
  h1{font-size:18px;margin:0;color:var(--ink)}
  .topbar{
    position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px;
    backdrop-filter: saturate(1.2) blur(6px);
  }
  .topbar .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .theme-toggle{border:1px solid var(--border); background:var(--panel); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--bg);box-shadow:var(--shadow);margin-bottom:12px; transition: transform .12s ease}
  .card:active{transform:scale(.998)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border); position:relative; gap:8px; flex-wrap:wrap}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px; transition: opacity .2s ease, transform .1s ease}
  .btn:active{transform: translateY(1px)}
  .btn.ghost{background:var(--bg);color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:var(--bg);border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px;background:var(--bg);color:var(--ink)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em; position:sticky; top:0; background:var(--bg); z-index:1}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  [data-theme="dark"] .pill.ok{border-color:#14532d;background:#052e1a;color:#86efac}
  [data-theme="dark"] .pill.warn{border-color:#7f1d1d;background:#2b0d0d;color:#fecaca}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  [data-theme="dark"] .ac-item:hover{background:#111827}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:var(--bg);color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  [data-theme="dark"] .ok-assign{background:#052e1a;color:#86efac}
  .dup{background:#fff5f5}
  [data-theme="dark"] .dup{background:#2b0d0d}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}
  .tabbar{
    position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;
  }
  .tabbar button{
    background:var(--bg);border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;
    padding:6px 8px; border-radius:10px; transition: background .15s ease, color .15s ease
  }
  .tabbar button.active{color:var(--kiwi); background:rgba(22,163,74,.08)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}

  .fab{
    position:fixed; right:14px; bottom:72px; z-index:1001;
    width:56px; height:56px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%); color:#fff; font-size:22px; box-shadow:var(--shadow)
  }
  .fab-menu{
    position:fixed; right:14px; bottom:134px; z-index:1000; display:none; flex-direction:column; gap:8px
  }
  .fab-menu .fab-item{
    border:1px solid var(--border); background:var(--bg); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow)
  }
  .fab-menu.show{display:flex}

  select{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:var(--bg);
    color:var(--ink);
    font-size:14px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}

  .price-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 8px;border-radius:999px;border:1px solid var(--border);
    background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;border:1px solid var(--border);border-bottom-width:2px;border-radius:8px;
    padding:2px 6px;background:var(--bg);color:var(--ink)
  }
  .qty-tools{display:flex;gap:6px;align-items:center;justify-content:flex-end}
  .qty-btn{
    width:28px;height:28px;border-radius:10px;border:1px solid var(--border);
    background:var(--bg);color:var(--ink);cursor:pointer;font-weight:700
  }
  .qty-btn:active{transform:translateY(1px)}
  .pdf-grid{
    width:100%; border-collapse:collapse;
    font-family:'Poppins',sans-serif; font-size:12px;
  }
  .pdf-grid th,.pdf-grid td{
    border:1px solid #11182722; padding:6px; vertical-align:top;
  }
  .pdf-grid th{background:#11182710; text-transform:uppercase; letter-spacing:.04em}

  /* âœ… NUEVO: input numÃ©rico para precios */
  .price-input{
    width:100%;
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    background:var(--bg);
    color:var(--ink);
  }
  .price-input:focus{
    outline:2px solid rgba(22,163,74,.35);
    outline-offset:1px;
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <h1>ğŸˆ ARSLAN LISTAS v3.4 â€” KIWI MOBILE TABS</h1>
      <span class="pill">Modo mÃ³vil optimizado</span>
      <span class="pill">ğŸšš Reparto link: /reparto/</span>
      <span class="price-chip" title="Atajos de cantidades">
        <span class="kbd">+</span><span class="kbd">-</span>
        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
        <span class="kbd">Shift</span>=10
        <span class="kbd">Alt</span>=0,1
      </span>
    </div>
    <div class="toolbar">
      <button class="btn ghost small" onclick="generarLinkRepartidor()">ğŸšš Link Repartidor</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ— Tema</button>
    </div>
  </div>

  <div class="container">
    <div class="hint" style="margin-bottom:10px">
      Flujo: Diccionario â†’ Tiendas/Clientes (Estandarizar) â†’ Global (Unificar/Asignar) â†’ Proveedores (TXT/Precios) â†’ Reparto (clic) â†’ PDF/WhatsApp
    </div>

    <!-- TAB: Diccionario -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>ğŸ“š Vocabulario estandarizado (editable)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn ghost" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="limpiarDia()">ğŸ§¹ Limpiar dÃ­a</button>
            <button class="btn muted" onclick="resetAll()">ğŸ’¥ Reset total</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">
            Un producto por lÃ­nea. Se normaliza a <b>MAYÃšSCULAS</b> sin tildes. Sin duplicados.
          </div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>
    </section>

    <!-- TAB: Tiendas -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sp')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sp')">ğŸ“² WhatsApp</button>

              <!-- âœ… NUEVO: cuadrÃ­cula con nombre+precio (solo lo que le afecta) -->
              <button class="btn muted" onclick="exportarTiendaPreciosTXT('sp')">ğŸ’¶ TXT PRECIOS</button>
              <button class="btn muted" onclick="enviarTiendaPreciosWhatsApp('sp')">ğŸ’¶ WA PRECIOS</button>
              <button class="btn muted" onclick="exportarTiendaPreciosPDF('sp')">ğŸ’¶ PDF PRECIOS</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>ğŸª San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('sl')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('sl')">ğŸ“² WhatsApp</button>

              <!-- âœ… NUEVO -->
              <button class="btn muted" onclick="exportarTiendaPreciosTXT('sl')">ğŸ’¶ TXT PRECIOS</button>
              <button class="btn muted" onclick="enviarTiendaPreciosWhatsApp('sl')">ğŸ’¶ WA PRECIOS</button>
              <button class="btn muted" onclick="exportarTiendaPreciosPDF('sl')">ğŸ’¶ PDF PRECIOS</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>ğŸª Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn" onclick="guardarTienda('st')">Guardar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">ğŸ“„ TXT</button>
              <button class="btn muted" onclick="enviarTiendaWhatsApp('st')">ğŸ“² WhatsApp</button>

              <!-- âœ… NUEVO -->
              <button class="btn muted" onclick="exportarTiendaPreciosTXT('st')">ğŸ’¶ TXT PRECIOS</button>
              <button class="btn muted" onclick="enviarTiendaPreciosWhatsApp('st')">ğŸ’¶ WA PRECIOS</button>
              <button class="btn muted" onclick="exportarTiendaPreciosPDF('st')">ğŸ’¶ PDF PRECIOS</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. Cantidades con teclado (+/-/â†‘/â†“).</div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- âœ… CLIENTES/HOTELES -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ¨ Clientes / Hoteles (con TAG)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addClient()">+ Nuevo cliente</button>
            <button class="btn muted" onclick="saveClients()">Guardar clientes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            AÃ±ade pedidos de hoteles/clientes (Braseros Centro/Forum/Edificio/Tomillares/Severo, Riviera, etc.).  
            âœ… Solo cuentan si tienen lÃ­neas. Se suman a Global/Proveedores/Reparto.
          </div>
          <div id="clients_wrap"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Global -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ§® UnificaciÃ³n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar todo</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">ğŸ“„ TXT Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">
            âœ… a la izquierda asigna al proveedor activo. Duplicados probables se <span class="red">marcan en rojo</span> y fila rosada (<b>âš ï¸</b>).
            Cantidades con teclado (+/-/â†‘/â†“). Enter baja a la siguiente fila.
          </div>

          <div class="card" style="margin-top:8px">
            <div class="bd">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="hint">Proveedor activo:</span>
                <div class="prov-bar" id="provBar"></div>
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn ghost small" onclick="undoLast()">â†©ï¸ Deshacer</button>
            <span class="pill" id="undoPill">Undo: 0</span>
          </div>

          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: Proveedores -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>ğŸ“¦ DistribuciÃ³n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- âœ… PRECIOS (SOLO COMPRADO/ASIGNADO) + LINK EXTERNO -->
      <div class="card" style="margin-top:12px">
        <div class="hd">
          <strong>ğŸ’¶ Precios (solo productos comprados/asignados hoy)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="rebuildPricesToday()">ğŸ”„ Refrescar</button>
            <button class="btn small" onclick="generarLinkPrecios()">ğŸ”— Link precios externo</button>
            <button class="btn small muted" onclick="exportPricesTXT()">ğŸ“„ Export precios TXT</button>
            <button class="btn small muted" onclick="resetPricesConfirm()">ğŸ§½ Reset precios</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            âœ… Solo aparecen productos de pedidos por proveedor (lo â€œcompradoâ€) + los no asignados en Global.  
            Si NO cambias un precio, NO se toca. Si estÃ¡ vacÃ­o, se ignora.
          </div>
          <div id="prices_wrap" class="scroll-x"></div>
        </div>
      </div>

      <!-- REPARTO -->
      <div class="card" style="margin-top:12px">
        <div class="hd"><strong>ğŸšš Reparto (tiendas + clientes)</strong>
          <div class="toolbar">
            <button class="btn small muted" onclick="marcarTodoReparto(true)">âœ… Todo</button>
            <button class="btn small muted" onclick="marcarTodoReparto(false)">â¬œ Nada</button>
            <button class="btn small" onclick="enviarRepartoWhatsApp()">ğŸ“² WhatsApp</button>
            <button class="btn small muted" onclick="exportarRepartoTXT()">ğŸ“„ TXT</button>
            <button class="btn small muted" onclick="exportarRepartoPDF()">ğŸ§¾ PDF (cuadrÃ­cula)</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">
            Selecciona destino (tienda o cliente con pedido). Marca lo repartido y exporta.  
            Los precios se autocompletan si existen en â€œPreciosâ€.
          </div>
          <div style="margin-bottom:8px;">
            <select id="selRepartoTienda" onchange="renderRepartoTienda()"></select>
          </div>
          <div id="reparto_wrap" class="scroll-x"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- FAB Global -->
  <button class="fab" id="fab" title="Acciones rÃ¡pidas" style="display:none" onclick="toggleFabMenu()">âš™ï¸</button>
  <div class="fab-menu" id="fabMenu">
    <button class="fab-item" onclick="unificarGlobal(); toggleFabMenu(true)">ğŸ”„ Unificar</button>
    <button class="fab-item" onclick="exportarGlobalTXT(); toggleFabMenu(true)">ğŸ“„ TXT visible</button>
    <button class="fab-item" onclick="exportarGlobalXLSX(); toggleFabMenu(true)">ğŸ“Š Excel</button>
    <button class="fab-item" onclick="copiarGlobal(); toggleFabMenu(true)">ğŸ“‹ Copiar</button>
    <button class="fab-item" onclick="exportResumenGlobalTXT(); toggleFabMenu(true)">ğŸ§¾ TXT Global</button>
  </div>

  <!-- Tabbar -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">ğŸ“š<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">ğŸª<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">ğŸ§®<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">ğŸ“¦<span>Proveedores</span></button>
  </nav>
<!-- ===========================
PARTE 2/4 â€” ARSLAN LISTAS v3.4 (APP JS + NUEVO INPUT NUMÃ‰RICO PRECIOS + CUADRÃCULAS TIENDA PRECIOS)
âš ï¸ NO BORRES NADA: pegar justo despuÃ©s de la PARTE 1
=========================== -->

<script>
/* ===========================
  CONFIG LINKS (tus URLs)
=========================== */
const URL_LISTAS = "https://shaniwaris80-crypto.github.io/PEDIDOPRUEBAS/";
const URL_PRECIOS = "https://shaniwaris80-crypto.github.io/ponerprecios/";
const URL_REPARTO = "https://shaniwaris80-crypto.github.io/reparto/";

/* ===========================
  STORAGE KEYS
=========================== */
const LS = {
  theme: "arslan_theme_v34",
  vocab: "arslan_vocab_v34",
  stores: "arslan_stores_v34",
  clients: "arslan_clients_v34",
  global: "arslan_global_v34",
  assign: "arslan_assign_v34",
  prices: "arslan_prices_v34",
  priceHistory: "arslan_prices_hist_v34",
  undo: "arslan_undo_v34"
};

/* ===========================
  STATE
=========================== */
let STATE = {
  theme: "light",
  vocab: [],
  vocabSet: new Set(),
  stores: {
    sp: { raw:"", rows:[] },
    sl: { raw:"", rows:[] },
    st: { raw:"", rows:[] }
  },
  clients: [],       // {id,name,tag,raw,rows}
  globalRows: [],    // {id,qty,nameRaw,nameStd,status,storeSrc,clientId,provider,price}
  providers: ["ESMO","MONTENEGRO","JOSE ANTONIO","TOMASIN","ANGEL VACA","SERGIO","OTROS","NO ASIGNADO"],
  activeProvider: "ESMO",
  prices: {},        // { "PRODUCTO": 1.25 }
  priceHist: {},     // { "PRODUCTO": [{t, v}] }
  undo: []           // stack of {type,payload}
};

const el = (id)=>document.getElementById(id);

/* ===========================
  BASIC HELPERS
=========================== */
function now(){ return Date.now(); }
function uid(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+Math.random().toString(16).slice(2); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function normalizeText(s){
  if(!s) return "";
  return s.toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")  // quita tildes
    .replace(/\s+/g," ")
    .trim()
    .toUpperCase();
}

function parseQtyAndName(line){
  // Soporta: "2 TOMATE", "2kg tomate", "TOMATE 2", "x2"
  let raw = line.trim();
  if(!raw) return null;
  raw = raw.replace(/\t/g," ").replace(/\s+/g," ").trim();

  // detecta cantidad al inicio:  "2", "2,5", "2.5"
  let m = raw.match(/^(\d+(?:[.,]\d+)?)\s*(.*)$/);
  if(m){
    let qty = parseFloat(m[1].replace(",","."));
    let name = m[2].trim();
    if(!name) name = raw.replace(m[1],"").trim();
    return {qty: (isFinite(qty)?qty:1), name};
  }

  // detecta "x2 nombre"
  m = raw.match(/^x\s*(\d+(?:[.,]\d+)?)\s*(.*)$/i);
  if(m){
    let qty = parseFloat(m[1].replace(",","."));
    let name = m[2].trim();
    return {qty:(isFinite(qty)?qty:1), name};
  }

  // detecta cantidad al final: "TOMATE 2"
  m = raw.match(/^(.*)\s(\d+(?:[.,]\d+)?)$/);
  if(m){
    let name = m[1].trim();
    let qty = parseFloat(m[2].replace(",","."));
    return {qty:(isFinite(qty)?qty:1), name};
  }

  // si no hay qty => 1
  return {qty:1, name: raw};
}

function linesFromTextarea(text){
  return (text||"")
    .split("\n")
    .map(s=>s.trim())
    .filter(Boolean);
}

function fmtQty(q){
  if(q===null||q===undefined) return "";
  if(Math.abs(q - Math.round(q)) < 1e-9) return String(Math.round(q));
  let s = String(q);
  return s.replace(".",",");
}
function fmtPrice(p){
  if(p===null||p===undefined||p===""||!isFinite(p)) return "";
  return (Math.round(p*100)/100).toFixed(2).replace(".",",") + "â‚¬";
}
function parsePrice(s){
  if(s===null||s===undefined) return null;
  let t = String(s).trim();
  if(!t) return null;
  t = t.replace("â‚¬","").replace(/\s/g,"").replace(",",".");
  let v = parseFloat(t);
  return isFinite(v) ? v : null;
}

function saveLS(){
  localStorage.setItem(LS.theme, STATE.theme);
  localStorage.setItem(LS.vocab, JSON.stringify(STATE.vocab));
  localStorage.setItem(LS.stores, JSON.stringify(STATE.stores));
  localStorage.setItem(LS.clients, JSON.stringify(STATE.clients));
  localStorage.setItem(LS.global, JSON.stringify(STATE.globalRows));
  localStorage.setItem(LS.assign, JSON.stringify({activeProvider: STATE.activeProvider}));
  localStorage.setItem(LS.prices, JSON.stringify(STATE.prices));
  localStorage.setItem(LS.priceHistory, JSON.stringify(STATE.priceHist));
  localStorage.setItem(LS.undo, JSON.stringify(STATE.undo));
}

function loadLS(){
  try{
    const th = localStorage.getItem(LS.theme);
    if(th) STATE.theme = th;

    const v = localStorage.getItem(LS.vocab);
    if(v){
      STATE.vocab = JSON.parse(v)||[];
    } else {
      STATE.vocab = [];
    }
    STATE.vocab = STATE.vocab
      .map(x=>normalizeText(x))
      .filter(Boolean);
    // unique
    STATE.vocab = Array.from(new Set(STATE.vocab));
    STATE.vocabSet = new Set(STATE.vocab);

    const st = localStorage.getItem(LS.stores);
    if(st){
      const parsed = JSON.parse(st)||{};
      STATE.stores.sp = parsed.sp || STATE.stores.sp;
      STATE.stores.sl = parsed.sl || STATE.stores.sl;
      STATE.stores.st = parsed.st || STATE.stores.st;
    }

    const cl = localStorage.getItem(LS.clients);
    if(cl) STATE.clients = JSON.parse(cl)||[];

    const gl = localStorage.getItem(LS.global);
    if(gl) STATE.globalRows = JSON.parse(gl)||[];

    const asg = localStorage.getItem(LS.assign);
    if(asg){
      const p = JSON.parse(asg)||{};
      if(p.activeProvider) STATE.activeProvider = p.activeProvider;
    }

    const pr = localStorage.getItem(LS.prices);
    if(pr) STATE.prices = JSON.parse(pr)||{};

    const ph = localStorage.getItem(LS.priceHistory);
    if(ph) STATE.priceHist = JSON.parse(ph)||{};

    const ud = localStorage.getItem(LS.undo);
    if(ud) STATE.undo = JSON.parse(ud)||[];

  }catch(e){
    console.warn("loadLS error", e);
  }
}

/* ===========================
  THEME + TABS
=========================== */
function applyTheme(){
  document.documentElement.setAttribute("data-theme", STATE.theme === "dark" ? "dark" : "light");
}
function toggleTheme(){
  STATE.theme = (STATE.theme==="dark") ? "light" : "dark";
  applyTheme(); saveLS();
}
function showTab(tab){
  const tabs = ["dic","tiendas","global","proveedores"];
  tabs.forEach(t=>{
    const sec = el("tab-"+t);
    if(sec) sec.style.display = (t===tab) ? "" : "none";
    const btn = el("btn-"+t);
    if(btn) btn.classList.toggle("active", t===tab);
  });
  const fab = el("fab");
  if(fab) fab.style.display = (tab==="global") ? "" : "none";
}

/* ===========================
  FAB
=========================== */
function toggleFabMenu(forceClose=false){
  const m = el("fabMenu");
  if(!m) return;
  if(forceClose){ m.classList.remove("show"); return; }
  m.classList.toggle("show");
}

/* ===========================
  VOCABULARIO
=========================== */
function renderVocab(){
  el("vocabTxt").value = (STATE.vocab||[]).join("\n");
}
function saveVocab(){
  const txt = el("vocabTxt").value || "";
  let arr = txt.split("\n").map(x=>normalizeText(x)).filter(Boolean);
  arr = Array.from(new Set(arr));
  STATE.vocab = arr;
  STATE.vocabSet = new Set(arr);
  saveLS();
  alert("âœ… Vocabulario guardado ("+arr.length+")");
  // re-render tablas
  renderAllStoreTables();
  renderClients();
  renderGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  rebuildRepartoSelector();
}
function addNewWord(){
  const name = prompt("Nuevo producto (se guardarÃ¡ en MAYÃšSCULAS):");
  if(!name) return;
  const n = normalizeText(name);
  if(!n) return;
  if(!STATE.vocabSet.has(n)){
    STATE.vocab.push(n);
    STATE.vocab = Array.from(new Set(STATE.vocab));
    STATE.vocabSet = new Set(STATE.vocab);
    renderVocab();
    saveLS();
  }
}

/* ===========================
  LIMPIAR DÃA / RESET
=========================== */
function limpiarDia(){
  if(!confirm("Â¿Limpiar el dÃ­a? (Borra listas, global, asignaciones y reparto, pero NO borra vocabulario ni historial de precios)")) return;
  STATE.stores = { sp:{raw:"",rows:[]}, sl:{raw:"",rows:[]}, st:{raw:"",rows:[]} };
  STATE.clients = STATE.clients.map(c=>({ ...c, raw:"", rows:[] }));
  STATE.globalRows = [];
  STATE.undo = [];
  saveLS();
  // limpiar UI
  el("in_sp").value = ""; el("in_sl").value=""; el("in_st").value="";
  renderAllStoreTables();
  renderClients();
  renderGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  rebuildRepartoSelector();
  alert("ğŸ§¹ DÃ­a limpiado.");
}
function resetAll(){
  if(!confirm("âš ï¸ Reset TOTAL: borra TODO incluyendo vocabulario, clientes, precios e historial. Â¿Seguro?")) return;
  localStorage.removeItem(LS.theme);
  localStorage.removeItem(LS.vocab);
  localStorage.removeItem(LS.stores);
  localStorage.removeItem(LS.clients);
  localStorage.removeItem(LS.global);
  localStorage.removeItem(LS.assign);
  localStorage.removeItem(LS.prices);
  localStorage.removeItem(LS.priceHistory);
  localStorage.removeItem(LS.undo);
  location.reload();
}

/* ===========================
  SUGERENCIAS / MATCH VOCAB
=========================== */
function bestMatchVocab(name){
  const n = normalizeText(name);
  if(!n) return {std:"", ok:false};
  if(STATE.vocabSet.has(n)) return {std:n, ok:true};

  // match simple contains
  let best = "";
  let bestScore = 0;
  for(const w of STATE.vocab){
    if(!w) continue;
    let score = 0;
    if(w===n) score = 999;
    else{
      // scoring por tokens
      const a = n.split(" ");
      const b = w.split(" ");
      const setB = new Set(b);
      for(const t of a){
        if(setB.has(t)) score += 2;
        else if(w.includes(t)) score += 1;
      }
      if(w.includes(n)) score += 3;
      if(n.includes(w)) score += 3;
      score -= Math.abs(w.length - n.length) * 0.02;
    }
    if(score > bestScore){
      bestScore = score;
      best = w;
    }
  }
  const ok = bestScore >= 3.5;
  return {std: best || n, ok};
}

function createAutocomplete(inputEl){
  let box = null;

  function close(){
    if(box && box.parentNode) box.parentNode.removeChild(box);
    box = null;
  }
  function open(items){
    close();
    const r = inputEl.getBoundingClientRect();
    box = document.createElement("div");
    box.className = "ac-box";
    box.style.left = (window.scrollX + r.left) + "px";
    box.style.top  = (window.scrollY + r.bottom + 4) + "px";
    box.style.width = Math.max(220, r.width) + "px";

    items.slice(0,14).forEach(it=>{
      const d = document.createElement("div");
      d.className = "ac-item";
      d.textContent = it;
      d.onclick = ()=>{
        inputEl.value = it;
        inputEl.dispatchEvent(new Event("change"));
        close();
      };
      box.appendChild(d);
    });
    document.body.appendChild(box);
  }

  inputEl.addEventListener("input", ()=>{
    const q = normalizeText(inputEl.value);
    if(!q){ close(); return; }
    const items = STATE.vocab.filter(w=>w.includes(q)).slice(0,14);
    if(!items.length){ close(); return; }
    open(items);
  });
  inputEl.addEventListener("blur", ()=> setTimeout(close, 150));
}

/* ===========================
  TIENDAS: parse + tabla editable
=========================== */
function parseStoreText(storeKey){
  const ta = el("in_"+storeKey);
  const txt = (ta?.value||"");
  STATE.stores[storeKey].raw = txt;

  const lines = linesFromTextarea(txt);
  const rows = [];
  for(const line of lines){
    const p = parseQtyAndName(line);
    if(!p) continue;
    const match = bestMatchVocab(p.name);
    rows.push({
      id: uid("row"),
      qty: p.qty || 1,
      nameRaw: p.name,
      nameStd: match.std || normalizeText(p.name),
      ok: match.ok,
      provider: "", // se asigna luego desde Global o manual
    });
  }
  STATE.stores[storeKey].rows = rows;
  saveLS();
}

function estandarizar(storeKey){
  parseStoreText(storeKey);
  renderStoreTable(storeKey);
}

function guardarTienda(storeKey){
  parseStoreText(storeKey);
  renderStoreTable(storeKey);
  saveLS();
  alert("âœ… Guardado: "+storeName(storeKey));
}

function storeName(k){
  return k==="sp" ? "San Pablo" : (k==="sl" ? "San Lesmes" : "Santiago");
}

function renderAllStoreTables(){
  ["sp","sl","st"].forEach(k=>{
    const ta = el("in_"+k);
    if(ta && !ta.value && STATE.stores[k].raw) ta.value = STATE.stores[k].raw;
    renderStoreTable(k);
  });
}

function renderStoreTable(storeKey){
  const wrap = el("tbl_"+storeKey+"_wrap");
  if(!wrap) return;
  const rows = STATE.stores[storeKey].rows || [];

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:90px">Cant.</th>
        <th>Producto (estandarizado)</th>
        <th style="width:150px">Estado</th>
        <th style="width:150px">Precio</th>
        <th style="width:110px;text-align:right">Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  rows.forEach((r,idx)=>{
    const tr = document.createElement("tr");
    const priceVal = (STATE.prices[r.nameStd] != null) ? STATE.prices[r.nameStd] : null;

    tr.innerHTML = `
      <td>
        <div class="qty-tools">
          <button class="qty-btn" title="-1" data-act="dec">-</button>
          <input class="price-input" data-role="qty" inputmode="decimal" style="width:70px;text-align:center" value="${fmtQty(r.qty)}">
          <button class="qty-btn" title="+1" data-act="inc">+</button>
        </div>
      </td>
      <td>
        <input class="price-input" data-role="name" value="${r.nameStd}">
        <div class="hint" style="margin-top:4px">${normalizeText(r.nameRaw)}</div>
      </td>
      <td>
        <span class="pill ${r.ok ? "ok": "warn"}">${r.ok ? "OK":"REVISAR"}</span>
      </td>
      <td>
        <span class="pill">${priceVal!=null ? fmtPrice(priceVal) : "â€”"}</span>
      </td>
      <td style="text-align:right">
        <button class="btn muted small" data-role="fix">âœ”ï¸</button>
        <button class="btn muted small" data-role="del">ğŸ—‘</button>
      </td>
    `;

    const qtyInput = tr.querySelector('[data-role="qty"]');
    const nameInput = tr.querySelector('[data-role="name"]');
    const fixBtn = tr.querySelector('[data-role="fix"]');
    const delBtn = tr.querySelector('[data-role="del"]');
    const incBtn = tr.querySelector('[data-act="inc"]');
    const decBtn = tr.querySelector('[data-act="dec"]');

    // qty buttons
    incBtn.onclick = ()=>{ r.qty = +(r.qty||0) + 1; qtyInput.value = fmtQty(r.qty); saveLS(); };
    decBtn.onclick = ()=>{ r.qty = Math.max(0, +(r.qty||0) - 1); qtyInput.value = fmtQty(r.qty); saveLS(); };

    qtyInput.addEventListener("change", ()=>{
      let v = parseFloat(String(qtyInput.value).replace(",","."));
      if(!isFinite(v)) v = 1;
      r.qty = v;
      qtyInput.value = fmtQty(r.qty);
      saveLS();
    });

    // qty keyboard shortcuts
    qtyInput.addEventListener("keydown", (e)=>{
      const stepBase = e.shiftKey ? 10 : (e.altKey ? 0.1 : 1);
      if(e.key==="ArrowUp" || e.key==="+"){
        e.preventDefault();
        r.qty = +(r.qty||0) + stepBase;
        qtyInput.value = fmtQty(r.qty);
        saveLS();
      }
      if(e.key==="ArrowDown" || e.key==="-"){
        e.preventDefault();
        r.qty = Math.max(0, +(r.qty||0) - stepBase);
        qtyInput.value = fmtQty(r.qty);
        saveLS();
      }
      if(e.key==="Enter"){
        e.preventDefault();
        // salta a la siguiente fila -> qty
        const next = tbody.querySelectorAll('input[data-role="qty"]')[idx+1];
        if(next) next.focus();
      }
    });

    // name autocomplete
    createAutocomplete(nameInput);

    nameInput.addEventListener("change", ()=>{
      const val = normalizeText(nameInput.value);
      const match = bestMatchVocab(val);
      r.nameStd = match.std || val;
      r.ok = !!match.ok;
      nameInput.value = r.nameStd;
      saveLS();
      // re-render para refrescar pills
      renderStoreTable(storeKey);
      rebuildPricesToday();
    });

    fixBtn.onclick = ()=>{
      // guardar en vocab si no existe
      const n = normalizeText(nameInput.value);
      if(n && !STATE.vocabSet.has(n)){
        STATE.vocab.push(n);
        STATE.vocab = Array.from(new Set(STATE.vocab));
        STATE.vocabSet = new Set(STATE.vocab);
        renderVocab();
      }
      r.nameStd = n;
      r.ok = true;
      saveLS();
      renderStoreTable(storeKey);
      rebuildPricesToday();
    };

    delBtn.onclick = ()=>{
      if(!confirm("Â¿Eliminar lÃ­nea?")) return;
      rows.splice(idx,1);
      saveLS();
      renderStoreTable(storeKey);
      rebuildPricesToday();
    };

    tbody.appendChild(tr);
  });

  wrap.innerHTML = "";
  wrap.appendChild(table);
}

/* ===========================
  EXPORT TIENDA (TXT / WA)
=========================== */
function tiendaTXT(storeKey){
  const rows = STATE.stores[storeKey].rows || [];
  const out = rows
    .filter(r=>r.nameStd && (r.qty||0)>0)
    .map(r=>`${fmtQty(r.qty)} ${r.nameStd}`)
    .join("\n");
  return out.trim();
}
function exportarTiendaTXT(storeKey){
  const txt = tiendaTXT(storeKey);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  downloadTextFile(`${storeName(storeKey)}.txt`, txt);
}
function enviarTiendaWhatsApp(storeKey){
  const txt = tiendaTXT(storeKey);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  openWhatsApp(`*${storeName(storeKey)}*\n\n${txt}`);
}

/* ===========================
  âœ… NUEVO: CUADRÃCULA TIENDA PRECIOS (solo lo que le afecta)
  - usa precios guardados (STATE.prices) filtrando por productos presentes en esa tienda
=========================== */
function tiendaPreciosRows(storeKey){
  const rows = STATE.stores[storeKey].rows || [];
  const used = new Set(rows.map(r=>r.nameStd).filter(Boolean));
  const list = [];
  used.forEach(name=>{
    const p = STATE.prices[name];
    if(p==null || !isFinite(p)) return;
    list.push({name, price:p});
  });
  // orden alfabÃ©tico
  list.sort((a,b)=>a.name.localeCompare(b.name));
  return list;
}

function exportarTiendaPreciosTXT(storeKey){
  const list = tiendaPreciosRows(storeKey);
  if(!list.length){ alert("No hay precios para esta tienda."); return; }
  const txt = list.map(x=>`${x.name}\t${fmtPrice(x.price)}`).join("\n");
  downloadTextFile(`${storeName(storeKey)}_PRECIOS.txt`, txt);
}

function enviarTiendaPreciosWhatsApp(storeKey){
  const list = tiendaPreciosRows(storeKey);
  if(!list.length){ alert("No hay precios para esta tienda."); return; }
  // formato cuadrÃ­cula simple
  const body = list.map(x=>`${x.name}  ${fmtPrice(x.price)}`).join("\n");
  openWhatsApp(`*${storeName(storeKey)} â€” PRECIOS*\n\n${body}`);
}

function exportarTiendaPreciosPDF(storeKey){
  const list = tiendaPreciosRows(storeKey);
  if(!list.length){ alert("No hay precios para esta tienda."); return; }
  const title = `${storeName(storeKey)} â€” PRECIOS`;
  const html = buildPriceGridHTML(title, list);
  openPrintWindow(html);
}

/* ===========================
  FILE / WHATSAPP / PRINT HELPERS
=========================== */
function downloadTextFile(filename, content){
  const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
}
function openWhatsApp(text){
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

function openPrintWindow(html){
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=>w.print(), 300);
}

function buildPriceGridHTML(title, list){
  const rows = list.map(x=>`
    <tr>
      <td>${escapeHtml(x.name)}</td>
      <td style="text-align:right;font-weight:700">${escapeHtml(fmtPrice(x.price))}</td>
    </tr>
  `).join("");

  return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:Poppins,Arial,sans-serif;margin:18px}
  h2{margin:0 0 10px 0}
  .meta{color:#555;font-size:12px;margin-bottom:10px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #00000022;padding:6px}
  th{background:#00000010;text-transform:uppercase;letter-spacing:.04em}
  @media print{
    body{margin:10mm}
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <h2>${escapeHtml(title)}</h2>
  <div class="meta">Generado: ${new Date().toLocaleString()}</div>
  <table class="pdf-grid">
    <thead><tr><th>Producto</th><th style="text-align:right">Precio</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
</body>
</html>`;
}
function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ===========================
  CLIENTES â€” UI + parse (se renderiza en PARTE 3)
=========================== */
function addClient(){
  const name = prompt("Nombre cliente (ej: BRASEROS CENTRO, RIVIERA, FORUM...)");
  if(!name) return;
  const tag = prompt("TAG (opcional, ej: CENTRO/EDIFICIO/FORUM/SEVERO...)") || "";
  const c = {id: uid("cli"), name: name.trim(), tag: tag.trim(), raw:"", rows:[]};
  STATE.clients.push(c);
  saveLS();
  renderClients();
  rebuildRepartoSelector();
}

function saveClients(){
  // parsea todos desde textareas
  STATE.clients.forEach(c=>{
    const ta = el("cli_raw_"+c.id);
    c.raw = ta ? (ta.value||"") : (c.raw||"");
    c.rows = parseGenericRows(c.raw);
  });
  saveLS();
  renderClients();
  rebuildPricesToday();
  rebuildRepartoSelector();
  alert("âœ… Clientes guardados");
}

function parseGenericRows(txt){
  const lines = linesFromTextarea(txt||"");
  const rows = [];
  for(const line of lines){
    const p = parseQtyAndName(line);
    if(!p) continue;
    const match = bestMatchVocab(p.name);
    rows.push({
      id: uid("row"),
      qty: p.qty || 1,
      nameRaw: p.name,
      nameStd: match.std || normalizeText(p.name),
      ok: match.ok
    });
  }
  return rows;
}

/* ===========================
  GLOBAL / PROVEEDORES / PRECIOS / REPARTO
  (continÃºa en PARTE 3/4)
=========================== */
</script>
<!-- ===========================
PARTE 3/4 â€” ARSLAN LISTAS v3.4 (CLIENTES + GLOBAL + PROVEEDORES + PRECIOS NUMÃ‰RICOS + CUADRÃCULAS)
âš ï¸ Pegar justo despuÃ©s de la PARTE 2
=========================== -->

<script>
/* ===========================
  UI: CLIENTES
=========================== */
function renderClients(){
  const wrap = el("clientsWrap");
  if(!wrap) return;

  wrap.innerHTML = "";

  if(!STATE.clients.length){
    const empty = document.createElement("div");
    empty.className = "card";
    empty.innerHTML = `
      <div class="row">
        <div>
          <div class="h">Clientes</div>
          <div class="hint">AÃ±ade clientes si quieres separar pedidos por destino (Riviera, Forum, Braseros, etc.).</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="addClient()">+ AÃ±adir cliente</button>
        </div>
      </div>
    `;
    wrap.appendChild(empty);
    return;
  }

  // toolbar
  const bar = document.createElement("div");
  bar.className = "card";
  bar.innerHTML = `
    <div class="row">
      <div>
        <div class="h">Clientes</div>
        <div class="hint">Cada cliente: pega lista â†’ estandariza â†’ se integra en GLOBAL / PROVEEDORES / REPARTO.</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn muted" onclick="saveClients()">ğŸ’¾ Guardar</button>
        <button class="btn" onclick="addClient()">+ AÃ±adir cliente</button>
      </div>
    </div>
  `;
  wrap.appendChild(bar);

  STATE.clients.forEach((c,idx)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <div class="row" style="justify-content:space-between;gap:10px">
            <div>
              <div class="h">${escapeHtml(c.name)} <span class="hint">${c.tag ? ("Â· "+escapeHtml(c.tag)) : ""}</span></div>
              <div class="hint">Pega lÃ­neas tipo: <b>2 TOMATE</b>, <b>3,5 LIMÃ“N</b>, etc.</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn muted small" onclick="estandarizarCliente('${c.id}')">Estandarizar</button>
              <button class="btn muted small" onclick="exportarClienteTXT('${c.id}')">TXT</button>
              <button class="btn muted small" onclick="enviarClienteWhatsApp('${c.id}')">WA</button>
              <button class="btn danger small" onclick="deleteClient('${c.id}')">Eliminar</button>
            </div>
          </div>

          <textarea id="cli_raw_${c.id}" class="ta" placeholder="Ej:&#10;2 TOMATE RAMA&#10;3 LECHUGA ICEBERG&#10;1,5 LIMON" style="margin-top:10px;min-height:100px">${escapeHtml(c.raw||"")}</textarea>

          <div style="margin-top:10px" id="cli_tbl_${c.id}_wrap"></div>
        </div>
      </div>
    `;
    wrap.appendChild(card);

    renderClientTable(c.id);
  });
}

function deleteClient(id){
  const c = STATE.clients.find(x=>x.id===id);
  if(!c) return;
  if(!confirm(`Â¿Eliminar cliente "${c.name}"?`)) return;
  STATE.clients = STATE.clients.filter(x=>x.id!==id);
  saveLS();
  renderClients();
  rebuildGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  rebuildRepartoSelector();
}

function estandarizarCliente(id){
  const c = STATE.clients.find(x=>x.id===id);
  if(!c) return;
  const ta = el("cli_raw_"+id);
  c.raw = ta ? (ta.value||"") : (c.raw||"");
  c.rows = parseGenericRows(c.raw);
  saveLS();
  renderClientTable(id);
  rebuildGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
  rebuildRepartoSelector();
}

function renderClientTable(id){
  const c = STATE.clients.find(x=>x.id===id);
  const wrap = el("cli_tbl_"+id+"_wrap");
  if(!c || !wrap) return;

  const rows = c.rows || [];
  if(!rows.length){
    wrap.innerHTML = `<div class="hint">AÃºn no hay filas estandarizadas.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:90px">Cant.</th>
        <th>Producto</th>
        <th style="width:150px">Estado</th>
        <th style="width:150px">Precio</th>
        <th style="width:110px;text-align:right">Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  rows.forEach((r,idx)=>{
    const priceVal = (STATE.prices[r.nameStd] != null) ? STATE.prices[r.nameStd] : null;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="qty-tools">
          <button class="qty-btn" data-act="dec">-</button>
          <input class="price-input" data-role="qty" inputmode="decimal" style="width:70px;text-align:center" value="${fmtQty(r.qty)}">
          <button class="qty-btn" data-act="inc">+</button>
        </div>
      </td>
      <td>
        <input class="price-input" data-role="name" value="${r.nameStd}">
        <div class="hint" style="margin-top:4px">${normalizeText(r.nameRaw)}</div>
      </td>
      <td><span class="pill ${r.ok?"ok":"warn"}">${r.ok?"OK":"REVISAR"}</span></td>
      <td><span class="pill">${priceVal!=null ? fmtPrice(priceVal) : "â€”"}</span></td>
      <td style="text-align:right">
        <button class="btn muted small" data-role="fix">âœ”ï¸</button>
        <button class="btn muted small" data-role="del">ğŸ—‘</button>
      </td>
    `;

    const qtyInput = tr.querySelector('[data-role="qty"]');
    const nameInput = tr.querySelector('[data-role="name"]');
    const fixBtn = tr.querySelector('[data-role="fix"]');
    const delBtn = tr.querySelector('[data-role="del"]');
    const incBtn = tr.querySelector('[data-act="inc"]');
    const decBtn = tr.querySelector('[data-act="dec"]');

    incBtn.onclick = ()=>{ r.qty = +(r.qty||0) + 1; qtyInput.value = fmtQty(r.qty); saveLS(); };
    decBtn.onclick = ()=>{ r.qty = Math.max(0, +(r.qty||0) - 1); qtyInput.value = fmtQty(r.qty); saveLS(); };

    qtyInput.addEventListener("change", ()=>{
      let v = parseFloat(String(qtyInput.value).replace(",","."));
      if(!isFinite(v)) v = 1;
      r.qty = v;
      qtyInput.value = fmtQty(r.qty);
      saveLS();
    });

    qtyInput.addEventListener("keydown",(e)=>{
      const stepBase = e.shiftKey ? 10 : (e.altKey ? 0.1 : 1);
      if(e.key==="ArrowUp" || e.key==="+"){
        e.preventDefault();
        r.qty = +(r.qty||0) + stepBase;
        qtyInput.value = fmtQty(r.qty);
        saveLS();
      }
      if(e.key==="ArrowDown" || e.key==="-"){
        e.preventDefault();
        r.qty = Math.max(0, +(r.qty||0) - stepBase);
        qtyInput.value = fmtQty(r.qty);
        saveLS();
      }
      if(e.key==="Enter"){
        e.preventDefault();
        const next = tbody.querySelectorAll('input[data-role="qty"]')[idx+1];
        if(next) next.focus();
      }
    });

    createAutocomplete(nameInput);

    nameInput.addEventListener("change", ()=>{
      const val = normalizeText(nameInput.value);
      const match = bestMatchVocab(val);
      r.nameStd = match.std || val;
      r.ok = !!match.ok;
      nameInput.value = r.nameStd;
      saveLS();
      renderClientTable(id);
      rebuildPricesToday();
      rebuildGlobal();
      renderProvidersPanels();
      rebuildRepartoSelector();
    });

    fixBtn.onclick = ()=>{
      const n = normalizeText(nameInput.value);
      if(n && !STATE.vocabSet.has(n)){
        STATE.vocab.push(n);
        STATE.vocab = Array.from(new Set(STATE.vocab));
        STATE.vocabSet = new Set(STATE.vocab);
        renderVocab();
      }
      r.nameStd = n;
      r.ok = true;
      saveLS();
      renderClientTable(id);
      rebuildGlobal();
      renderProvidersPanels();
      rebuildPricesToday();
      rebuildRepartoSelector();
    };

    delBtn.onclick = ()=>{
      if(!confirm("Â¿Eliminar lÃ­nea?")) return;
      rows.splice(idx,1);
      saveLS();
      renderClientTable(id);
      rebuildGlobal();
      renderProvidersPanels();
      rebuildPricesToday();
      rebuildRepartoSelector();
    };

    tbody.appendChild(tr);
  });

  wrap.innerHTML = "";
  wrap.appendChild(table);
}

function clienteTXT(id){
  const c = STATE.clients.find(x=>x.id===id);
  if(!c) return "";
  const rows = c.rows || [];
  return rows.filter(r=>r.nameStd && (r.qty||0)>0).map(r=>`${fmtQty(r.qty)} ${r.nameStd}`).join("\n").trim();
}
function exportarClienteTXT(id){
  const c = STATE.clients.find(x=>x.id===id);
  if(!c) return;
  const txt = clienteTXT(id);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  downloadTextFile(`${c.name}.txt`, txt);
}
function enviarClienteWhatsApp(id){
  const c = STATE.clients.find(x=>x.id===id);
  if(!c) return;
  const txt = clienteTXT(id);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  openWhatsApp(`*${c.name}*\n\n${txt}`);
}

/* ===========================
  GLOBAL: merge tiendas + clientes
=========================== */
function rebuildGlobal(){
  const rows = [];

  // tiendas
  (STATE.stores.sp.rows||[]).forEach(r=>{
    rows.push({
      id: uid("g"),
      srcType: "store",
      srcId: "sp",
      srcName: "SAN PABLO",
      qty: r.qty,
      nameRaw: r.nameRaw,
      nameStd: r.nameStd,
      ok: r.ok,
      provider: r.provider || "",
      price: (STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
    });
  });
  (STATE.stores.sl.rows||[]).forEach(r=>{
    rows.push({
      id: uid("g"),
      srcType: "store",
      srcId: "sl",
      srcName: "SAN LESMES",
      qty: r.qty,
      nameRaw: r.nameRaw,
      nameStd: r.nameStd,
      ok: r.ok,
      provider: r.provider || "",
      price: (STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
    });
  });
  (STATE.stores.st.rows||[]).forEach(r=>{
    rows.push({
      id: uid("g"),
      srcType: "store",
      srcId: "st",
      srcName: "SANTIAGO",
      qty: r.qty,
      nameRaw: r.nameRaw,
      nameStd: r.nameStd,
      ok: r.ok,
      provider: r.provider || "",
      price: (STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
    });
  });

  // clientes
  (STATE.clients||[]).forEach(c=>{
    (c.rows||[]).forEach(r=>{
      rows.push({
        id: uid("g"),
        srcType: "client",
        srcId: c.id,
        srcName: c.name,
        qty: r.qty,
        nameRaw: r.nameRaw,
        nameStd: r.nameStd,
        ok: r.ok,
        provider: "",
        price: (STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
      });
    });
  });

  // guarda y render
  STATE.globalRows = rows;
  saveLS();
  renderGlobal();
  renderProvidersPanels();
  rebuildPricesToday();
}

function renderGlobal(){
  const wrap = el("globalWrap");
  if(!wrap) return;

  const rows = STATE.globalRows || [];
  if(!rows.length){
    wrap.innerHTML = `<div class="card"><div class="h">GLOBAL</div><div class="hint">AÃºn no hay filas. Pega listas en tiendas/clientes y pulsa â€œEstandarizarâ€.</div></div>`;
    return;
  }

  // filtros
  const q = (el("globalSearch")?.value || "").trim();
  const qn = normalizeText(q);

  const provSel = el("globalProviderFilter")?.value || "ALL";
  const srcSel  = el("globalSourceFilter")?.value || "ALL";

  let filtered = rows.slice();
  if(qn){
    filtered = filtered.filter(r=> normalizeText(r.nameStd).includes(qn) || normalizeText(r.srcName).includes(qn));
  }
  if(provSel!=="ALL"){
    filtered = filtered.filter(r=> (r.provider||"")===provSel);
  }
  if(srcSel!=="ALL"){
    filtered = filtered.filter(r=> r.srcType===srcSel);
  }

  // header panel
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <div class="row" style="gap:10px;align-items:flex-start">
      <div style="flex:1">
        <div class="h">GLOBAL</div>
        <div class="hint">AquÃ­ asignas proveedor y ves quÃ© lÃ­neas tienen precio. (Precios vienen de tu mÃ³dulo /ponerprecios/)</div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn muted" onclick="rebuildGlobal()">ğŸ”„ Rebuild</button>
        <button class="btn muted" onclick="exportGlobalTXT()">TXT</button>
        <button class="btn muted" onclick="sendGlobalWA()">WA</button>
      </div>
    </div>

    <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
      <input id="globalSearch" class="price-input" style="flex:1;min-width:240px" placeholder="Buscar producto / destino..." value="${escapeHtml(el('globalSearch')?.value||'')}">
      <select id="globalProviderFilter" class="price-input" style="min-width:180px">
        <option value="ALL">Todos los proveedores</option>
        ${STATE.providers.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("")}
      </select>
      <select id="globalSourceFilter" class="price-input" style="min-width:170px">
        <option value="ALL">Todas las fuentes</option>
        <option value="store">Solo tiendas</option>
        <option value="client">Solo clientes</option>
      </select>
    </div>

    <div style="margin-top:12px" id="globalTableWrap"></div>
  `;

  wrap.innerHTML = "";
  wrap.appendChild(card);

  // set selects chosen
  const provEl = el("globalProviderFilter");
  if(provEl) provEl.value = provSel;
  const srcEl = el("globalSourceFilter");
  if(srcEl) srcEl.value = srcSel;

  // events
  el("globalSearch").addEventListener("input", ()=>renderGlobal());
  el("globalProviderFilter").addEventListener("change", ()=>renderGlobal());
  el("globalSourceFilter").addEventListener("change", ()=>renderGlobal());

  const tableWrap = el("globalTableWrap");
  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:130px">Destino</th>
        <th style="width:90px">Cant.</th>
        <th>Producto</th>
        <th style="width:190px">Proveedor</th>
        <th style="width:140px">Precio</th>
        <th style="width:110px;text-align:right">Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  filtered.forEach((r,idx)=>{
    const tr = document.createElement("tr");
    const p = (STATE.prices[r.nameStd]!=null) ? STATE.prices[r.nameStd] : null;

    tr.innerHTML = `
      <td><span class="pill">${escapeHtml(r.srcName)}</span></td>
      <td>${escapeHtml(fmtQty(r.qty))}</td>
      <td>
        <div style="font-weight:700">${escapeHtml(r.nameStd)}</div>
        <div class="hint">${escapeHtml(normalizeText(r.nameRaw||""))}</div>
      </td>
      <td>
        <select class="price-input" data-role="prov">
          <option value="">â€”</option>
          ${STATE.providers.map(pp=>`<option value="${escapeHtml(pp)}">${escapeHtml(pp)}</option>`).join("")}
        </select>
      </td>
      <td>
        <span class="pill">${p!=null ? fmtPrice(p) : "â€”"}</span>
      </td>
      <td style="text-align:right">
        <button class="btn muted small" data-role="toActive">â‡¢</button>
        <button class="btn muted small" data-role="del">ğŸ—‘</button>
      </td>
    `;

    const prov = tr.querySelector('[data-role="prov"]');
    prov.value = r.provider || "";

    prov.addEventListener("change", ()=>{
      r.provider = prov.value;
      // reflejar tambiÃ©n en rows fuente si es tienda
      if(r.srcType==="store"){
        const sk = r.srcId;
        const storeRows = STATE.stores[sk]?.rows || [];
        const hit = storeRows.find(x=>x.nameStd===r.nameStd && Math.abs((x.qty||0)-(r.qty||0))<1e-9);
        if(hit) hit.provider = r.provider;
      }
      saveLS();
      renderProvidersPanels();
    });

    tr.querySelector('[data-role="toActive"]').onclick = ()=>{
      // manda proveedor a ACTIVE
      r.provider = STATE.activeProvider;
      prov.value = r.provider;
      saveLS();
      renderProvidersPanels();
    };

    tr.querySelector('[data-role="del"]').onclick = ()=>{
      if(!confirm("Â¿Eliminar lÃ­nea de GLOBAL? (no borra de tienda/cliente, solo de GLOBAL actual)")) return;
      const i = STATE.globalRows.findIndex(x=>x.id===r.id);
      if(i>=0) STATE.globalRows.splice(i,1);
      saveLS();
      renderGlobal();
      renderProvidersPanels();
      rebuildPricesToday();
    };

    tbody.appendChild(tr);
  });

  tableWrap.innerHTML = "";
  tableWrap.appendChild(table);
}

function exportGlobalTXT(){
  const rows = STATE.globalRows || [];
  if(!rows.length){ alert("No hay lÃ­neas."); return; }
  const txt = rows.map(r=>`${r.srcName}: ${fmtQty(r.qty)} ${r.nameStd}${r.provider?(" ["+r.provider+"]"):""}`).join("\n");
  downloadTextFile("GLOBAL.txt", txt);
}
function sendGlobalWA(){
  const rows = STATE.globalRows || [];
  if(!rows.length){ alert("No hay lÃ­neas."); return; }
  const txt = rows.map(r=>`${r.srcName}: ${fmtQty(r.qty)} ${r.nameStd}${r.provider?(" ["+r.provider+"]"):""}`).join("\n");
  openWhatsApp(`*GLOBAL*\n\n${txt}`);
}

/* ===========================
  PROVEEDORES + PRECIOS (NUMÃ‰RICO EN LISTAS âœ…)
  - Panel por proveedor
  - Genera pedido TXT/WA
  - Genera "PRECIOS HOY" editable con input numÃ©rico
=========================== */
function renderProvidersPanels(){
  const wrap = el("providersWrap");
  if(!wrap) return;

  wrap.innerHTML = "";

  const header = document.createElement("div");
  header.className = "card";
  header.innerHTML = `
    <div class="row" style="align-items:flex-start">
      <div style="flex:1">
        <div class="h">Proveedores</div>
        <div class="hint">Asigna lÃ­neas desde GLOBAL. AquÃ­ generas pedidos por proveedor y editas precios con input numÃ©rico (rÃ¡pido en mÃ³vil).</div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <select id="activeProviderSel" class="price-input" style="min-width:220px">
          ${STATE.providers.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("")}
        </select>
        <button class="btn muted" onclick="rebuildGlobal()">ğŸ”„ Rebuild</button>
        <a class="btn muted" href="${URL_PRECIOS}" target="_blank" rel="noopener">ğŸ”— Abrir PRECIOS</a>
        <a class="btn muted" href="${URL_REPARTO}" target="_blank" rel="noopener">ğŸ”— Abrir REPARTO</a>
      </div>
    </div>

    <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" onclick="exportAllStoresPriceGrids()">ğŸ“„ PDF precios por tienda</button>
      <button class="btn muted" onclick="sendAllStoresPriceWA()">ğŸ“² WA precios por tienda</button>
      <button class="btn muted" onclick="exportAllStoresPriceTXT()">TXT precios por tienda</button>
    </div>
  `;
  wrap.appendChild(header);

  const sel = el("activeProviderSel");
  if(sel){
    sel.value = STATE.activeProvider || "ESMO";
    sel.addEventListener("change", ()=>{
      STATE.activeProvider = sel.value;
      saveLS();
      renderProvidersPanels();
      rebuildPricesToday();
    });
  }

  // panel "PRECIOS HOY" (solo productos que aparecen en listas hoy)
  const priceCard = document.createElement("div");
  priceCard.className = "card";
  priceCard.innerHTML = `
    <div class="row" style="align-items:flex-start">
      <div style="flex:1">
        <div class="h">Precios (hoy)</div>
        <div class="hint">Solo aparecen productos presentes hoy en tiendas/clientes. <b>Input numÃ©rico</b> + Enter salta al siguiente.</div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn muted" onclick="exportPricesChangedPDF()">ğŸ“„ PDF (solo precios cambiados)</button>
        <button class="btn muted" onclick="sendPricesChangedWA()">ğŸ“² WA (solo precios cambiados)</button>
        <button class="btn muted" onclick="exportPricesChangedTXT()">TXT (solo precios cambiados)</button>
      </div>
    </div>
    <div style="margin-top:12px" id="pricesTodayWrap"></div>
  `;
  wrap.appendChild(priceCard);

  // paneles por proveedor
  STATE.providers.forEach(p=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <div class="h">${escapeHtml(p)}</div>
          <div class="hint">Pedido: suma por producto (si hay repetidos). Exporta por TXT/WA.</div>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn muted small" onclick="exportProviderTXT('${escapeHtml(p)}')">TXT</button>
          <button class="btn muted small" onclick="sendProviderWA('${escapeHtml(p)}')">WA</button>
        </div>
      </div>
      <div style="margin-top:10px" id="prov_${escapeHtml(p)}_wrap"></div>
    `;
    wrap.appendChild(card);
    renderProviderTable(p);
  });

  rebuildPricesToday();
}

function providerAggregated(providerName){
  const rows = (STATE.globalRows||[]).filter(r=>(r.provider||"")===providerName);
  const map = new Map(); // name -> qty
  rows.forEach(r=>{
    const name = r.nameStd;
    const qty = +r.qty||0;
    if(!name || qty<=0) return;
    map.set(name, (map.get(name)||0)+qty);
  });
  const list = Array.from(map.entries()).map(([name,qty])=>({name,qty}));
  list.sort((a,b)=>a.name.localeCompare(b.name));
  return list;
}

function renderProviderTable(providerName){
  const wrap = el("prov_"+providerName+"_wrap");
  if(!wrap) return;
  const list = providerAggregated(providerName);

  if(!list.length){
    wrap.innerHTML = `<div class="hint">Sin lÃ­neas asignadas.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:90px">Cant.</th>
        <th>Producto</th>
        <th style="width:140px">Precio</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  list.forEach(item=>{
    const p = (STATE.prices[item.name]!=null) ? STATE.prices[item.name] : null;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(fmtQty(item.qty))}</td>
      <td style="font-weight:700">${escapeHtml(item.name)}</td>
      <td><span class="pill">${p!=null ? fmtPrice(p) : "â€”"}</span></td>
    `;
    tbody.appendChild(tr);
  });

  wrap.innerHTML = "";
  wrap.appendChild(table);
}

function providerTXT(providerName){
  const list = providerAggregated(providerName);
  if(!list.length) return "";
  return list.map(x=>`${fmtQty(x.qty)} ${x.name}`).join("\n").trim();
}
function exportProviderTXT(providerName){
  const txt = providerTXT(providerName);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  downloadTextFile(`${providerName}.txt`, txt);
}
function sendProviderWA(providerName){
  const txt = providerTXT(providerName);
  if(!txt){ alert("No hay lÃ­neas."); return; }
  openWhatsApp(`*${providerName}*\n\n${txt}`);
}

/* ===========================
  PRECIOS (HOY) â€” INPUT NUMÃ‰RICO EN LISTAS âœ…
=========================== */
function productsTodaySet(){
  const set = new Set();
  (STATE.globalRows||[]).forEach(r=>{
    if(r.nameStd) set.add(r.nameStd);
  });
  // si global vacÃ­o, cae a tiendas+clientes
  if(set.size===0){
    ["sp","sl","st"].forEach(k=>{
      (STATE.stores[k].rows||[]).forEach(r=>{ if(r.nameStd) set.add(r.nameStd); });
    });
    (STATE.clients||[]).forEach(c=>{
      (c.rows||[]).forEach(r=>{ if(r.nameStd) set.add(r.nameStd); });
    });
  }
  return set;
}

function ensurePriceHist(product, value){
  if(!product) return;
  if(!STATE.priceHist[product]) STATE.priceHist[product] = [];
  STATE.priceHist[product].push({t: now(), v: value});
  // limita historial
  if(STATE.priceHist[product].length > 30){
    STATE.priceHist[product] = STATE.priceHist[product].slice(-30);
  }
}

function rebuildPricesToday(){
  const wrap = el("pricesTodayWrap");
  if(!wrap) return;

  const set = productsTodaySet();
  const list = Array.from(set).sort((a,b)=>a.localeCompare(b));

  if(!list.length){
    wrap.innerHTML = `<div class="hint">No hay productos â€œhoyâ€.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th>Producto</th>
        <th style="width:190px">Precio</th>
        <th style="width:220px">Historial</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  list.forEach((name,idx)=>{
    const current = (STATE.prices[name]!=null) ? STATE.prices[name] : null;
    const histArr = (STATE.priceHist[name]||[]).slice(-3);
    const histTxt = histArr.map(h=>fmtPrice(h.v)).filter(Boolean).join(" Â· ") || "â€”";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:700">${escapeHtml(name)}</td>
      <td>
        <input
          class="price-input price-number"
          data-role="price"
          data-name="${escapeHtml(name)}"
          type="number"
          inputmode="decimal"
          step="0.01"
          placeholder="0.00"
          value="${current!=null ? String((Math.round(current*100)/100)).replace(",",".") : ""}"
        >
      </td>
      <td class="hint">${escapeHtml(histTxt)}</td>
    `;

    const inp = tr.querySelector('input[data-role="price"]');

    // Enter = siguiente input
    inp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const next = tbody.querySelectorAll('input[data-role="price"]')[idx+1];
        if(next) next.focus();
      }
      if(e.key==="Escape"){
        e.preventDefault();
        inp.blur();
      }
    });

    // change/save
    inp.addEventListener("change", ()=>{
      const product = inp.getAttribute("data-name");
      const v = parsePrice(inp.value);
      if(v==null){
        // vacÃ­o => no tocar (o borrar si quieres)
        inp.value = "";
        // NO borramos precio automÃ¡ticamente (por seguridad)
        saveLS();
        renderAllStoreTables();
        renderClients();
        renderGlobal();
        renderProvidersPanels(); // re-render para precios pills
        return;
      }
      const prev = STATE.prices[product];
      STATE.prices[product] = v;
      if(prev !== v) ensurePriceHist(product, v);
      saveLS();
      // refrescar pills de precio
      renderAllStoreTables();
      renderClients();
      renderGlobal();
      renderProviderTable(STATE.activeProvider);
    });

    tbody.appendChild(tr);
  });

  wrap.innerHTML = "";
  wrap.appendChild(table);
}

/* ===========================
  EXPORT: Precios cambiados (solo los que han cambiado hoy)
  Regla: si no hay precio => ignorar
  â€œCambiadoâ€ = el Ãºltimo valor != anterior (historial)
=========================== */
function pricesChangedList(){
  const set = productsTodaySet();
  const list = [];
  Array.from(set).forEach(name=>{
    const p = STATE.prices[name];
    if(p==null || !isFinite(p)) return;
    // detecta "cambio" por historial: si hay al menos 2 y el Ãºltimo != penÃºltimo
    const h = (STATE.priceHist[name]||[]);
    if(h.length>=2){
      const a = h[h.length-1]?.v;
      const b = h[h.length-2]?.v;
      if(isFinite(a) && isFinite(b) && Math.abs(a-b) > 1e-9){
        list.push({name, price:p});
        return;
      }
    }
    // si no hay historial, pero hay precio => NO lo consideramos cambiado (mantiene tu regla)
  });
  list.sort((a,b)=>a.name.localeCompare(b.name));
  return list;
}

function exportPricesChangedTXT(){
  const list = pricesChangedList();
  if(!list.length){ alert("No hay precios cambiados."); return; }
  const txt = list.map(x=>`${x.name}\t${fmtPrice(x.price)}`).join("\n");
  downloadTextFile("PRECIOS_CAMBIADOS.txt", txt);
}
function sendPricesChangedWA(){
  const list = pricesChangedList();
  if(!list.length){ alert("No hay precios cambiados."); return; }
  const body = list.map(x=>`${x.name}  ${fmtPrice(x.price)}`).join("\n");
  openWhatsApp(`*PRECIOS CAMBIADOS*\n\n${body}`);
}
function exportPricesChangedPDF(){
  const list = pricesChangedList();
  if(!list.length){ alert("No hay precios cambiados."); return; }
  const html = buildPriceGridHTML("PRECIOS CAMBIADOS", list);
  openPrintWindow(html);
}

/* ===========================
  CUADRÃCULAS TIENDA PRECIOS (todos de golpe)
=========================== */
function exportAllStoresPriceGrids(){
  exportarTiendaPreciosPDF("sp");
  exportarTiendaPreciosPDF("sl");
  exportarTiendaPreciosPDF("st");
}
function sendAllStoresPriceWA(){
  enviarTiendaPreciosWhatsApp("sp");
  enviarTiendaPreciosWhatsApp("sl");
  enviarTiendaPreciosWhatsApp("st");
}
function exportAllStoresPriceTXT(){
  exportarTiendaPreciosTXT("sp");
  exportarTiendaPreciosTXT("sl");
  exportarTiendaPreciosTXT("st");
}

/* ===========================
  REPARTO SELECTOR (se usa en PARTE 4)
=========================== */
function rebuildRepartoSelector(){
  const sel = el("repartoDestinoSel");
  if(!sel) return;

  const opts = [];
  opts.push({v:"STORE_sp", t:"Tienda Â· San Pablo"});
  opts.push({v:"STORE_sl", t:"Tienda Â· San Lesmes"});
  opts.push({v:"STORE_st", t:"Tienda Â· Santiago"});
  (STATE.clients||[]).forEach(c=>{
    opts.push({v:"CLI_"+c.id, t:"Cliente Â· "+c.name});
  });

  sel.innerHTML = opts.map(o=>`<option value="${escapeHtml(o.v)}">${escapeHtml(o.t)}</option>`).join("");
}

/* ===========================
  INIT: cargar + render
=========================== */
function initApp(){
  // CSS extra para autocomplete si no existe
  if(!document.getElementById("ac-style")){
    const st = document.createElement("style");
    st.id = "ac-style";
    st.textContent = `
      .ac-box{position:absolute;z-index:9999;background:var(--bg,#fff);border:1px solid rgba(0,0,0,.12);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden}
      .ac-item{padding:10px 12px;cursor:pointer;font-family:Poppins,Arial,sans-serif;font-size:13px}
      .ac-item:hover{background:rgba(0,0,0,.06)}
      .qty-tools{display:flex;gap:6px;align-items:center}
      .qty-btn{border:1px solid rgba(0,0,0,.15);background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
      .price-number{width:100%}
    `;
    document.head.appendChild(st);
  }

  loadLS();
  applyTheme();

  // link botones si existen
  const th = el("toggleThemeBtn"); if(th) th.onclick = toggleTheme;
  const clean = el("cleanDayBtn"); if(clean) clean.onclick = limpiarDia;
  const reset = el("resetBtn"); if(reset) reset.onclick = resetAll;

  // tabs
  const b1 = el("btn-dic"); if(b1) b1.onclick = ()=>showTab("dic");
  const b2 = el("btn-tiendas"); if(b2) b2.onclick = ()=>showTab("tiendas");
  const b3 = el("btn-global"); if(b3) b3.onclick = ()=>showTab("global");
  const b4 = el("btn-proveedores"); if(b4) b4.onclick = ()=>showTab("proveedores");

  // fab
  const fab = el("fab"); if(fab) fab.onclick = ()=>toggleFabMenu();
  document.addEventListener("click",(e)=>{
    const m = el("fabMenu");
    if(!m) return;
    if(m.classList.contains("show")){
      const isFab = e.target.closest("#fab") || e.target.closest("#fabMenu");
      if(!isFab) toggleFabMenu(true);
    }
  });

  // vocab
  renderVocab();

  // tiendas
  ["sp","sl","st"].forEach(k=>{
    const ta = el("in_"+k);
    if(ta && !ta.value && STATE.stores[k].raw) ta.value = STATE.stores[k].raw;
    renderStoreTable(k);
  });

  // clientes
  renderClients();

  // global
  if((STATE.globalRows||[]).length===0){
    rebuildGlobal();
  }else{
    renderGlobal();
  }

  // proveedores
  renderProvidersPanels();

  // reparto selector (si existe)
  rebuildRepartoSelector();
}

// auto init
document.addEventListener("DOMContentLoaded", initApp);

</script>
<!-- ===========================
PARTE 4/4 â€” ARSLAN LISTAS v3.4 (REPARTO + PDF CUADRÃCULAS + PRECIOS POR TIENDA + WHATSAPP + UTILIDADES)
âš ï¸ Pegar justo despuÃ©s de la PARTE 3
=========================== -->

<script>
/* ===========================
  PDF/PRINT helpers (cuadrÃ­cula)
=========================== */
function openPrintWindow(html){
  const w = window.open("", "_blank");
  if(!w){ alert("Bloqueado por el navegador. Permite popups para imprimir."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  // algunos navegadores necesitan delay mÃ­nimo
  setTimeout(()=>{ try{ w.print(); }catch(e){} }, 250);
}

function buildPriceGridHTML(title, items){
  // items: [{name, price}]
  const safeTitle = escapeHtml(title||"");
  const rows = (items||[]).map(x=>{
    return `
      <div class="cell">
        <div class="name">${escapeHtml(x.name||"")}</div>
        <div class="price">${x.price!=null ? escapeHtml(fmtPrice(x.price)) : ""}</div>
      </div>
    `;
  }).join("");

  const nowStr = new Date().toLocaleString("es-ES");

  return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safeTitle}</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --b:#e5e7eb; --bg:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;color:var(--ink);background:var(--bg)}
  .page{padding:18px 18px 24px}
  .top{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;border-bottom:2px solid var(--b);padding-bottom:10px;margin-bottom:14px}
  .ttl{font-size:20px;font-weight:800;letter-spacing:.2px}
  .meta{font-size:12px;color:var(--muted);text-align:right}
  .grid{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
  }
  .cell{
    border:1px solid var(--b);
    border-radius:14px;
    padding:12px 12px 10px;
    min-height:72px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .name{
    font-weight:800;
    font-size:13px;
    line-height:1.15;
    text-transform:uppercase;
  }
  .price{
    margin-top:10px;
    font-weight:900;
    font-size:18px;
    color:var(--kiwi);
    letter-spacing:.3px;
  }
  @media print{
    .page{padding:10mm}
    .grid{gap:8px}
    .cell{border-radius:12px}
  }
  @page{size:A4; margin:10mm;}
</style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div class="ttl">${safeTitle}</div>
      <div class="meta">Generado: ${escapeHtml(nowStr)}<br/>ARSLAN LISTAS v3.4</div>
    </div>
    <div class="grid">
      ${rows}
    </div>
  </div>
</body>
</html>
  `;
}

/* ===========================
  PRECIOS POR TIENDA: SOLO LOS QUE LE AFECTAN âœ…
  - "Afectan" = producto presente en esa tienda hoy y con precio definido
=========================== */
function tiendaProductsSet(storeKey){
  const set = new Set();
  (STATE.stores[storeKey]?.rows||[]).forEach(r=>{
    if(r?.nameStd) set.add(r.nameStd);
  });
  return set;
}

function tiendaPriceItems(storeKey){
  const set = tiendaProductsSet(storeKey);
  const items = [];
  Array.from(set).forEach(name=>{
    const p = STATE.prices[name];
    if(p==null || !isFinite(p)) return; // si no hay precio => ignorar
    items.push({name, price:p});
  });
  items.sort((a,b)=>a.name.localeCompare(b.name));
  return items;
}

function tiendaLabel(storeKey){
  if(storeKey==="sp") return "SAN PABLO";
  if(storeKey==="sl") return "SAN LESMES";
  if(storeKey==="st") return "SANTIAGO";
  return storeKey;
}

function exportarTiendaPreciosPDF(storeKey){
  const items = tiendaPriceItems(storeKey);
  if(!items.length){
    alert(`No hay precios para ${tiendaLabel(storeKey)} (o no hay productos con precio).`);
    return;
  }
  const html = buildPriceGridHTML(`PRECIOS Â· ${tiendaLabel(storeKey)}`, items);
  openPrintWindow(html);
}

function exportarTiendaPreciosTXT(storeKey){
  const items = tiendaPriceItems(storeKey);
  if(!items.length){
    alert(`No hay precios para ${tiendaLabel(storeKey)}.`);
    return;
  }
  const txt = items.map(x=>`${x.name}\t${fmtPrice(x.price)}`).join("\n");
  downloadTextFile(`PRECIOS_${tiendaLabel(storeKey)}.txt`, txt);
}

function enviarTiendaPreciosWhatsApp(storeKey){
  const items = tiendaPriceItems(storeKey);
  if(!items.length){
    alert(`No hay precios para ${tiendaLabel(storeKey)}.`);
    return;
  }
  const body = items.map(x=>`${x.name}  ${fmtPrice(x.price)}`).join("\n");
  openWhatsApp(`*PRECIOS Â· ${tiendaLabel(storeKey)}*\n\n${body}`);
}

/* ===========================
  PRECIOS POR CLIENTE (si quieres):
  - solo productos del cliente con precio
=========================== */
function clientPriceItems(clientId){
  const c = (STATE.clients||[]).find(x=>x.id===clientId);
  if(!c) return [];
  const set = new Set();
  (c.rows||[]).forEach(r=>{ if(r?.nameStd) set.add(r.nameStd); });
  const items = [];
  Array.from(set).forEach(name=>{
    const p = STATE.prices[name];
    if(p==null || !isFinite(p)) return;
    items.push({name, price:p});
  });
  items.sort((a,b)=>a.name.localeCompare(b.name));
  return items;
}
function exportarClientePreciosPDF(clientId){
  const c = (STATE.clients||[]).find(x=>x.id===clientId);
  if(!c) return;
  const items = clientPriceItems(clientId);
  if(!items.length){ alert(`No hay precios para ${c.name}.`); return; }
  openPrintWindow(buildPriceGridHTML(`PRECIOS Â· ${c.name}`, items));
}
function enviarClientePreciosWA(clientId){
  const c = (STATE.clients||[]).find(x=>x.id===clientId);
  if(!c) return;
  const items = clientPriceItems(clientId);
  if(!items.length){ alert(`No hay precios para ${c.name}.`); return; }
  const body = items.map(x=>`${x.name}  ${fmtPrice(x.price)}`).join("\n");
  openWhatsApp(`*PRECIOS Â· ${c.name}*\n\n${body}`);
}

/* ===========================
  REPARTO: genera link a tu app externa (reparto/)
  - Envia lista destino (tienda o cliente)
  - Puede incluir precios (opcional)
=========================== */
function repartoGetDestino(){
  const sel = el("repartoDestinoSel");
  return sel ? sel.value : "STORE_sp";
}

function repartoDataForDestino(destKey){
  // devuelve {title, lines:[{qty,name,price?}], txt}
  let title = "";
  let rows = [];

  if(destKey.startsWith("STORE_")){
    const k = destKey.replace("STORE_","");
    title = "REPARTO Â· " + tiendaLabel(k);
    rows = (STATE.stores[k]?.rows||[]).map(r=>({
      qty:r.qty, name:r.nameStd, price:(STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
    })).filter(x=>x.name && (x.qty||0)>0);
  }else if(destKey.startsWith("CLI_")){
    const id = destKey.replace("CLI_","");
    const c = (STATE.clients||[]).find(x=>x.id===id);
    title = "REPARTO Â· " + (c?c.name:"CLIENTE");
    rows = (c?.rows||[]).map(r=>({
      qty:r.qty, name:r.nameStd, price:(STATE.prices[r.nameStd]!=null ? STATE.prices[r.nameStd] : null)
    })).filter(x=>x.name && (x.qty||0)>0);
  }else{
    title = "REPARTO";
    rows = [];
  }

  // txt base (sin precios)
  const txt = rows.map(x=>`${fmtQty(x.qty)} ${x.name}`).join("\n").trim();
  return {title, rows, txt};
}

function openRepartoLink(){
  // Pasa datos comprimidos por URL (LZ-String) si existe
  const dest = repartoGetDestino();
  const data = repartoDataForDestino(dest);
  if(!data.rows.length){ alert("No hay lÃ­neas para ese destino."); return; }

  const payload = {
    title: data.title,
    createdAt: now(),
    destino: dest,
    rows: data.rows
  };

  // si estÃ¡ LZString disponible (en tu index ya estaba)
  let url = URL_REPARTO;
  try{
    if(typeof LZString !== "undefined"){
      const json = JSON.stringify(payload);
      const packed = LZString.compressToEncodedURIComponent(json);
      url = URL_REPARTO + (URL_REPARTO.includes("?") ? "&" : "?") + "p=" + packed;
    }else{
      // fallback sin compresiÃ³n (puede ser largo)
      const json = encodeURIComponent(JSON.stringify(payload));
      url = URL_REPARTO + (URL_REPARTO.includes("?") ? "&" : "?") + "json=" + json;
    }
  }catch(e){
    // fallback simple
    url = URL_REPARTO;
  }

  window.open(url, "_blank", "noopener");
}

function enviarRepartoWhatsApp(){
  const dest = repartoGetDestino();
  const data = repartoDataForDestino(dest);
  if(!data.rows.length){ alert("No hay lÃ­neas para ese destino."); return; }

  // WA: si quieres incluir precios al lado (solo si existe)
  const includePrices = !!el("repartoIncludePrices")?.checked;

  const body = data.rows.map(x=>{
    if(includePrices && x.price!=null){
      return `${fmtQty(x.qty)} ${x.name}  (${fmtPrice(x.price)})`;
    }
    return `${fmtQty(x.qty)} ${x.name}`;
  }).join("\n");

  openWhatsApp(`*${data.title}*\n\n${body}`);
}

function exportarRepartoTXT(){
  const dest = repartoGetDestino();
  const data = repartoDataForDestino(dest);
  if(!data.rows.length){ alert("No hay lÃ­neas para ese destino."); return; }
  downloadTextFile(`${data.title.replaceAll(" Â· ","_")}.txt`, data.txt);
}

/* ===========================
  UI Hook: REPARTO PANEL (si existe en HTML de PARTES anteriores)
=========================== */
function hookRepartoPanel(){
  const btnOpen = el("repartoOpenBtn");
  const btnWA = el("repartoWABtn");
  const btnTXT = el("repartoTXTBtn");

  if(btnOpen) btnOpen.onclick = openRepartoLink;
  if(btnWA) btnWA.onclick = enviarRepartoWhatsApp;
  if(btnTXT) btnTXT.onclick = exportarRepartoTXT;
}

/* ===========================
  Extra: refrescar todo (cuando cambian precios)
=========================== */
function renderAllStoreTables(){
  renderStoreTable("sp");
  renderStoreTable("sl");
  renderStoreTable("st");
}

/* ===========================
  Patch init: engancha reparto
=========================== */
document.addEventListener("DOMContentLoaded", ()=>{
  hookRepartoPanel();
  rebuildRepartoSelector();
});

</script>

<!-- ===========================
  (Opcional) Si tu HTML NO tenÃ­a panel de REPARTO en tabs,
  pega este bloque en el TAB de proveedores o donde quieras.
  Si ya existe, IGNORA esto.
=========================== -->
<!--
<div class="card" style="margin-top:12px">
  <div class="row" style="align-items:flex-start">
    <div style="flex:1">
      <div class="h">Reparto</div>
      <div class="hint">Genera link para tu app /reparto/ con este destino.</div>
    </div>
    <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn muted" id="repartoTXTBtn">TXT</button>
      <button class="btn muted" id="repartoWABtn">WA</button>
      <button class="btn" id="repartoOpenBtn">Abrir Reparto</button>
    </div>
  </div>

  <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
    <select id="repartoDestinoSel" class="price-input" style="min-width:260px"></select>
    <label class="hint" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="repartoIncludePrices"> Incluir precios (si hay)
    </label>
  </div>
</div>
-->
